<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WSU Review Portal</title>
<style>
:root {
  --primary: #981e32;
  --primary-dark: #7a1828;
  --secondary: #5f6b6d;
  --accent: #c69214;
  --bg: #f5f5f5;
  --card-bg: #fff;
  --text: #2d2d2d;
  --text-light: #6b7280;
  --border: #e5e7eb;
  --green: #059669;
  --red: #dc2626;
  --blue: #2563eb;
  --table-head-bg: #f9fafb;
  --table-hover: #f9fafb;
  --info-bg: #f0f9ff;
  --info-border: #bae6fd;
  --info-text: #0c4a6e;
}
html.dark {
  --bg: #111827; --card-bg: #1f2937; --text: #e5e7eb; --text-light: #9ca3af;
  --border: #374151; --green: #34d399; --red: #f87171;
  --table-head-bg: #1a2332; --table-hover: #253347;
  --info-bg: #1e293b; --info-border: #334155; --info-text: #7dd3fc;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg); color: var(--text); min-height: 100vh;
}
/* Auth Gate */
#authGate {
  position: fixed; inset: 0; background: rgba(0,0,0,.55); z-index: 1000;
  display: flex; align-items: center; justify-content: center;
}
.auth-card {
  background: var(--card-bg); border-radius: 16px; padding: 2.5rem; width: 380px;
  box-shadow: 0 25px 50px rgba(0,0,0,.25); text-align: center;
}
.auth-card h2 { color: var(--primary); margin-bottom: .5rem; font-size: 1.4rem; }
.auth-card p { color: var(--text-light); margin-bottom: 1.5rem; font-size: .85rem; }
.auth-card input {
  width: 100%; padding: .75rem 1rem; border: 2px solid var(--border); border-radius: 8px;
  font-size: .95rem; background: var(--bg); color: var(--text); outline: none;
  margin-bottom: .75rem;
}
.auth-card input:focus { border-color: var(--primary); }
.auth-card button {
  width: 100%; padding: .75rem; border: none; border-radius: 8px;
  background: var(--primary); color: #fff; font-size: .95rem; font-weight: 600;
  cursor: pointer;
}
.auth-card button:hover { background: var(--primary-dark); }
.auth-error { color: var(--red); font-size: .8rem; margin-top: .5rem; display: none; }

/* Header */
header {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #fff; padding: 1rem 2rem;
  display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: .5rem;
}
.header-text h1 { font-size: 1.5rem; font-weight: 700; }
.header-text p { font-size: .8rem; opacity: .85; }
.header-actions { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
.header-actions a {
  color: rgba(255,255,255,.75); text-decoration: none; font-size: .78rem; padding: .3rem .6rem;
  border: 1px solid rgba(255,255,255,.25); border-radius: 6px;
}
.header-actions a:hover { background: rgba(255,255,255,.1); color: #fff; }

/* Dark Mode Toggle */
.dark-toggle { display: flex; align-items: center; gap: .5rem; }
.dark-toggle-label { font-size: .78rem; color: rgba(255,255,255,.8); }
.dark-toggle-switch {
  width: 40px; height: 22px; border-radius: 11px; border: none;
  background: rgba(255,255,255,.25); cursor: pointer; position: relative;
}
.dark-toggle-switch::after {
  content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px;
  border-radius: 50%; background: #fff; transition: transform .2s;
}
html.dark .dark-toggle-switch { background: var(--accent); }
html.dark .dark-toggle-switch::after { transform: translateX(18px); }

/* Container & Cards */
.container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
.card {
  background: var(--card-bg); border-radius: 12px; padding: 1.5rem;
  box-shadow: 0 1px 3px rgba(0,0,0,.1); margin-bottom: 1.5rem;
}
.card h2 { font-size: 1.1rem; color: var(--primary); margin-bottom: 1rem; }
html.dark .card h2 { color: var(--accent); }

/* Nav Tabs */
.nav-tabs {
  display: flex; gap: .5rem; margin-bottom: 1.5rem; flex-wrap: wrap;
  border-bottom: 2px solid var(--border); padding-bottom: .5rem;
}
.nav-tab {
  padding: .5rem 1rem; border: none; background: none; font-size: .85rem;
  color: var(--text-light); cursor: pointer; border-radius: 6px; font-weight: 500;
}
.nav-tab:hover { background: var(--table-hover); color: var(--text); }
.nav-tab.active { background: var(--primary); color: #fff; }
.section { display: none; }
.section.active { display: block; }

/* Info Box */
.info-box {
  background: var(--info-bg); border-left: 4px solid var(--info-border);
  padding: .75rem 1rem; border-radius: 0 8px 8px 0; margin-bottom: 1rem;
  font-size: .82rem; color: var(--info-text);
}

/* Forms */
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
.form-group { margin-bottom: 1rem; }
.form-group > label {
  display: block; font-size: .82rem; font-weight: 600; color: var(--secondary); margin-bottom: .4rem;
}
html.dark .form-group > label { color: var(--text-light); }
.form-group input[type="text"],
.form-group input[type="email"],
.form-group select {
  width: 100%; padding: .6rem .9rem; border: 2px solid var(--border); border-radius: 8px;
  font-size: .88rem; background: var(--card-bg); color: var(--text); outline: none;
}
.form-group input:focus, .form-group select:focus { border-color: var(--primary); }

/* Division Groups */
.div-quick-actions { margin-top: .5rem; display: flex; gap: .5rem; }
.div-count {
  display: inline-block; background: var(--primary); color: #fff; font-size: .7rem;
  padding: .1rem .45rem; border-radius: 10px; margin-left: .5rem; font-weight: 600;
  min-width: 1.4em; text-align: center;
}
.div-count.zero { background: var(--border); color: var(--text-light); }
html.dark .div-count.zero { background: #374151; }
.upload-message {
  font-size: .78rem; margin-top: .4rem; padding: .3rem .6rem; border-radius: 6px;
  display: none;
}
.upload-message.warn { display: block; background: #fffbeb; color: #92400e; }
.upload-message.error { display: block; background: #fef2f2; color: var(--red); }
html.dark .upload-message.warn { background: #78350f; color: #fbbf24; }
html.dark .upload-message.error { background: #7f1d1d; color: #f87171; }

/* Analysis results panel */
.analysis-panel { margin-top: 1.5rem; display: none; }
.analysis-panel.visible { display: block; }
.analysis-header { display: flex; align-items: center; gap: .5rem; margin-bottom: 1rem; }
.analysis-header h3 { margin: 0; color: var(--primary); }
html.dark .analysis-header h3 { color: var(--accent); }
.analysis-confidence {
  font-size: .7rem; padding: .2rem .5rem; border-radius: 10px; font-weight: 600;
}
.analysis-confidence.high { background: #ecfdf5; color: #059669; }
.analysis-confidence.medium { background: #fffbeb; color: #92400e; }
.analysis-confidence.low { background: #fef2f2; color: #dc2626; }
html.dark .analysis-confidence.high { background: #064e3b; color: #34d399; }
html.dark .analysis-confidence.medium { background: #78350f; color: #fbbf24; }
html.dark .analysis-confidence.low { background: #7f1d1d; color: #f87171; }
.analysis-summary {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: .75rem; margin-bottom: 1rem;
}
.analysis-stat {
  background: var(--info-bg); border: 1px solid var(--info-border);
  border-radius: 8px; padding: .6rem .8rem; text-align: center;
}
.analysis-stat .stat-value { font-size: 1.4rem; font-weight: 700; color: var(--primary); }
.analysis-stat .stat-label { font-size: .72rem; color: var(--text-light); }
.analysis-disciplines {
  border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-bottom: 1rem;
}
.analysis-disc-row {
  display: flex; align-items: center; padding: .6rem .8rem; gap: .75rem;
  border-bottom: 1px solid var(--border); transition: background .15s;
}
.analysis-disc-row:last-child { border-bottom: none; }
.analysis-disc-row:hover { background: var(--table-hover); }
.analysis-disc-row input[type="checkbox"] { width: 18px; height: 18px; flex-shrink: 0; }
.analysis-disc-name { font-weight: 600; flex: 1; }
.analysis-disc-pages {
  font-size: .75rem; color: var(--text-light); white-space: nowrap;
}
.analysis-disc-sheets {
  font-size: .7rem; color: var(--blue); max-width: 200px;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.analysis-disc-divs {
  font-size: .7rem; color: var(--text-light);
}
.confirm-btn {
  width: 100%; padding: .85rem; border: none; border-radius: 8px;
  background: var(--green); color: #fff; font-size: 1rem; font-weight: 600;
  cursor: pointer; transition: background .2s; margin-top: .5rem;
}
.confirm-btn:hover { background: #047857; }
.confirm-btn:disabled { opacity: .5; cursor: not-allowed; }
.confirm-btn.loading { display: flex; align-items: center; justify-content: center; gap: .5rem; }
.analysis-note {
  font-size: .78rem; color: var(--text-light); margin-top: .5rem; text-align: center;
}

/* Upload Zone */
.upload-zone {
  border: 2px dashed var(--border); border-radius: 10px; padding: 2rem;
  text-align: center; cursor: pointer; transition: all .2s;
}
.upload-zone:hover, .upload-zone.dragover {
  border-color: var(--primary); background: rgba(152,30,50,.03);
}
.upload-zone.has-file { border-color: var(--green); background: rgba(5,150,105,.03); }
.upload-icon { font-size: 2.5rem; margin-bottom: .5rem; }
.upload-text { font-size: .85rem; color: var(--text-light); }
.upload-filename { font-size: .85rem; font-weight: 600; color: var(--green); margin-top: .5rem; }

/* Submit Button */
.submit-btn {
  width: 100%; padding: .85rem; border: none; border-radius: 8px;
  background: var(--primary); color: #fff; font-size: 1rem; font-weight: 600;
  cursor: pointer; transition: background .2s; margin-top: .5rem;
}
.submit-btn:hover { background: var(--primary-dark); }
.submit-btn:disabled { opacity: .5; cursor: not-allowed; }
.submit-status { text-align: center; margin-top: .5rem; font-size: .85rem; min-height: 1.2em; }

/* Btn SM */
.btn-sm {
  padding: .3rem .7rem; border: 1px solid var(--border); border-radius: 6px;
  background: var(--card-bg); color: var(--text); font-size: .75rem; cursor: pointer;
}
.btn-sm:hover { background: var(--table-hover); }

/* Table */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: .82rem; }
th {
  text-align: left; padding: .6rem .75rem; background: var(--table-head-bg);
  border-bottom: 2px solid var(--border); font-weight: 600; color: var(--secondary);
  white-space: nowrap;
}
html.dark th { color: var(--text-light); }
td { padding: .6rem .75rem; border-bottom: 1px solid var(--border); vertical-align: top; }
tr:hover td { background: var(--table-hover); }

/* Job Status Badges */
.job-status {
  display: inline-block; padding: .2rem .6rem; border-radius: 10px;
  font-size: .72rem; font-weight: 600; white-space: nowrap;
}
.job-status.processing { background: #fffbeb; color: #92400e; }
.job-status.complete { background: #ecfdf5; color: #059669; }
.job-status.failed { background: #fef2f2; color: #dc2626; }
html.dark .job-status.processing { background: #78350f; color: #fbbf24; }
html.dark .job-status.complete { background: #064e3b; color: #34d399; }
html.dark .job-status.failed { background: #7f1d1d; color: #f87171; }
.job-status.analyzing { background: #eff6ff; color: #2563eb; }
.job-status.awaiting { background: #fefce8; color: #a16207; }
html.dark .job-status.analyzing { background: #1e3a5f; color: #60a5fa; }
html.dark .job-status.awaiting { background: #422006; color: #fbbf24; }
/* Email status icon */
.email-icon {
  display: inline-block; margin-left: .4rem; font-size: .72rem; cursor: default;
  vertical-align: middle;
}
.email-icon.sent { color: var(--green); }
.email-icon.error { color: var(--red); }
/* Progress bar tracker */
.tracker { position: relative; margin-top: .5rem; min-width: 320px; }
.tracker-bar {
  position: relative; height: 24px; background: var(--border); border-radius: 4px;
  overflow: hidden;
}
.tracker-fill {
  position: absolute; left: 0; top: 0; bottom: 0; background: var(--primary);
  border-radius: 4px 0 0 4px; transition: width .6s ease;
}
.tracker-fill.complete { border-radius: 4px; }
.tracker-fill.stalled {
  background: repeating-linear-gradient(
    -45deg, var(--primary), var(--primary) 8px, #7a1828 8px, #7a1828 16px
  );
}
.tracker-milestones { display: flex; justify-content: space-between; position: relative; margin-top: 2px; }
.tracker-ms {
  display: flex; flex-direction: column; align-items: center; position: relative;
}
.tracker-tick {
  width: 1px; height: 5px; background: var(--border); margin-bottom: 1px;
}
.tracker-tick.done { background: var(--primary); }
.tracker-check {
  font-size: .55rem; line-height: 1; color: var(--primary); font-weight: 700;
}
.tracker-check.pending { color: var(--text-light); }
.tracker-mslabel {
  font-size: .6rem; color: var(--text-light); white-space: nowrap;
}
.tracker-mslabel.done { color: var(--text); font-weight: 600; }
.tracker-stall {
  margin-top: .3rem; font-size: .65rem; color: var(--red); font-weight: 600;
  display: flex; align-items: center; gap: .3rem;
}
.tracker-stall::before { content: '\u26A0'; }
html.dark .tracker-bar { background: #374151; }
html.dark .tracker-check.pending { color: var(--text-light); }
.tracker-detail {
  text-align: center; font-size: .62rem; font-style: italic;
  color: var(--text-light); margin-top: .25rem;
}

/* Discipline Progress */
.disc-toggle {
  font-size: .65rem; color: var(--primary); cursor: pointer; user-select: none;
  margin-top: .3rem; display: inline-flex; align-items: center; gap: .25rem;
}
html.dark .disc-toggle { color: var(--accent); }
.disc-toggle:hover { text-decoration: underline; }
.disc-toggle::before { content: '\25B6'; font-size: .5rem; transition: transform .2s; display: inline-block; }
.disc-toggle.open::before { transform: rotate(90deg); }
.disc-detail { display: none; margin-top: .3rem; padding: .4rem .6rem; background: var(--table-head-bg); border-radius: 6px; }
.disc-detail.open { display: block; }
.disc-item { display: flex; align-items: center; gap: .4rem; font-size: .65rem; padding: .15rem 0; }
.disc-icon { width: 14px; height: 14px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: .55rem; font-weight: 700; flex-shrink: 0; }
.disc-icon.complete { background: var(--green); color: #fff; }
.disc-icon.scanning { background: var(--accent); color: #fff; animation: pulse 1.5s infinite; }
.disc-icon.pending { background: var(--border); color: var(--text-light); }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .5; } }
@keyframes spin { to { transform: rotate(360deg); } }
.spinner {
  display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,.3);
  border-top-color: #fff; border-radius: 50%; animation: spin .6s linear infinite;
  vertical-align: middle; margin-right: .4rem;
}
.spinner.dark { border-color: rgba(0,0,0,.15); border-top-color: var(--primary); }
.submit-btn.loading { display: flex; align-items: center; justify-content: center; gap: .4rem; }
.auth-card button:disabled { opacity: .6; cursor: not-allowed; }
.queue-loading { display: flex; align-items: center; justify-content: center; gap: .5rem; color: var(--text-light); padding: 2rem 0; }
.disc-name { color: var(--text); }
.disc-time { color: var(--text-light); font-size: .6rem; margin-left: auto; }
.elapsed-time { font-size: .62rem; color: var(--text-light); margin-top: .2rem; }

/* Refresh indicator */
.refresh-dot {
  display: inline-block; width: 6px; height: 6px; border-radius: 50%;
  background: var(--green); margin-left: .5rem; vertical-align: middle;
  opacity: 0; transition: opacity .3s;
}
.refresh-dot.flash { opacity: 1; }
.last-refreshed { font-size: .7rem; color: var(--text-light); margin-left: auto; }

/* Failed job detail */
.fail-phase { font-size: .7rem; color: var(--red); font-weight: 600; margin-top: .3rem; }
.fail-completed { font-size: .65rem; color: var(--green); margin-top: .2rem; }
.fail-completed span::before { content: '\2713 '; }
.error-preview { font-size: .65rem; color: var(--text-light); margin-top: .3rem; max-height: 2.4em; overflow: hidden; }
.error-toggle {
  font-size: .62rem; color: var(--primary); cursor: pointer; margin-top: .2rem;
  user-select: none;
}
html.dark .error-toggle { color: var(--accent); }
.error-toggle:hover { text-decoration: underline; }
.error-full {
  display: none; font-family: monospace; font-size: .65rem; white-space: pre-wrap;
  max-height: 200px; overflow-y: auto; background: var(--table-head-bg); border-radius: 4px;
  padding: .5rem; margin-top: .3rem; color: var(--text);
}
.error-full.open { display: block; }
.submit-status.has-error {
  background: #fef2f2; border-left: 3px solid var(--red); padding: .5rem .75rem;
  border-radius: 0 6px 6px 0; text-align: left; font-size: .82rem;
}
html.dark .submit-status.has-error { background: #7f1d1d; }
.submit-status.has-error::before { content: '\26A0 '; font-weight: 700; }
.stalled-row td { background: rgba(251,191,36,.06) !important; }
html.dark .stalled-row td { background: rgba(251,191,36,.08) !important; }
.stalled-badge {
  display: inline-block; padding: .1rem .4rem; border-radius: 8px;
  font-size: .62rem; font-weight: 600; margin-left: .4rem;
  background: #fffbeb; color: #92400e;
}
html.dark .stalled-badge { background: #78350f; color: #fbbf24; }
.log-links { display: flex; flex-wrap: wrap; gap: .3rem; margin-top: .3rem; }
.log-links a {
  font-size: .62rem; color: var(--primary); text-decoration: none;
  padding: .1rem .4rem; border: 1px solid var(--border); border-radius: 4px;
}
.log-links a:hover { background: var(--table-hover); }
html.dark .log-links a { color: var(--accent); }

/* Queue Controls */
.queue-controls {
  display: flex; align-items: center; gap: .75rem; margin-bottom: 1rem; flex-wrap: wrap;
}
.queue-search {
  flex: 1; min-width: 180px; padding: .5rem .75rem; border: 2px solid var(--border);
  border-radius: 8px; font-size: .82rem; background: var(--card-bg); color: var(--text); outline: none;
}
.queue-search:focus { border-color: var(--primary); }
.filter-bar { display: flex; gap: .35rem; flex-wrap: wrap; }
.filter-btn {
  padding: .3rem .7rem; border: 1px solid var(--border); border-radius: 6px;
  background: var(--card-bg); color: var(--text-light); font-size: .72rem; cursor: pointer;
  font-weight: 500; transition: all .15s;
}
.filter-btn:hover { background: var(--table-hover); color: var(--text); }
.filter-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
html.dark .filter-btn.active { background: var(--accent); color: #1f2937; border-color: var(--accent); }
.btn-delete {
  padding: .2rem .45rem; border: 1px solid var(--border); border-radius: 4px;
  background: var(--card-bg); color: var(--text-light); font-size: .7rem; cursor: pointer;
  line-height: 1;
}
.btn-delete:hover { background: #fef2f2; color: var(--red); border-color: var(--red); }
html.dark .btn-delete:hover { background: #7f1d1d; color: #f87171; border-color: #f87171; }
.queue-footer {
  margin-top: .75rem; padding: .5rem .75rem; background: var(--table-head-bg);
  border-radius: 6px; font-size: .72rem; color: var(--text-light);
  display: flex; gap: 1rem; flex-wrap: wrap;
}

/* Download Links */
.download-links { display: flex; flex-wrap: wrap; gap: .3rem; }
.download-links a {
  font-size: .72rem; color: var(--primary); text-decoration: none;
  padding: .15rem .5rem; border: 1px solid var(--border); border-radius: 4px;
}
.download-links a:hover { background: var(--table-hover); }
html.dark .download-links a { color: var(--accent); }

/* Help Tab */
.help-section { margin-bottom: 1.5rem; }
.help-section h3 { font-size: .95rem; color: var(--primary); margin-bottom: .5rem; }
html.dark .help-section h3 { color: var(--accent); }
.help-steps { counter-reset: step; padding-left: 0; list-style: none; }
.help-step {
  counter-increment: step; padding: .6rem 0 .6rem 2.5rem; position: relative;
  border-bottom: 1px solid var(--border); font-size: .82rem;
}
.help-step::before {
  content: counter(step); position: absolute; left: 0; top: .5rem;
  width: 1.8rem; height: 1.8rem; border-radius: 50%; background: var(--primary); color: #fff;
  display: flex; align-items: center; justify-content: center; font-size: .75rem; font-weight: 700;
}

/* Connection banner */
.conn-banner {
  display: none; position: fixed; top: 0; left: 0; right: 0; z-index: 900;
  background: var(--red); color: #fff; text-align: center;
  padding: .5rem 1rem; font-size: .82rem; font-weight: 600;
}
.conn-banner.visible { display: flex; justify-content: center; align-items: center; gap: .5rem; }

/* Footer */
footer {
  text-align: center; padding: 1rem; font-size: .75rem; color: var(--text-light);
  border-top: 1px solid var(--border); margin-top: 2rem;
}

@media (max-width: 768px) {
  .form-row { grid-template-columns: 1fr; }
  header { padding: 1rem; }
  .container { padding: 1rem; }
}
</style>
</head>
<body>

<!-- Auth Gate -->
<div id="authGate">
  <div class="auth-card">
    <h2>WSU Review Portal</h2>
    <p>Design Standards Compliance Review</p>
    <input type="password" id="authPass" placeholder="Enter password" autocomplete="off">
    <button onclick="checkAuth()">Sign In</button>
    <div class="auth-error" id="authError">Incorrect password</div>
  </div>
</div>

<!-- Header -->
<header>
  <div class="header-text">
    <h1>WSU Review Portal</h1>
    <p>Design Standards Compliance Review &bull; WSU Facilities Services</p>
  </div>
  <div class="header-actions">
    <a href="index.html">Energy</a>
    <a href="metering.html">Metering</a>
    <a href="water-conservation.html">Water</a>
    <div class="dark-toggle">
      <span class="dark-toggle-label">Dark</span>
      <button class="dark-toggle-switch" id="darkToggle" onclick="toggleDark()"></button>
    </div>
  </div>
</header>

<!-- Main Content -->
<div class="container">
  <div class="nav-tabs">
    <button class="nav-tab active" data-tab="submit">Submit Review</button>
    <button class="nav-tab" data-tab="queue">Review Queue</button>
    <button class="nav-tab" data-tab="help">How to Use</button>
  </div>

  <!-- Tab 1: Submit -->
  <div class="section active" id="sec-submit">
    <div class="card">
      <h2>Submit Compliance Review</h2>
      <form id="reviewForm">
        <div class="form-row">
          <div class="form-group">
            <label>Project Name *</label>
            <input type="text" name="projectName" required placeholder="e.g., Smith Hall Renovation">
          </div>
          <div class="form-group">
            <label>PM Email</label>
            <input type="email" name="pmEmail" placeholder="pm@wsu.edu">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Review Phase *</label>
            <select name="reviewPhase" required>
              <option value="">Select phase...</option>
              <option>50% SD</option><option>95% SD</option>
              <option>50% DD</option><option>95% DD</option>
              <option>50% CD</option><option>95% CD</option><option>100% CD</option>
              <option>NA - Standards Comparison</option>
            </select>
          </div>
          <div class="form-group">
            <label>Construction Type *</label>
            <select name="constructionType" required>
              <option value="">Select type...</option>
              <option>New Construction</option><option>Major Renovation</option>
              <option>Tenant Improvement</option><option>Addition</option><option>Infrastructure</option>
              <option>NA - Standards Comparison</option>
            </select>
          </div>
        </div>

        <!-- Division selection moved to analysis results panel below -->

        <div class="form-group">
          <label>Construction Plan PDF * (max 100 MB)</label>
          <div class="upload-zone" id="uploadZone">
            <div class="upload-icon">&#128196;</div>
            <div class="upload-text">Drag &amp; drop PDF here, or click to browse</div>
            <div class="upload-filename" id="uploadFilename"></div>
            <input type="file" id="pdfFile" accept=".pdf" style="display:none">
          </div>
          <div class="upload-message" id="uploadMessage"></div>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">Analyze PDF</button>
        <div class="submit-status" id="submitStatus"></div>

        <!-- Analysis Results Panel (hidden until analysis completes) -->
        <div class="analysis-panel" id="analysisPanel">
          <div class="analysis-header">
            <h3>PDF Analysis Results</h3>
            <span class="analysis-confidence" id="analysisConfidence"></span>
          </div>

          <div class="analysis-summary" id="analysisSummary"></div>

          <div style="margin-bottom:.75rem">
            <label style="font-weight:600">Recommended Disciplines
              <span class="div-count" id="discCount">0</span>
            </label>
            <div style="font-size:.78rem;color:var(--text-light);margin-bottom:.5rem">
              Uncheck disciplines you don't need. Check additional ones if needed.
            </div>
          </div>

          <div class="analysis-disciplines" id="analysisDisciplines"></div>

          <div class="div-quick-actions" style="margin-bottom:.5rem">
            <button type="button" class="btn-sm" onclick="selectAllDiscs(true)">Select All</button>
            <button type="button" class="btn-sm" onclick="selectAllDiscs(false)">Deselect All</button>
          </div>

          <button type="button" class="confirm-btn" id="confirmBtn" onclick="confirmReview()">
            Start Full Review
          </button>
          <div class="analysis-note">
            Review will only scan selected disciplines. Fewer disciplines = faster review.
          </div>
          <div class="submit-status" id="confirmStatus"></div>
        </div>
      </form>
    </div>
  </div>

  <!-- Tab 2: Queue -->
  <div class="section" id="sec-queue">
    <div class="card">
      <h2>Review Queue<span class="refresh-dot" id="refreshDot"></span></h2>
      <div class="info-box">
        Reviews typically take 15-20 minutes depending on the number of divisions.
        Queue auto-refreshes when this tab is visible. Pauses when you switch away.
      </div>
      <div class="queue-controls">
        <input type="text" class="queue-search" id="queueSearch" placeholder="Search by project name or job ID..." oninput="applyQueueFilters()">
        <div class="filter-bar">
          <button class="filter-btn active" onclick="setStatusFilter('all', this)">All</button>
          <button class="filter-btn" onclick="setStatusFilter('analyzing', this)">Analyzing</button>
          <button class="filter-btn" onclick="setStatusFilter('awaiting', this)">Awaiting</button>
          <button class="filter-btn" onclick="setStatusFilter('processing', this)">Processing</button>
          <button class="filter-btn" onclick="setStatusFilter('complete', this)">Complete</button>
          <button class="filter-btn" onclick="setStatusFilter('failed', this)">Failed</button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Job ID</th>
              <th>Project</th>
              <th>Phase</th>
              <th>Divisions</th>
              <th>Submitted</th>
              <th style="min-width:340px">Status</th>
              <th>Downloads</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="queueBody">
            <tr><td colspan="8"><div class="queue-loading"><span class="spinner dark"></span>Loading queue...</div></td></tr>
          </tbody>
        </table>
      </div>
      <div class="queue-footer" id="queueFooter"></div>
    </div>
  </div>

  <!-- Tab 3: Help -->
  <div class="section" id="sec-help">
    <div class="card">
      <h2>How to Use the Review Portal</h2>

      <div class="help-section">
        <h3>Submitting a Review</h3>
        <ol class="help-steps">
          <li class="help-step">Fill in project name, review phase, and construction type.</li>
          <li class="help-step">Upload the construction plan PDF. This can be a full drawing set or individual discipline sheets.</li>
          <li class="help-step">Click <strong>Analyze PDF</strong> — the system extracts text and classifies pages by discipline.</li>
          <li class="help-step">Review the analysis results — recommended disciplines are pre-checked based on detected sheet types.</li>
          <li class="help-step">Adjust discipline selections if needed, then click <strong>Start Full Review</strong>.</li>
          <li class="help-step">Wait for the review to complete (15-30 minutes). Download reports when done.</li>
        </ol>
      </div>

      <div class="help-section">
        <h3>Understanding the Reports</h3>
        <div class="info-box">
          Two companion deliverables: <strong>report.docx</strong> (narrative Word report) and <strong>report.xlsx</strong> (structured Excel workbook). Finding numbers (F-001, F-002, ...) match exactly between both files. Print the Excel Summary tab for meetings — it fits on one 8.5x11" landscape page.
        </div>
        <p style="font-size:.82rem;margin-top:.5rem"><strong>report.docx</strong> — Word document with executive summary, detailed findings by discipline, variance requests, priority action matrix, and next steps. The full narrative review report.</p>
        <p style="font-size:.82rem;margin-top:.5rem"><strong>report.xlsx</strong> — Excel workbook with 5 tabs: Summary (executive overview, prints to one page), Findings (sortable/filterable), Checklist (all requirements), Variances (items needing WSU approval), and Notes (methodology).</p>
        <p style="font-size:.82rem;margin-top:.5rem"><strong>checklist.txt</strong> — Plain-text checklist showing compliance status for each WSU standard requirement.</p>
        <p style="font-size:.82rem;margin-top:.5rem"><strong>findings.txt</strong> — Plain-text findings log with CSI codes, drawing references, and standard citations.</p>
      </div>

      <div class="help-section">
        <h3>Status Meanings</h3>
        <p style="font-size:.82rem"><span class="job-status analyzing">Analyzing</span> — PDF is being extracted and pages classified by discipline.</p>
        <p style="font-size:.82rem;margin-top:.4rem"><span class="job-status awaiting">Awaiting Confirmation</span> — Analysis complete. Click "View Analysis" to review recommendations and start the full review.</p>
        <p style="font-size:.82rem;margin-top:.4rem"><span class="job-status processing">Processing</span> — Review is running. Claude is reading the PDF and comparing against WSU standards.</p>
        <p style="font-size:.82rem;margin-top:.4rem"><span class="job-status complete">Complete</span> — Review finished. Download links are available.</p>
        <p style="font-size:.82rem;margin-top:.4rem"><span class="job-status failed">Failed</span> — Something went wrong. Check the error message for details.</p>
      </div>

      <div class="help-section">
        <h3>Division Selection Guide</h3>
        <div class="info-box">
          Not sure which divisions to select? Here are common project types and their typical divisions:
        </div>
        <p style="font-size:.82rem;margin-top:.5rem"><strong>Building renovation:</strong> 02, 07, 08, 09, 22, 23, 26, 27</p>
        <p style="font-size:.82rem;margin-top:.3rem"><strong>New building:</strong> All architectural (02-14) + all MEP (21-28) + civil (31-33)</p>
        <p style="font-size:.82rem;margin-top:.3rem"><strong>Infrastructure/utilities:</strong> 31, 32, 33, 40</p>
        <p style="font-size:.82rem;margin-top:.3rem"><strong>HVAC-only project:</strong> 23, 25, 26</p>
      </div>

      <div class="help-section">
        <h3>Troubleshooting</h3>
        <p style="font-size:.82rem"><strong>Review stuck on Processing?</strong> — Reviews typically take 15-30 minutes. If it's been over 60 minutes, check with the system administrator.</p>
        <p style="font-size:.82rem;margin-top:.4rem"><strong>Review failed?</strong> — The most common cause is an unreadable PDF (scanned images without OCR). Try a different PDF or ensure the PDF has selectable text.</p>
        <p style="font-size:.82rem;margin-top:.4rem"><strong>Can't connect?</strong> — Make sure you're on the same network as the review server. The URL should be http://[server-ip]:8083/review-portal.html</p>
      </div>
    </div>
  </div>
</div>

<div class="conn-banner" id="connBanner">Server unreachable &mdash; retrying automatically...</div>

<footer>
  WSU Facilities Services &bull; Design Standards Compliance Review Portal &bull; Prototype
</footer>

<script>
// --- Auth Gate ---
const AUTH_KEY = 'wsuReviewToken';

async function checkAuth() {
  const input = document.getElementById('authPass');
  const btn = document.querySelector('.auth-card button');
  btn.disabled = true;
  try {
    const resp = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: input.value }),
    });
    if (resp.ok) {
      const data = await resp.json();
      localStorage.setItem(AUTH_KEY, data.token);
      document.getElementById('authGate').style.display = 'none';
    } else {
      document.getElementById('authError').style.display = 'block';
      input.value = '';
      input.focus();
    }
  } catch (err) {
    document.getElementById('authError').style.display = 'block';
  }
  btn.disabled = false;
}

// Check if existing token is still valid
(async () => {
  const token = localStorage.getItem(AUTH_KEY);
  if (token) {
    try {
      const resp = await fetch('/api/health', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (resp.ok) {
        document.getElementById('authGate').style.display = 'none';
        return;
      }
    } catch (e) {}
    // Token invalid or expired — clear and show gate
    localStorage.removeItem(AUTH_KEY);
  }
})();

document.getElementById('authPass').addEventListener('keydown', e => {
  if (e.key === 'Enter') checkAuth();
});

function apiFetch(url, opts = {}) {
  const token = localStorage.getItem(AUTH_KEY);
  if (token) {
    if (!opts.headers) opts.headers = {};
    if (opts.headers instanceof Headers) {
      opts.headers.set('Authorization', 'Bearer ' + token);
    } else {
      opts.headers['Authorization'] = 'Bearer ' + token;
    }
  }
  return fetch(url, opts).then(resp => {
    if (resp.status === 401) {
      localStorage.removeItem(AUTH_KEY);
      document.getElementById('authGate').style.display = '';
    }
    return resp;
  });
}

// --- Dark Mode ---
function toggleDark() {
  const on = document.documentElement.classList.toggle('dark');
  localStorage.setItem('wsuDarkMode', on ? 'on' : 'off');
}
if (localStorage.getItem('wsuDarkMode') === 'on') {
  document.documentElement.classList.add('dark');
}

// --- Tab Navigation ---
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('sec-' + tab.dataset.tab).classList.add('active');
  });
});

// --- HTML escape (XSS prevention) ---
function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

// --- Upload Zone ---
const zone = document.getElementById('uploadZone');
const fileInput = document.getElementById('pdfFile');
const fileLabel = document.getElementById('uploadFilename');

zone.addEventListener('click', () => fileInput.click());
zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
zone.addEventListener('drop', e => {
  e.preventDefault();
  zone.classList.remove('dragover');
  const msg = document.getElementById('uploadMessage');
  const file = e.dataTransfer.files[0];
  if (!file) return;
  if (!file.name.toLowerCase().endsWith('.pdf')) {
    msg.textContent = 'Only PDF files are accepted. You dropped: ' + file.name;
    msg.className = 'upload-message error';
    return;
  }
  msg.className = 'upload-message';
  fileInput.files = e.dataTransfer.files;
  showFile(file);
});
fileInput.addEventListener('change', () => {
  if (fileInput.files[0]) showFile(fileInput.files[0]);
});
function showFile(f) {
  const sizeMB = f.size / 1048576;
  fileLabel.textContent = f.name + ' (' + sizeMB.toFixed(1) + ' MB)';
  zone.classList.add('has-file');
  const msg = document.getElementById('uploadMessage');
  if (sizeMB > 80) {
    msg.textContent = 'Large file (' + sizeMB.toFixed(0) + ' MB). Limit is 100 MB. Upload may be slow.';
    msg.className = 'upload-message warn';
  } else {
    msg.className = 'upload-message';
  }
}

// --- Submission & Analysis Flow ---
let currentAnalysisJobId = null;
let analysisPoller = null;

// Restore from session storage if page was reloaded during analysis
(function() {
  const saved = sessionStorage.getItem('analysisJobId');
  if (saved) {
    currentAnalysisJobId = saved;
    pollAnalysis(saved);
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.classList.add('loading');
    btn.innerHTML = '<span class="spinner"></span>Analyzing...';
    const status = document.getElementById('submitStatus');
    status.textContent = 'Resuming analysis poll for job ' + saved + '...';
    status.style.color = 'var(--blue)';
  }
})();

document.getElementById('reviewForm').addEventListener('submit', async e => {
  e.preventDefault();
  const form = e.target;
  const btn = document.getElementById('submitBtn');
  const status = document.getElementById('submitStatus');
  const pdf = document.getElementById('pdfFile').files[0];

  btn.disabled = true;
  btn.classList.add('loading');
  btn.innerHTML = '<span class="spinner"></span>Uploading & Analyzing...';
  status.textContent = '';
  status.className = 'submit-status';

  function showErr(msg) {
    status.textContent = msg;
    status.className = 'submit-status has-error';
    status.style.color = 'var(--red)';
    btn.disabled = false;
    btn.classList.remove('loading');
    btn.textContent = 'Analyze PDF';
  }

  if (!pdf) { showErr('Please select a PDF file.'); return; }
  if (pdf.size > 100 * 1024 * 1024) {
    showErr('PDF too large (' + (pdf.size/1048576).toFixed(1) + ' MB). Maximum is 100 MB.');
    return;
  }

  const fd = new FormData();
  fd.append('projectName', form.projectName.value);
  fd.append('pmEmail', form.pmEmail.value);
  fd.append('reviewPhase', form.reviewPhase.value);
  fd.append('constructionType', form.constructionType.value);
  fd.append('divisions', '');  // empty — filled after analysis
  fd.append('pdf', pdf);

  try {
    const resp = await apiFetch('/api/submit', { method: 'POST', body: fd });
    const data = await resp.json();
    if (resp.ok) {
      currentAnalysisJobId = data.id;
      sessionStorage.setItem('analysisJobId', data.id);
      status.textContent = 'Analyzing PDF... (this takes 1-7 minutes depending on size)';
      status.className = 'submit-status';
      status.style.color = 'var(--blue)';
      // Start polling for analysis completion
      pollAnalysis(data.id);
    } else if (resp.status === 409) {
      showErr(data.error || 'A review is already running.');
    } else {
      showErr(data.error || 'Submission failed');
    }
  } catch (err) {
    showErr('Network error: ' + err.message);
  }
});

function pollAnalysis(jobId) {
  if (analysisPoller) clearInterval(analysisPoller);
  analysisPoller = setInterval(async () => {
    try {
      const resp = await apiFetch('/api/analysis/' + jobId);
      if (resp.ok) {
        const data = await resp.json();
        if (data.status === 'Awaiting Confirmation') {
          clearInterval(analysisPoller);
          analysisPoller = null;
          showAnalysisResults(jobId, data.analysis);
        } else if (data.status === 'Failed') {
          clearInterval(analysisPoller);
          analysisPoller = null;
          currentAnalysisJobId = null;
          sessionStorage.removeItem('analysisJobId');
          const btn = document.getElementById('submitBtn');
          btn.disabled = false;
          btn.classList.remove('loading');
          btn.textContent = 'Analyze PDF';
          btn.style.display = '';
          const status = document.getElementById('submitStatus');
          const errDetail = data.analysis?.error || data.error || '';
          status.textContent = 'Analysis failed for job ' + jobId + '.' + (errDetail ? ' ' + errDetail : ' Check server logs.');
          status.style.color = 'var(--red)';
        } else if (data.status === 'Processing' || data.status === 'Complete') {
          // Job moved past analysis — clean up
          clearInterval(analysisPoller);
          analysisPoller = null;
          currentAnalysisJobId = null;
          sessionStorage.removeItem('analysisJobId');
          const btn = document.getElementById('submitBtn');
          btn.disabled = false;
          btn.classList.remove('loading');
          btn.textContent = 'Analyze PDF';
          btn.style.display = '';
          const status = document.getElementById('submitStatus');
          status.textContent = 'Job ' + jobId + ' has already moved to ' + data.status + '.';
          status.style.color = 'var(--text-light)';
        }
      } else if (resp.status === 404) {
        // Analysis not ready yet — check if job failed
        const jobResp = await apiFetch('/api/jobs');
        if (jobResp.ok) {
          const jobData = await jobResp.json();
          const jobs = Array.isArray(jobData) ? jobData : (jobData.jobs || []);
          const job = jobs.find(j => j.id === jobId);
          if (job && job.status === 'Failed') {
            clearInterval(analysisPoller);
            analysisPoller = null;
            currentAnalysisJobId = null;
            sessionStorage.removeItem('analysisJobId');
            const btn = document.getElementById('submitBtn');
            btn.disabled = false;
            btn.classList.remove('loading');
            btn.textContent = 'Analyze PDF';
            const status = document.getElementById('submitStatus');
            status.textContent = 'Analysis failed: ' + (job.error || 'Unknown error');
            status.className = 'submit-status has-error';
            status.style.color = 'var(--red)';
          }
        }
      }
    } catch (err) { /* retry next cycle */ }
  }, 3000);
}

// Discipline group metadata (matches server @ALL_GROUPS)
const DISC_GROUPS = {
  'arch-structure':  { name: 'Architectural — Structure & Envelope', divs: ['02','03','04','05','07','08'] },
  'arch-finishes':   { name: 'Architectural — Finishes & Equipment', divs: ['09','10','11','12','13','14'] },
  'fire-protection': { name: 'Fire Protection and Security',        divs: ['21','28'] },
  'plumbing':        { name: 'Plumbing',                            divs: ['22'] },
  'hvac-controls':   { name: 'HVAC and Building Automation',        divs: ['23','25'] },
  'electrical':      { name: 'Electrical',                          divs: ['26'] },
  'communications':  { name: 'Communications and Technology',       divs: ['27'] },
  'civil-site':      { name: 'Civil, Site, and Utilities',          divs: ['31','32','33','40'] },
};

function showAnalysisResults(jobId, analysis) {
  const btn = document.getElementById('submitBtn');
  btn.disabled = false;
  btn.classList.remove('loading');
  btn.textContent = 'Analyze PDF';
  btn.style.display = 'none'; // hide after analysis

  const status = document.getElementById('submitStatus');
  status.textContent = '';
  status.className = 'submit-status';

  const panel = document.getElementById('analysisPanel');
  panel.classList.add('visible');

  // Confidence badge
  const confEl = document.getElementById('analysisConfidence');
  confEl.textContent = (analysis.confidence || 'unknown') + ' confidence';
  confEl.className = 'analysis-confidence ' + (analysis.confidence || 'low');

  // Summary stats
  const sumEl = document.getElementById('analysisSummary');
  const nDisc = Object.keys(analysis.recommended_disciplines || {}).length;
  const nDivs = (analysis.recommended_divisions || []).length;
  const nUnclass = analysis.unclassified_count || 0;
  sumEl.innerHTML =
    '<div class="analysis-stat"><div class="stat-value">' + analysis.total_pages + '</div><div class="stat-label">Total Pages</div></div>' +
    '<div class="analysis-stat"><div class="stat-value">' + nDisc + '</div><div class="stat-label">Disciplines Detected</div></div>' +
    '<div class="analysis-stat"><div class="stat-value">' + nDivs + '</div><div class="stat-label">CSI Divisions</div></div>' +
    '<div class="analysis-stat"><div class="stat-value">' + nUnclass + '</div><div class="stat-label">Unclassified Pages</div></div>';

  let warningHtml = '';
  if (analysis.confidence === 'low') {
    warningHtml = '<div style="background:var(--info-bg);border:1px solid var(--red);' +
      'border-radius:6px;padding:8px 12px;margin-top:8px;font-size:0.85rem;color:var(--red)">' +
      'Low confidence: Sheet designations could not be detected. All disciplines are selected by default — ' +
      'uncheck any that are not relevant to this project to reduce review time and cost.</div>';
  }
  sumEl.innerHTML += warningHtml;

  // Discipline rows with checkboxes
  const discEl = document.getElementById('analysisDisciplines');
  const recommended = analysis.recommended_disciplines || {};
  let html = '';
  for (const [key, meta] of Object.entries(DISC_GROUPS)) {
    const rec = recommended[key];
    const checked = rec ? ' checked' : '';
    const pageCount = rec ? rec.page_count : 0;
    const sheets = rec ? (rec.sheet_ids || []).slice(0, 5).join(', ') : '';
    const divsList = meta.divs.join(', ');
    html += '<div class="analysis-disc-row">' +
      '<input type="checkbox" name="disc" value="' + key + '" data-divs="' + divsList + '"' + checked +
      ' onchange="updateDiscCount()">' +
      '<div class="analysis-disc-name">' + esc(meta.name) + '</div>' +
      '<div class="analysis-disc-pages">' + pageCount + ' pages</div>' +
      (sheets ? '<div class="analysis-disc-sheets" title="' + esc(sheets) + '">' + esc(sheets) + '</div>' : '') +
      '<div class="analysis-disc-divs">Div ' + divsList + '</div>' +
      '</div>';
  }
  discEl.innerHTML = html;
  updateDiscCount();
}

function updateDiscCount() {
  const n = document.querySelectorAll('#analysisDisciplines input:checked').length;
  const el = document.getElementById('discCount');
  if (!el) return;
  el.textContent = n;
  el.classList.toggle('zero', n === 0);
  const confirmBtn = document.getElementById('confirmBtn');
  if (confirmBtn) confirmBtn.disabled = n === 0;
  let hint = document.getElementById('discHint');
  if (!hint) {
    hint = document.createElement('div');
    hint.id = 'discHint';
    hint.style.cssText = 'color:var(--red);font-size:0.85rem;margin-top:4px;';
    const parent = document.getElementById('analysisDisciplines');
    if (parent) parent.parentNode.insertBefore(hint, parent.nextSibling);
  }
  hint.textContent = n === 0 ? 'Select at least one discipline to continue.' : '';
}

function selectAllDiscs(checked) {
  document.querySelectorAll('#analysisDisciplines input').forEach(cb => cb.checked = checked);
  updateDiscCount();
}

async function confirmReview() {
  if (!currentAnalysisJobId) return;
  const btn = document.getElementById('confirmBtn');
  const status = document.getElementById('confirmStatus');
  btn.disabled = true;
  btn.classList.add('loading');
  btn.innerHTML = '<span class="spinner"></span>Starting review...';

  // Collect all CSI divisions from checked discipline groups
  const divSet = new Set();
  document.querySelectorAll('#analysisDisciplines input:checked').forEach(cb => {
    cb.dataset.divs.split(',').map(d => d.trim()).forEach(d => divSet.add(d));
  });

  try {
    const resp = await apiFetch('/api/confirm/' + currentAnalysisJobId, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ divisions: Array.from(divSet).sort() }),
    });
    const data = await resp.json();
    if (resp.ok) {
      status.textContent = 'Review started! Job ID: ' + data.id;
      status.style.color = 'var(--green)';
      // Reset form and panel
      document.getElementById('reviewForm').reset();
      document.getElementById('uploadFilename').textContent = '';
      document.getElementById('uploadZone').classList.remove('has-file');
      document.getElementById('analysisPanel').classList.remove('visible');
      document.getElementById('submitBtn').style.display = '';
      currentAnalysisJobId = null;
      sessionStorage.removeItem('analysisJobId');
      document.getElementById('confirmStatus').textContent = '';
      // Switch to queue tab
      document.querySelector('[data-tab="queue"]').click();
      refreshQueue();
    } else {
      status.textContent = data.error || 'Failed to start review';
      status.style.color = 'var(--red)';
      btn.disabled = false;
      btn.classList.remove('loading');
      btn.textContent = 'Start Full Review';
      // If job moved past awaiting confirmation, dismiss stale panel after showing error
      if (resp.status === 400 && (data.error || '').includes('not awaiting confirmation')) {
        setTimeout(() => {
          document.getElementById('analysisPanel').classList.remove('visible');
          document.getElementById('submitBtn').style.display = '';
          document.getElementById('submitBtn').disabled = false;
          document.getElementById('submitBtn').textContent = 'Analyze PDF';
          currentAnalysisJobId = null;
          sessionStorage.removeItem('analysisJobId');
        }, 3000);
      }
    }
  } catch (err) {
    status.textContent = 'Network error: ' + err.message;
    status.style.color = 'var(--red)';
    btn.disabled = false;
    btn.classList.remove('loading');
    btn.textContent = 'Start Full Review';
  }
}

async function viewAnalysis(jobId) {
  // Switch to submit tab and load analysis
  document.querySelector('[data-tab="submit"]').click();
  currentAnalysisJobId = jobId;
  sessionStorage.setItem('analysisJobId', jobId);
  try {
    const resp = await apiFetch('/api/analysis/' + jobId);
    if (resp.ok) {
      const data = await resp.json();
      showAnalysisResults(jobId, data.analysis);
    }
  } catch (err) { console.error('Failed to load analysis:', err); }
}

// --- Elapsed time formatter ---
function fmtElapsed(seconds) {
  if (!seconds || seconds < 0) return '';
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = Math.floor(seconds % 60);
  if (h > 0) return h + 'h ' + m + 'm';
  if (m > 0) return m + 'm ' + s + 's';
  return s + 's';
}

// --- Discipline progress detail ---
function buildDiscDetail(job) {
  if (!job.disciplineStatus || !job.disciplineStatus.length) return '';
  const id = 'disc-' + job.id;
  let html = '<div class="disc-toggle" onclick="this.classList.toggle(\'open\');document.getElementById(\'' + id + '\').classList.toggle(\'open\')">Show disciplines</div>';
  html += '<div class="disc-detail" id="' + id + '">';
  for (const d of job.disciplineStatus) {
    const icon = d.status === 'complete' ? '\u2713' : d.status === 'scanning' ? '\u2026' : '\u2022';
    const time = d.completedAt ? new Date(d.completedAt * 1000).toLocaleTimeString() : '';
    html += '<div class="disc-item">';
    html += '<span class="disc-icon ' + d.status + '">' + icon + '</span>';
    html += '<span class="disc-name">' + esc(d.name || d.key) + '</span>';
    if (time) html += '<span class="disc-time">' + time + '</span>';
    html += '</div>';
  }
  html += '</div>';
  return html;
}

// --- Progress bar tracker ---
function buildTracker(pct, stalled, detail, stalledPhase) {
  const steps = [
    {at: 5,   label: 'Submitted'},
    {at: 7,   label: 'Scanning'},
    {at: 80,  label: 'Scanned'},
    {at: 82,  label: 'Synthesizing'},
    {at: 90,  label: 'Reports'},
    {at: 99,  label: 'Finalizing'},
    {at: 100, label: 'Complete'}
  ];
  // Map raw pct to visual position so bar fill aligns with evenly-spaced milestones
  var barPct;
  if (pct <= steps[0].at) { barPct = 0; }
  else if (pct >= steps[steps.length - 1].at) { barPct = 100; }
  else {
    barPct = 0;
    for (var si = 0; si < steps.length - 1; si++) {
      if (pct >= steps[si].at && pct <= steps[si + 1].at) {
        var frac = (pct - steps[si].at) / (steps[si + 1].at - steps[si].at);
        var visStart = (si / (steps.length - 1)) * 100;
        var visEnd = ((si + 1) / (steps.length - 1)) * 100;
        barPct = visStart + frac * (visEnd - visStart);
        break;
      }
    }
  }
  const fillClass = pct >= 100 ? ' complete' : (stalled ? ' stalled' : '');
  let html = '<div class="tracker">';
  html += '<div class="tracker-bar">';
  html += '<div class="tracker-fill' + fillClass + '" style="width:' + barPct + '%"></div>';
  html += '</div>';
  html += '<div class="tracker-milestones">';
  for (let i = 0; i < steps.length; i++) {
    const s = steps[i];
    const done = pct >= s.at;
    html += '<div class="tracker-ms">';
    html += '<div class="tracker-tick' + (done ? ' done' : '') + '"></div>';
    html += '<div class="tracker-check' + (done ? '' : ' pending') + '">' +
            (done ? '\u2713' : '\u2022') + '</div>';
    html += '<div class="tracker-mslabel' + (done ? ' done' : '') + '">' + s.label + '</div>';
    html += '</div>';
  }
  html += '</div>';
  if (detail) {
    html += '<div class="tracker-detail">' + esc(detail) + '</div>';
  }
  if (stalled) {
    const phaseInfo = stalledPhase ? ' in ' + esc(stalledPhase) : '';
    html += '<div class="tracker-stall">Stalled' + phaseInfo + ' — no progress for ' + stalled + ' min</div>';
  }
  html += '</div>';
  return html;
}

// --- Queue state ---
let queueData = [];
let statusFilter = 'all';
let queueStats = { totalJobs: 0, totalBytes: 0 };
let lastDataHash = '';
let pollTimer = null;
let pollInterval = 10000;
const POLL_BASE = 10000;
const POLL_MAX = 60000;
let pollFailures = 0;
let lastRefreshTime = 0;

function fmtBytes(n) {
  if (n < 1024) return n + ' B';
  if (n < 1048576) return (n / 1024).toFixed(1) + ' KB';
  if (n < 1073741824) return (n / 1048576).toFixed(1) + ' MB';
  return (n / 1073741824).toFixed(2) + ' GB';
}

function setStatusFilter(filter, btn) {
  statusFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  applyQueueFilters();
}

function applyQueueFilters() {
  const search = (document.getElementById('queueSearch').value || '').toLowerCase();
  const filtered = queueData.filter(j => {
    if (statusFilter !== 'all') {
      let sc = (j.status || '').toLowerCase();
      if (sc === 'awaiting confirmation') sc = 'awaiting';
      if (sc !== statusFilter) return false;
    }
    if (search) {
      const name = (j.projectName || '').toLowerCase();
      const id = (j.id || '').toLowerCase();
      if (!name.includes(search) && !id.includes(search)) return false;
    }
    return true;
  });
  renderQueue(filtered);
}

async function deleteJob(jobId, name) {
  if (!confirm('Delete job ' + jobId + (name ? ' (' + name + ')' : '') + '?\n\nThis permanently removes all files.')) return;
  try {
    const resp = await apiFetch('/api/jobs/' + jobId, { method: 'DELETE' });
    if (resp.ok) {
      refreshQueue();
    } else {
      const data = await resp.json().catch(() => ({}));
      alert(data.error || 'Failed to delete job');
    }
  } catch (err) { /* retry next cycle */ }
}

function renderQueue(jobs) {
  const tbody = document.getElementById('queueBody');
  if (!jobs.length) {
    const msg = queueData.length ? 'No matching reviews.' : 'No reviews submitted yet.';
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-light)">' + msg + '</td></tr>';
    return;
  }

  tbody.innerHTML = jobs.map(j => {
    let sc = (j.status || '').toLowerCase();
    if (sc === 'awaiting confirmation') sc = 'awaiting';
    const isStalled = sc === 'processing' && j.stalledMinutes;
    const rowCls = isStalled ? ' class="stalled-row"' : '';
    const divs = (j.divisions || []).join(', ');
    const time = j.submitted ? new Date(j.submitted).toLocaleString() : '-';
    let dl = '-';
    if (sc === 'complete' && j.outputFiles && j.outputFiles.length) {
      dl = '<div class="download-links">' +
        j.outputFiles.map(f =>
          '<a href="/api/download/' + esc(j.id) + '/' + esc(f) + '" target="_blank">' + esc(f) + '</a>'
        ).join('') + '</div>';
    } else if (sc === 'failed') {
      const errId = 'err-' + j.id;
      let failHtml = '';
      if (j.failedPhase) {
        failHtml += '<div class="fail-phase">Failed in ' + esc(j.failedPhase) + '</div>';
      }
      if (j.completedPhases && j.completedPhases.length) {
        failHtml += '<div class="fail-completed">' +
          j.completedPhases.map(p => '<span>' + esc(p) + '</span>').join('<br>') + '</div>';
      }
      const shortErr = (j.error || 'Check logs').substring(0, 150);
      failHtml += '<div class="error-preview">' + esc(shortErr) + '</div>';
      failHtml += '<div class="error-toggle" onclick="document.getElementById(\'' + errId + '\').classList.toggle(\'open\');this.textContent=this.textContent===\'Show full error\'?\'Hide error\':\'Show full error\'">Show full error</div>';
      failHtml += '<div class="error-full" id="' + errId + '">' + esc(j.error) + '</div>';
      if (j.errorLogs && j.errorLogs.length) {
        failHtml += '<div class="log-links">' +
          j.errorLogs.map(f => '<a href="/api/logs/' + esc(j.id) + '/' + esc(f) + '" target="_blank">' + esc(f) + '</a>').join('') +
          '</div>';
      }
      dl = failHtml;
    }
    const delBtn = '<button class="btn-delete" onclick="deleteJob(\'' + esc(j.id) + '\',\'' +
      esc((j.projectName || '').replace(/'/g,'')) + '\')" title="Delete job">\uD83D\uDDD1</button>';
    return '<tr' + rowCls + '>' +
      '<td style="font-size:.75rem;white-space:nowrap">' + esc(j.id) + '</td>' +
      '<td>' + esc(j.projectName) + '</td>' +
      '<td>' + esc(j.reviewPhase) + '</td>' +
      '<td style="font-size:.75rem">' + esc(divs) + '</td>' +
      '<td style="font-size:.75rem;white-space:nowrap">' + time + '</td>' +
      '<td><span class="job-status ' + sc + '">' + esc(j.status) + '</span>' +
        (isStalled ? '<span class="stalled-badge">Stalled</span>' : '') +
        (j.emailSent ? '<span class="email-icon sent" title="Email sent ' + esc(j.emailSentAt) + '">&#9993;</span>'
         : j.emailError ? '<span class="email-icon error" title="Email failed: ' + esc(j.emailError) + '">&#9993;</span>'
         : '') +
        (sc === 'analyzing' ? '<div class="elapsed-time">Analyzing PDF...</div>' : '') +
        (sc === 'awaiting' ?
          '<button class="btn-sm primary" style="margin-top:.3rem;font-size:.7rem" ' +
          'onclick="viewAnalysis(\'' + esc(j.id) + '\')">View Analysis</button>' : '') +
        (sc === 'processing' && j.progress ? buildTracker(j.progress, j.stalledMinutes, j.progressDetail, j.stalledPhase) +
          (j.elapsedSeconds ? '<div class="elapsed-time">Elapsed: ' + fmtElapsed(j.elapsedSeconds) + '</div>' : '') +
          buildDiscDetail(j) : '') +
        (sc === 'complete' ? buildTracker(100) : '') +
        ((sc === 'complete' || sc === 'failed') && j.durationSeconds ? (function() {
          var s = '<div style="font-size:.75rem;color:var(--text-light);margin-top:.25rem">Duration: ' + fmtElapsed(j.durationSeconds);
          if (j.pdfSizeBytes) { s += ' &middot; PDF: ' + (j.pdfSizeBytes / 1048576).toFixed(1) + ' MB'; }
          s += '</div>';
          return s;
        })() : '') + '</td>' +
      '<td>' + dl + '</td>' +
      '<td>' + delBtn + '</td></tr>';
  }).join('');
}

// --- Smart Polling ---

function hashData(data) {
  return JSON.stringify(data.map(j => j.id + '|' + j.status + '|' + (j.progress||0) + '|' + (j.stalledMinutes||0)));
}

function updateLastRefreshed() {
  const el = document.getElementById('lastRefreshed');
  if (!el || !lastRefreshTime) return;
  const ago = Math.round((Date.now() - lastRefreshTime) / 1000);
  if (ago < 5) el.textContent = 'Updated just now';
  else if (ago < 60) el.textContent = 'Updated ' + ago + 's ago';
  else el.textContent = 'Updated ' + Math.floor(ago / 60) + 'm ago';
}

async function refreshQueue() {
  const banner = document.getElementById('connBanner');
  const dot = document.getElementById('refreshDot');
  try {
    const resp = await apiFetch('/api/jobs');
    const result = await resp.json();
    const newData = Array.isArray(result) ? result : (result.jobs || []);
    queueStats = {
      totalJobs: result.totalJobs || newData.length,
      totalBytes: result.totalBytes || 0,
    };

    const newHash = hashData(newData);
    const changed = newHash !== lastDataHash;
    queueData = newData;
    lastDataHash = newHash;
    lastRefreshTime = Date.now();

    const footer = document.getElementById('queueFooter');
    if (footer) {
      const proc = queueData.filter(j => (j.status||'').toLowerCase() === 'processing').length;
      const comp = queueData.filter(j => (j.status||'').toLowerCase() === 'complete').length;
      const fail = queueData.filter(j => (j.status||'').toLowerCase() === 'failed').length;
      const anal = queueData.filter(j => (j.status||'').toLowerCase() === 'analyzing').length;
      const await_ = queueData.filter(j => (j.status||'').toLowerCase() === 'awaiting confirmation').length;
      footer.innerHTML =
        '<span>Total: ' + queueStats.totalJobs + ' jobs</span>' +
        '<span>Analyzing: ' + anal + '</span>' +
        '<span>Awaiting: ' + await_ + '</span>' +
        '<span>Processing: ' + proc + '</span>' +
        '<span>Complete: ' + comp + '</span>' +
        '<span>Failed: ' + fail + '</span>' +
        (queueStats.totalBytes ? '<span>Disk: ' + fmtBytes(queueStats.totalBytes) + '</span>' : '') +
        '<span class="last-refreshed" id="lastRefreshed"></span>';
    }
    updateLastRefreshed();

    if (changed && dot) {
      dot.classList.add('flash');
      setTimeout(() => dot.classList.remove('flash'), 800);
    }

    pollFailures = 0;
    pollInterval = POLL_BASE;
    if (banner) banner.classList.remove('visible');

    // Always re-render if any job is processing (elapsedSeconds changes each poll)
    var hasActive = newData.some(function(j) {
      var s = (j.status||'').toLowerCase();
      return s === 'processing' || s === 'analyzing';
    });
    if (changed || hasActive) applyQueueFilters();
  } catch (err) {
    pollFailures++;
    pollInterval = Math.min(POLL_MAX, POLL_BASE * Math.pow(1.5, pollFailures));
    if (pollFailures >= 2 && banner) {
      banner.textContent = 'Server unreachable \u2014 retry ' + pollFailures + ' (next attempt in ' + Math.round(pollInterval / 1000) + 's)';
      banner.classList.add('visible');
    }
  }
  schedulePoll();
}

function schedulePoll() {
  if (pollTimer) clearTimeout(pollTimer);
  pollTimer = setTimeout(refreshQueue, pollInterval);
}

document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    if (pollTimer) { clearTimeout(pollTimer); pollTimer = null; }
  } else {
    refreshQueue();
  }
});

setInterval(updateLastRefreshed, 5000);
refreshQueue();
</script>
</body>
</html>

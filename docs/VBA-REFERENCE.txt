VBA REFERENCE -- ExportDataJSON.bas
====================================

Complete reference for the VBA macro that exports data from the Excel workbook to data.json.


MODULE OVERVIEW
---------------

Module name:              ExportDataJSON
File:                     ExportDataJSON.bas
Public subroutines:       2 (ExportDataJSON, AddExportButton)
Private helper functions: 5 (ReadRow, ReadRowDec, ReadRowPct, ReadRowPctText, ArrToStr)
Required sheets:          "Executive Summary (Print)", "HDD Data", "Kintec Data", "Consolidated Data"
Output:                   data.json in the same folder as the workbook


PUBLIC SUBROUTINES
------------------

ExportDataJSON() (line 15)
..........................

Main export routine. This is what runs when you click the "Export data.json" button or run it from the Macros menu (Alt+F8).

What it does:
1. Opens all 4 required worksheets
2. Reads data from each sheet using hard-coded row/column ranges
3. Builds a JSON string manually (no JSON library)
4. Cross-checks Executive Summary values against Consolidated Data
5. Writes data.json to ThisWorkbook.Path (same folder as the workbook)
6. Shows a message box with the file path, verification results, and any discrepancy warnings

Error handling: The entire routine is wrapped in On Error GoTo ErrHandler which displays the error number and description.

Performance: Sets Application.ScreenUpdating = False and uses Application.StatusBar to show progress.


AddExportButton() (line 483)
.............................

One-time setup. Creates a clickable button on the "Executive Summary (Print)" sheet.

What it does:
1. Deletes any existing button named btnExportJSON on the target sheet
2. Also cleans up any old button on a sheet named "Executive Summary" (from an earlier version of the workbook)
3. Creates a rounded rectangle shape at cell M2 (130x32 pixels)
4. Styles it with WSU Crimson background (RGB(152, 30, 50)), white bold text
5. Assigns the ExportDataJSON.ExportDataJSON macro to the button's click action

When to run: Only once, when first setting up the workbook. The button persists after creation.


PRIVATE HELPER FUNCTIONS
-------------------------

ReadRow(ws, startRow, endRow, col) (line 357)
..............................................

Reads a column of cells across consecutive rows and returns a comma-separated string of integers.

Parameter    Type         Description
---------    ----         -----------
ws           Worksheet    The worksheet to read from
startRow     Long         First row to read
endRow       Long         Last row to read
col          Long         Column number (1=A, 2=B, etc.)
Returns      String       Comma-separated integers, e.g. "1629889,1733057,..."

Behavior: Non-numeric or empty cells become 0. All values are converted via CLng(CDbl(v)) which rounds to the nearest integer.


ReadRowDec(ws, startRow, endRow, col, decimals) (line 377)
..........................................................

Same as ReadRow but preserves decimal precision.

Parameter    Type    Description
---------    ----    -----------
decimals     Long    Number of decimal places to keep
Returns      String  Comma-separated decimals, e.g. "6.41,6.09,..."

Used for: Gas $/MMBTU rates (2 decimals), kWh rates (4 decimals).


ReadRowPct(ws, startRow, endRow, col) (line 400)
.................................................

Reads percentage values with auto-detection of Excel's storage format.

Returns: Comma-separated percentage values with 1 decimal, e.g. "8.7,7.0,..."

The percentage gotcha: Excel stores percentages in two ways:
1. % format: The cell displays "8.7%" but the underlying value is 0.087. Detected by checking if NumberFormat contains "%".
2. Plain number: The cell contains 8.7 as-is.

Logic:
1. If the cell's NumberFormat contains "%", multiply by 100
2. Else if the absolute value is < 1 and non-zero, multiply by 100
3. Otherwise use the value as-is

Used for: cumul.deltaPct, cumul.mmbtuDeltaPct, variance.mmbtuDeltaPct


ReadRowPctText(ws, startRow, endRow, col) (line 429)
.....................................................

Reads percentages that may be stored as text, handling special formatting.

Handles:
- Numeric values (same auto-detection as ReadRowPct)
- Text like "350%" -- strips the "%" and parses the number
- Text like "(94%)" -- strips "%" and "()", treats parentheses as negative
- Commas in numbers are stripped

Returns: Comma-separated integers (no decimal places).

Used for: variance.hddDeltaPct (which can have text-formatted percentages like "350%" or "(94%)").


ArrToStr(arr) (line 468)
.........................

Converts a Double(1 To 12) array to a comma-separated integer string.

Used for: Converting the verification accumulator arrays into JSON output.


SHEET-TO-JSON MAPPING TABLE
-----------------------------

Complete cross-reference of where every JSON field comes from in Excel:

JSON Section    Excel Sheet                    Row Range   Column Range    VBA Lines
------------    -----------                    ---------   ------------    ---------
fy26            Executive Summary (Print)      3-14        B(2) - K(11)   52-66
fy25gas         Executive Summary (Print)      21-32       B(2) - I(9)    75-81
energyUse       Executive Summary (Print)      39-50       B(2) - J(10)   90-97
yoy             Executive Summary (Print)      57-68       B(2) - G(7)    106-113
cumul           Executive Summary (Print)      74-85       B(2) - I(9)    122-131
variance        Executive Summary (Print)      127-138     B(2) - L(12)   140-152
hdd             HDD Data                       6-17        C(3) - E(5)    159-163
kintec          Kintec Data                    2-last row  A(1), E(5), F(6)  169-200
verification    Consolidated Data              2-last row  A(1), H(8), J(10), K(11), N(14), O(15), P(16)  206-264

Row-to-month mapping for 12-month sections:
- Row offset +0 (e.g., row 3) = July (index 0)
- Row offset +1 (e.g., row 4) = August (index 1)
- Row offset +2 (e.g., row 5) = September (index 2)
- ...
- Row offset +11 (e.g., row 14) = June (index 11)


VERIFICATION LOGIC
-------------------

The macro cross-checks "Executive Summary (Print)" values against raw billing data in "Consolidated Data" to catch data entry errors.

How it works:

1. FY2026 month dates are hardcoded (lines 210-222):

   fy26Months(1) = DateSerial(2025, 7, 1)   ' July 2025
   fy26Months(2) = DateSerial(2025, 8, 1)   ' August 2025
   ...
   fy26Months(12) = DateSerial(2026, 6, 1)  ' June 2026

2. Loops through every row in "Consolidated Data" (rows 2 to last):
   - Reads the date from column N (14)
   - Matches it to an FY2026 month
   - Accumulates: Electric $ (col J), Gas $ (col K), kWh (col H), Elec MMBTU (col O), Gas MMBTU (col P)

3. Compares totals for each month:
   - Executive Summary: Cells(month+2, 3) (Elec) + Cells(month+2, 4) (Gas)
   - Consolidated Data: cElec(month) + cGas(month)
   - Threshold: >5% difference triggers a warning

4. Skips forecast months: Only compares months where Consolidated Data has non-zero totals (i.e., billing data exists).

5. Output: Shows discrepancy details in the export message box with the format:
   Dec: Exec=$2,984,496 vs Consol=$2,985,027 (0.0%)


IMPORTANT: These dates must be updated for a new fiscal year.

When transitioning to FY2027, update lines 210-222 to:

   fy26Months(1) = DateSerial(2026, 7, 1)   ' July 2026
   fy26Months(2) = DateSerial(2026, 8, 1)   ' August 2026
   ...
   fy26Months(12) = DateSerial(2027, 6, 1)  ' June 2027


COMMON MODIFICATION SCENARIOS
-------------------------------

Adding a new data section:

1. Identify the source sheet, header row, data row range, and columns
2. Add a new block in ExportDataJSON() following the pattern:

   ' =================================================================
   ' SECTION NAME  (Sheet rows X-Y)
   ' Row descriptions...
   ' =================================================================
   json = json & "  ""sectionName"": {" & vbCrLf
   json = json & "    ""field1"": [" & ReadRow(wsSheet, startRow, endRow, col) & "]," & vbCrLf
   ...
   json = json & "  }," & vbCrLf

3. Add corresponding JavaScript in index.html to consume the new fields


Changing row offsets (after Excel layout changes):

1. Find the section's comment block in the VBA (clearly labeled with row/column mappings)
2. Update the startRow and endRow in the ReadRow/ReadRowDec/etc. calls
3. Update the comment block to match the new row numbers


Updating for a new fiscal year:

1. Update fy26Months array (lines 210-222) -- see "Verification Logic" above
2. Optionally rename JSON keys (e.g., fy26 to fy27, fy25gas to fy26gas)
3. If you rename keys, update all references in index.html's JavaScript
4. Update the month labels and title in index.html (see Architecture Reference)


Testing the macro:

1. Open the workbook, press Alt+F8, run ExportDataJSON
2. Open the generated data.json in a text editor or online JSON validator (e.g., jsonlint.com)
3. Spot-check a few values against the Excel cells
4. Review the verification section in the message box output
5. If the file looks correct, upload it to GitHub to update the live dashboard

WATER CONSERVATION MEETING DASHBOARD -- ARCHITECTURE REFERENCE
================================================================

Technical deep dive for the developer who will maintain or extend the WSU Water Conservation Meeting Dashboard.


SYSTEM ARCHITECTURE
-------------------

SkySpark (Haxall platform)
      |
      | SkySpark data export (2 JSON files: domestic_water.json, irrigation.json)
      v
data/ folder (shared with Campus Metering Dashboard)
      |
      | GitHub push / file upload (manual step)
      v
GitHub Repository (main branch)
      |
      | GitHub Pages (automatic deployment)
      v
water-conservation.html (fetches 2 JSON files, detects anomalies, manages tasks)
      |
      v
Browser (Chart.js charts, anomaly detection, task management via localStorage)
      |
      | CSV export (manual download)
      v
Smartsheet (external task tracking -- file-based round-trip)

No build step. No Node.js, no bundler, no package.json.


MEETING WORKFLOW
-----------------

  Before meeting:   Export CSV from Smartsheet > Upload to dashboard ("Import")
  During meeting:   Review anomalies tab > create/edit tasks > discuss assignments
  After meeting:    Export CSV from dashboard > Upload to Smartsheet

The dashboard serves as the meeting's single screen, replacing the old workflow of
a SkySpark report + Smartsheet table viewed side by side.


FILE LOCATIONS
--------------

GitHub repository:
  https://github.com/JSWSU/wsu-energy-dashboard

Live dashboard:
  https://jswsu.github.io/wsu-energy-dashboard/water-conservation.html  (password: Energy@WSU)


DATA FILES
----------

File                       Content                              Shared With
----                       -------                              -----------
data/domestic_water.json   Building-level domestic water (gal)  Campus Metering Dashboard
data/irrigation.json       Building-level irrigation water (gal) Campus Metering Dashboard

Row format: { bldgNo, bldgName, meters, startDate (MM-DD-YYYY), endDate, usage (gallons) }
Data period: 14 months (Jan 2025 -- Feb 2026)
Conversion: All values converted from gallons to kGal on load.


FILE-BY-FILE BREAKDOWN
-----------------------

water-conservation.html (~2,000 lines, single-file SPA)
.......................................................

Section            Contents
-------            --------
<style> block      CSS variables, layout, sortable headers, filter menus, severity colors, task editing, modals
<body> HTML        Auth gate, loading spinner, header, 4 tab sections, print summary, modal, footer
<script> block     Constants, helpers, auth, dark mode, tabs, data loading, anomaly detection, task CRUD,
                   Smartsheet import/export, render functions, column sort/filter, event handlers


AUTHENTICATION MODEL
--------------------

Type:              Client-side password gate
Password:          Energy@WSU (hardcoded in JS)
Storage:           localStorage key: wsuMeteringAuth
Persistence:       Persists across tabs and browser sessions
Security level:    DETERRENT ONLY


TAB SYSTEM
----------

4 tabs managed by click handlers:

Tab ID        Tab Name           Content
------        --------           -------
anomalies     Anomaly Review     KPI cards, detected anomalies table with sort/filter/expand, task creation
tasks         Task Tracker       Editable task table, status filters, search, Smartsheet import/export
trends        Historical Trends  Campus domestic + irrigation line charts with anomaly markers; top 10 bar chart
buildings     Building Index     Searchable card grid; domestic + irrigation badges; expandable monthly detail


KPI CARDS
---------

4 cards on the Anomaly Review tab (always show unfiltered totals):

Card                          What It Shows
----                          -------------
Domestic Spike Anomalies      Count of domestic water spikes (>100% deviation)
Irrigation Spike Anomalies    Count of irrigation spikes (>100% deviation, excl. irrigation season)
Winter Irrigation Alerts      Count of irrigation usage during Nov-Feb
Open Tasks                    Count of tasks with "Open" status prefix


CHART.JS CONFIGURATION
-----------------------

Version: 4.4.7, loaded locally as chart.umd.min.js

Chart instances:

Canvas ID              Type              Tab          Description
---------              ----              ---          -----------
chartDomTrend          Line + anomalies  Trends       Campus domestic water trend (14 months)
chartIrrigTrend        Line + anomalies  Trends       Campus irrigation trend (14 months)
chartTopWater          Horiz stacked bar Trends       Top 10 buildings by total water (domestic + irrigation)
anomChart-{i}          Line              Anomalies    Per-building monthly usage (created on row expand)

Color palette:
  domestic    #3b82f6    Blue for domestic water
  irrigation  #22c55e    Green for irrigation


ANOMALY DETECTION
-----------------

Three types of anomaly detection:

1. Building-Level Spike Detection
   Function: detectBuildingAnomalies(byBldg, monthKeys, service)
   Algorithm:
     - For each building and each month (except first/last):
       - Compare usage to average of neighbor months (month-1, month+1)
       - Skip zero values and months with no valid neighbors
       - Flag if deviation > 100% above average (positive spikes only)
     - IRRIGATION SEASON EXCLUSION: Spikes on irrigation meters during May-Sep
       are skipped because usage ramp-up is expected during irrigation season
   Output: { bldgNo, bldgName, service, meter, month, usage, baseline, deviation, type:'spike' }

2. Winter Irrigation Detection
   Function: detectWinterIrrigation(byBldg, monthKeys)
   Algorithm:
     - For each building and each winter month (Nov, Dec, Jan, Feb):
       - If irrigation usage > 0: flag as winter irrigation
   Output: { bldgNo, bldgName, service:'Irrigation Water', meter, month, usage, baseline:0, deviation:null, type:'winter_irrigation' }

3. Campus-Level Anomaly Detection (for chart markers)
   Function: detectCampusAnomalies(campusData, monthKeys, byBldg)
   Algorithm:
     - Same as building spike detection but on campus totals
     - Identifies top-contributing building for each campus spike
   Used by: Trend chart anomaly callout plugin

Constants:
  IRRIGATION_SEASON = [5, 6, 7, 8, 9]    May through September
  WINTER_MONTHS = [11, 12, 1, 2]          November through February


ANOMALY TABLE FEATURES
-----------------------

Severity Color Coding:
  Red left border     -- deviation > 200% (high severity spike)
  Orange left border  -- deviation 100-200% (medium severity spike)
  Green left border   -- winter irrigation alert

Expandable Rows:
  Click any anomaly row to expand a panel showing:
  - Line chart of that building's monthly usage (anomaly month highlighted with red dot)
  - Data table with Usage (kGal) per month and Month-over-Month % change
  - Anomaly month column highlighted in red in both chart and table

Sortable Column Headers:
  Click any header to sort ascending/descending (toggles on repeated clicks).
  Numeric columns (Usage, Baseline, Deviation) default to descending.
  Month column sorts chronologically.

Per-Column Filter Dropdowns:
  Filterable columns: Bldg #, Building Name, Type, Service, Month
  Click the hamburger icon (three lines) to open a checkbox dropdown.
  Check/uncheck values to filter. Apply to commit, Clear to reset.
  Active filters highlighted with colored button and italic header.

Service/Type Filter Bar:
  Quick-filter buttons above the table:
  All Services | Domestic Water | Irrigation Water | Spikes Only | Winter Irrigation Only

Count Display:
  Heading shows "(X of Y shown)" when filters are active.


TASK MANAGEMENT SYSTEM
-----------------------

All tasks stored in browser localStorage (persists across refreshes, works offline).

localStorage Keys:
  wsu_water_tasks          -- JSON array of all task objects
  wsu_water_task_counter   -- Integer counter for Issue ID generation

Task Data Model (matches Smartsheet columns):

Field            Type      Description
-----            ----      -----------
issueId          String    Auto-generated: WC-YYYY-NNN (e.g., WC-2025-001)
entryDate        String    Date created (MM/DD/YY)
status           String    One of 5 Smartsheet-matching statuses (see below)
wo               String    Work order number (free text, can be "NA" or empty)
actionNote       String    Ongoing updates / resolution notes (editable)
service          String    "Domestic Water" or "Irrigation Water"
bldgNo           String    Building code (e.g., "0078A")
meterId          String    Meter identifier (e.g., "0078_DW_001")
bldgName         String    Full building name
description      String    Original issue description (set at creation)
assignedTo       String    Person(s) assigned (free text, comma-separated)

Status Values (match Smartsheet exactly):
  Open - Not Started
  Open - In Progress
  Open - Monitor
  Closed - Resolved
  Closed - Not Resolved

CRUD Functions:
  loadTasks()              -- Read all tasks from localStorage
  saveTasks(tasks)         -- Write tasks to localStorage
  createTask(anomaly,opts) -- Create task from anomaly with auto-generated Issue ID
  updateTask(id, updates)  -- Update fields by Issue ID
  deleteTask(id)           -- Remove task by Issue ID
  getNextIssueId()         -- Generate next WC-YYYY-NNN identifier

Task Tracker Tab Features:
  - Status filter buttons (All, Not Started, In Progress, Monitor, Resolved, Not Resolved)
  - Status count pills showing task distribution
  - Search by building, meter, assignee, description, or Issue ID
  - Inline editing: status dropdown, contenteditable fields for Assigned To, Action Note, WO#
  - Edit modal for full task editing
  - Delete with confirmation prompt


SMARTSHEET CSV ROUND-TRIP
--------------------------

Import (Smartsheet CSV to Dashboard):
  Function: importSmartsheetCSV(text)
  1. Parse CSV with 11 columns matching task data model
  2. Auto-correct Building Number from MeterID prefix:
     - Regex: /^(\d{4}[A-Z]?)(?:_?(?:DW|IR|CIR))/i
     - Example: 0180ADW_001 -> 0180A
  3. Merge logic:
     - Match by Issue ID first (exact match)
     - Fallback: match by building + meter + entry date
     - Matched: update changed fields (Smartsheet wins)
     - No match: create new task with auto-generated Issue ID
     - Dashboard-only tasks: kept as-is (new from current meeting)
  4. Return summary: { total, updated, created, unchanged }

Export (Dashboard to Smartsheet CSV):
  Function: exportSmartsheetCSV()
  1. Load all tasks from localStorage
  2. Map to CSV with exact Smartsheet column headers:
     Issue ID, Entry Date, Status, WO#, Action Note, Utility Type,
     Building Number, MeterID, Building Name, Action / Description, Assigned To
  3. Escape cells (quote if contains comma, newline, or double quote)
  4. Trigger browser download: water_conservation_tasks_YYYY-MM-DD.csv


DARK MODE
---------

Toggle:        Slider switch in header ("Dark Mode" label + sliding dot)
Storage:       localStorage key: wsuDarkMode (values: 'on' / 'off')
Persistence:   Persists across sessions and page refreshes
Implementation: Toggles html.dark class; rebuilds charts via applyChartTheme()


PRINT OPTIMIZATION
-------------------

Print layout (via @media print) shows meeting minutes:
  - Dashboard title and current date
  - Anomaly review table (cloned from current view)
  - Open tasks table (filtered to open items only)
  - Signature line for meeting notes

Landscape orientation, 0.5in margins, light theme forced.
Hidden on print: header, auth gate, nav tabs, dark toggle, modals.


GLOBAL STATE
-------------

Variable          Type      Description
--------          ----      -----------
G_anomalies       Array     All detected anomalies (spikes + winter irrigation)
G_domByBldg       Object    Domestic water aggregated by building { bldgNo: { total, months } }
G_irrigByBldg     Object    Irrigation aggregated by building (same structure)
G_months          Array     Sorted month keys ["2025-01", "2025-02", ...]
G_monthLabels     Array     Formatted labels ["Jan 25", "Feb 25", ...]
chartInstances    Array     All Chart.js instances for dark mode syncing
anomalyCharts     Array     Mini-chart instances in expanded anomaly rows
anomalySortCol    String    Current sort column key (null = default sort)
anomalySortDir    String    'asc' or 'desc'
anomalyColFilters Object    Per-column filter state { colKey: Set of allowed values }
currentFilter     String    Active task tracker filter status
currentAnomalyFilter String Active anomaly filter bar selection


EXTERNAL DEPENDENCIES
---------------------

Dependency     Version   Source                         Purpose
----------     -------   ------                         -------
Chart.js       4.4.7     Local file (chart.umd.min.js)  All charts and visualizations
GitHub Pages   --        github.com                     Static site hosting

No other dependencies. No CSS framework, no JS framework, no build tools.


KNOWN LIMITATIONS
------------------

Issue                                         Impact                                      Mitigation
-----                                         ------                                      ----------
Tasks stored in browser localStorage          Tasks lost if browser data cleared           Export to CSV before clearing; import on next session
No real-time Smartsheet sync                  Manual file handoff required                 CSV round-trip before/after each meeting
No multi-user collaboration                   Only one person can edit tasks at a time     Export/import serializes changes
Anomaly threshold hardcoded at 100%           May miss moderate spikes                     Adjust threshold constant if needed
Irrigation season months hardcoded            May need adjustment for climate changes      Update IRRIGATION_SEASON array

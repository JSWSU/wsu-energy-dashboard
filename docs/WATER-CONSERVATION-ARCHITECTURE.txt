WATER CONSERVATION MEETING DASHBOARD -- ARCHITECTURE REFERENCE
================================================================

Technical deep dive for the developer who will maintain or extend the WSU Water Conservation Meeting Dashboard.


SYSTEM ARCHITECTURE
-------------------

SkySpark (Haxall platform)
      |
      | SkySpark data export (2 JSON files: domestic_water.json, irrigation.json)
      v
data/ folder (shared with Campus Metering Dashboard)
      |
      | GitHub push / file upload (manual step)
      v
GitHub Repository (main branch)
      |
      | GitHub Pages (automatic deployment)
      v
water-conservation.html (fetches 2 JSON files, detects anomalies, manages tasks)
      |
      v
Browser (Chart.js charts, anomaly detection, task management via localStorage)
      |
      | CSV export (manual download)
      v
Smartsheet (external task tracking -- file-based round-trip)

No build step. No Node.js, no bundler, no package.json.


MEETING WORKFLOW
-----------------

  Before meeting:   Export CSV from Smartsheet > Upload to dashboard ("Import")
  During meeting:   Review anomalies tab > create/edit tasks > discuss assignments
  After meeting:    Export CSV from dashboard > Upload to Smartsheet

The dashboard serves as the meeting's single screen, replacing the old workflow of
a SkySpark report + Smartsheet table viewed side by side.


FILE LOCATIONS
--------------

GitHub repository:
  https://github.com/JSWSU/wsu-energy-dashboard

Live dashboard:
  https://jswsu.github.io/wsu-energy-dashboard/water-conservation.html  (password: Energy@WSU)


DATA FILES
----------

File                       Content                              Shared With
----                       -------                              -----------
data/domestic_water.json   Building-level domestic water (gal)  Campus Metering Dashboard
data/irrigation.json       Building-level irrigation water (gal) Campus Metering Dashboard

Row format: { bldgNo, bldgName, meters, startDate (MM-DD-YYYY), endDate, usage (gallons) }
Data period: 26 months (Jan 2024 -- Feb 2026)
Conversion: All values converted from gallons to kGal on load.


FILE-BY-FILE BREAKDOWN
-----------------------

water-conservation.html (~3,100 lines, single-file SPA)
.......................................................

Section            Contents
-------            --------
<style> block      CSS variables, layout, sortable headers, filter menus, severity colors, task status
                   badges, task editing, modals, help tab styles
<body> HTML        Auth gate, loading spinner, header, 5 tab sections, print summary, modal, footer
<script> block     Constants, helpers, auth, dark mode, tabs, data loading, anomaly detection, task CRUD,
                   task-anomaly matching, Smartsheet import/export, render functions, column sort/filter,
                   event handlers


AUTHENTICATION MODEL
--------------------

Type:              Client-side password gate
Password:          Energy@WSU (hardcoded in JS)
Storage:           localStorage key: wsuMeteringAuth
Persistence:       Persists across tabs and browser sessions
Security level:    DETERRENT ONLY


TAB SYSTEM
----------

5 tabs managed by click handlers:

Tab ID        Tab Name           Content
------        --------           -------
anomalies     Anomaly Review     KPI cards, all-sites table with anomaly toggle, sort/filter/expand, task status, task creation
tasks         Task Tracker       Editable task table, status filters, search, Smartsheet import/export
trends        Historical Trends  Campus domestic + irrigation line charts with anomaly markers; top 10 bar chart
buildings     Building Index     Searchable card grid; domestic + irrigation badges; expandable monthly detail
help          How to Use         Static SOP / in-app manual with 7 sections (no JavaScript needed)


KPI CARDS
---------

4 cards on the Anomaly Review tab (always show unfiltered totals):

Card                          What It Shows
----                          -------------
Domestic Spike Anomalies      Count of domestic water spikes (>100% deviation)
Irrigation Spike Anomalies    Count of irrigation spikes (>100% deviation vs prior-year same month)
Winter Irrigation Alerts      Count of irrigation usage during Nov-Feb
Open Tasks                    Count of tasks with "Open" status prefix


CHART.JS CONFIGURATION
-----------------------

Version: 4.4.7, loaded locally as chart.umd.min.js

Chart instances:

Canvas ID              Type              Tab          Description
---------              ----              ---          -----------
chartDomTrend          Line + anomalies  Trends       Campus domestic water trend (26 months)
chartIrrigTrend        Line + anomalies  Trends       Campus irrigation trend (26 months)
chartTopWater          Horiz stacked bar Trends       Top 10 buildings by total water (domestic + irrigation)
anomChart-{i}          Line              Anomalies    Per-building monthly usage (created on row expand)

Color palette:
  domestic    #3b82f6    Blue for domestic water
  irrigation  #22c55e    Green for irrigation


ANOMALY DETECTION
-----------------

Detection runs only on the most recent 3 months of data to focus on actionable issues.

Two types of anomaly detection:

1. Building-Level Spike Detection (Year-over-Year)
   Function: detectBuildingAnomaliesYoY(byBldg, recentMonths, allMonths, service)
   Algorithm:
     - For each building and each recent month:
       - Compare usage to the average of the SAME CALENDAR MONTH in all prior years
       - Example: Feb 2026 is compared to average of Feb 2025 + Feb 2024
       - Skip zero values and months with no prior-year data
       - Flag if deviation > 100% above prior-year average (positive spikes only)
     - Year-over-Year comparison naturally handles university seasonal patterns
       (student move-in/out, irrigation season) without needing explicit exclusions
   Output: { bldgNo, bldgName, service, meter, month, usage, baseline, deviation, type:'spike' }

2. Winter Irrigation Detection
   Function: detectWinterIrrigation(byBldg, monthKeys)
   Algorithm:
     - For each building and each winter month (Nov, Dec, Jan, Feb):
       - If irrigation usage >= 1 kGal: flag as winter irrigation
       - Sub-1 kGal values are ignored (rounding artifacts from meter reads)
   Output: { bldgNo, bldgName, service:'Irrigation Water', meter, month, usage, baseline:0, deviation:null, type:'winter_irrigation' }

3. Campus-Level Anomaly Detection (for chart markers)
   Function: detectCampusAnomalies(campusData, monthKeys, byBldg)
   Algorithm:
     - Same neighbor-month comparison as before, applied to campus totals only
     - Identifies top-contributing building for each campus spike
   Used by: Trend chart anomaly callout plugin (not affected by YoY change)

Constants:
  WINTER_MONTHS = [11, 12, 1, 2]          November through February

Init call:
  const recentMonths = G_months.slice(-3);      // Last 3 months to check
  detectBuildingAnomaliesYoY(byBldg, recentMonths, G_months, service)
  // G_months provides full 26-month history for prior-year lookup


ANOMALY REVIEW TAB (ALL-SITES VIEW)
-------------------------------------

Default view shows ALL building/service combinations, not just anomalies.
An "Anomalies Only" toggle button filters to flagged rows only.

Global state:
  G_allSiteRows     Array of all building+service combinations with anomaly references
  anomalyOnlyMode   Boolean toggle for anomaly-only filtering

All-Sites Row Object:
  { bldgNo, bldgName, service, meters, total,
    anomalies: [...], anomalyCount, hasAnomaly, worstAnomaly }

Table Columns (SITE_COLS):
  Bldg # | Building Name | Service | Anomalies | Type | Month | Usage | Baseline | Deviation | Task Status | Action

Default Sort:
  Anomaly rows first (sorted by deviation descending), then non-anomaly rows by total descending.

Severity Color Coding:
  Red left border     -- deviation > 200% (high severity spike)
  Orange left border  -- deviation 100-200% (medium severity spike)
  Green left border   -- winter irrigation alert
  No border           -- non-anomaly row

Expandable Rows:
  Click any row (anomaly or non-anomaly) to expand a panel showing:
  - Line chart of that building's monthly usage per year (anomaly month highlighted with red dot if applicable)
  - Data table with Usage (kGal) per month per year
  - CY vs PY row showing year-over-year % change per calendar month
  - Anomaly month column highlighted in red in both chart and table (anomaly rows only)

Sortable Column Headers:
  Click any header to sort ascending/descending (toggles on repeated clicks).
  Numeric columns (Usage, Baseline, Deviation) default to descending.
  Month column sorts chronologically.

Per-Column Filter Dropdowns:
  Filterable columns: Bldg #, Building Name, Type, Service, Month, Task Status
  Click the hamburger icon (three lines) to open a checkbox dropdown.
  Search box at top filters checkbox options. Select All / Deselect All buttons.
  Check/uncheck values to filter. Apply to commit, Clear to reset.
  Active filters highlighted with colored button and italic header.

Task Status Column:
  Shows color-coded badge for each anomaly's associated task (or dash if none).
  Badge colors by status:
    Yellow   "Not Started"     (ts-open)
    Blue     "In Progress"     (ts-progress)
    Green    "Monitor"         (ts-monitor)
    Green    "Resolved"        (ts-resolved, with checkmark)
    Gray     "Not Resolved"    (ts-closed)
    Dash     No task assigned  (ts-none)
  Sortable and filterable like other columns.
  Includes both open and closed tasks so full history is visible.

Service/Type Filter Bar:
  Quick-filter buttons above the table:
  All Services | Domestic Water | Irrigation Water | [separator] | Anomalies Only | Spikes Only | Winter Irrigation Only
  "Anomalies Only" button has red styling (border-color: var(--red))
  Heading toggles between "All Sites" and "Detected Anomalies" based on mode

Count Display:
  Heading shows "(X of Y shown)" when filters are active.

Create Task Modal -- Prior Notes:
  When creating a task, the modal shows a read-only info box with prior Smartsheet notes
  for that building/service if any exist (prefers closed tasks for final notes).
  Function: showPriorNotes(bldgNo, service)
  Hidden during edit mode (user already sees the task's own notes).


TASK MANAGEMENT SYSTEM
-----------------------

All tasks stored in browser localStorage (persists across refreshes, works offline).

localStorage Keys:
  wsu_water_tasks          -- JSON array of all task objects
  wsu_water_task_counter   -- Integer counter for Issue ID generation

Task Data Model (matches Smartsheet columns):

Field            Type      Description
-----            ----      -----------
issueId          String    Auto-generated: WC-YYYY-NNN (e.g., WC-2025-001)
entryDate        String    Date created (MM/DD/YY)
status           String    One of 5 Smartsheet-matching statuses (see below)
wo               String    Work order number (free text, can be "NA" or empty)
actionNote       String    Ongoing updates / resolution notes (editable)
service          String    "Domestic Water" or "Irrigation Water"
bldgNo           String    Building code (e.g., "0078A")
meterId          String    Meter identifier (e.g., "0078_DW_001")
bldgName         String    Full building name
description      String    Original issue description (set at creation)
assignedTo       String    Person(s) assigned (free text, comma-separated)

Status Values (match Smartsheet exactly):
  Open - Not Started
  Open - In Progress
  Open - Monitor
  Closed - Resolved
  Closed - Not Resolved

CRUD Functions:
  loadTasks()              -- Read all tasks from localStorage
  saveTasks(tasks)         -- Write tasks to localStorage
  createTask(anomaly,opts) -- Create task from anomaly with auto-generated Issue ID
  updateTask(id, updates)  -- Update fields by Issue ID
  deleteTask(id)           -- Remove task by Issue ID
  getNextIssueId()         -- Generate next WC-YYYY-NNN identifier

Task-Anomaly Matching (for Task Status column and Action buttons):
  Function: taskMatchesAnomaly(task, anomaly)
  Used by: findTaskForAnomaly() and findAnyTaskForAnomaly()
  Layered matching strategy (first match wins):
    1. Exact: bldgNo + service + month label in task description (dashboard-created tasks)
    2. Fallback: bldgNo + service (catches Smartsheet-imported tasks)
    3. Case-insensitive service comparison (handles "Domestic water" vs "Domestic Water")
    4. Meter ID match (if task.meterId matches anomaly.meter)
    5. Empty service tolerance (if Smartsheet Utility Type column was blank)
  findTaskForAnomaly()    -- Returns first open task matching anomaly (excludes closed)
  findAnyTaskForAnomaly() -- Returns any task matching anomaly (prefers open over closed)

Task Tracker Tab Features:
  - Status filter buttons (All, Not Started, In Progress, Monitor, Resolved, Not Resolved)
  - Status count pills showing task distribution
  - Search by building, meter, assignee, description, or Issue ID
  - Inline editing: status dropdown, contenteditable fields for Assigned To, Action Note, WO#
  - Edit modal for full task editing
  - Delete with confirmation prompt


SMARTSHEET CSV ROUND-TRIP
--------------------------

Import (Smartsheet CSV to Dashboard):
  Function: importSmartsheetCSV(text)
  1. Parse CSV with 11 columns matching task data model
  2. Auto-correct Building Number from MeterID prefix:
     - Regex: /^(\d{4}[A-Z]?)(?:_?(?:DW|IR|CIR))/i
     - Example: 0180ADW_001 -> 0180A
  3. Merge logic:
     - Match by Issue ID first (exact match)
     - Fallback: match by building + meter + entry date
     - Matched: update changed fields (Smartsheet wins)
     - No match: create new task with auto-generated Issue ID
     - Dashboard-only tasks: kept as-is (new from current meeting)
  4. Return summary: { total, updated, created, unchanged }

Export (Dashboard to Smartsheet CSV):
  Function: exportSmartsheetCSV()
  1. Load all tasks from localStorage
  2. Map to CSV with exact Smartsheet column headers:
     Issue ID, Entry Date, Status, WO#, Action Note, Utility Type,
     Building Number, MeterID, Building Name, Action / Description, Assigned To
  3. Escape cells (quote if contains comma, newline, or double quote)
  4. Trigger browser download: water_conservation_tasks_YYYY-MM-DD.csv


HOW TO USE TAB
---------------

Static in-app SOP / manual. No JavaScript required -- content is pure HTML
rendered using existing .card and .info-box CSS classes. The tab switcher
handles it dynamically (data-tab="help" -> id="sec-help").

7 content sections:
  1. Meeting Workflow      3-step visual cards (Before / During / After)
  2. Tab Guide             4 cards explaining each functional tab
  3. Anomaly Types         Spike severity colors, YoY methodology, winter alerts
  4. Task Status Guide     5-status reference table matching Smartsheet
  5. Smartsheet Sync       Numbered step-by-step for CSV import/export round-trip
  6. Quick Tips            6 tips for power users (expand rows, sort/filter, print, etc.)
  7. Troubleshooting       5-item FAQ with concise solutions

Help-specific CSS classes:
  .help-section        Section wrapper with bottom margin
  .help-steps          3-column grid for workflow step cards
  .help-step           Individual step card with numbered circle
  .help-tab-cards      2-column grid for tab description cards
  .help-table          Compact reference table (used for status guide, severity legend)
  .help-tip            Icon + text row for quick tips
  .help-faq            Definition list for FAQ items
  .help-sync-steps     CSS-countered ordered list for sync steps

Hidden in print layout (inherits from .section { display: none } in @media print).


DARK MODE
---------

Toggle:        Slider switch in header ("Dark Mode" label + sliding dot)
Storage:       localStorage key: wsuDarkMode (values: 'on' / 'off')
Persistence:   Persists across sessions and page refreshes
Implementation: Toggles html.dark class; rebuilds charts via applyChartTheme()


PRINT OPTIMIZATION
-------------------

Print layout (via @media print) shows meeting minutes:
  - Dashboard title and current date
  - Anomaly review table (cloned from current view)
  - Open tasks table (filtered to open items only)
  - Signature line for meeting notes

Landscape orientation, 0.5in margins, light theme forced.
Hidden on print: header, auth gate, nav tabs, dark toggle, modals.


GLOBAL STATE
-------------

Variable          Type      Description
--------          ----      -----------
G_anomalies       Array     All detected anomalies (spikes + winter irrigation, last 3 months only)
G_allSiteRows     Array     All building+service combinations with anomaly references
G_domByBldg       Object    Domestic water aggregated by building { bldgNo: { total, months } }
G_irrigByBldg     Object    Irrigation aggregated by building (same structure)
G_months          Array     Sorted month keys ["2024-01", "2024-02", ..., "2026-02"]
G_monthLabels     Array     Formatted labels ["Jan 24", "Feb 24", ...]
G_years           Array     Sorted unique years [2024, 2025, 2026]
chartInstances    Array     All Chart.js instances for dark mode syncing
anomalyCharts     Array     Mini-chart instances in expanded anomaly rows
anomalySortCol    String    Current sort column key (null = default sort)
anomalySortDir    String    'asc' or 'desc'
anomalyColFilters Object    Per-column filter state { colKey: Set of allowed values }
anomalyOnlyMode   Boolean   Whether "Anomalies Only" toggle is active
currentFilter     String    Active task tracker filter status
currentAnomalyFilter String Active anomaly filter bar selection


EXTERNAL DEPENDENCIES
---------------------

Dependency     Version   Source                         Purpose
----------     -------   ------                         -------
Chart.js       4.4.7     Local file (chart.umd.min.js)  All charts and visualizations
GitHub Pages   --        github.com                     Static site hosting

No other dependencies. No CSS framework, no JS framework, no build tools.


KNOWN LIMITATIONS
------------------

Issue                                         Impact                                      Mitigation
-----                                         ------                                      ----------
Tasks stored in browser localStorage          Tasks lost if browser data cleared           Export to CSV before clearing; import on next session
No real-time Smartsheet sync                  Manual file handoff required                 CSV round-trip before/after each meeting
No multi-user collaboration                   Only one person can edit tasks at a time     Export/import serializes changes
Anomaly threshold hardcoded at 100%           May miss moderate spikes                     Adjust threshold constant if needed
YoY needs prior-year data for same month      New calendar months have no baseline         Will improve as data history grows

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WSU Campus Metering Dashboard</title>
<script src="chart.umd.min.js"></script>
<style>
  :root {
    --primary: #981e32;
    --primary-dark: #7a1828;
    --secondary: #5f6b6d;
    --accent: #c69214;
    --bg: #f5f5f5;
    --card-bg: #fff;
    --text: #2d2d2d;
    --text-light: #6b7280;
    --border: #e5e7eb;
    --green: #059669;
    --red: #dc2626;
    --blue: #2563eb;
    --table-head-bg: #f9fafb;
    --table-hover: #f9fafb;
    --total-row-bg: #f0f4ff;
    --info-bg: #f0f9ff;
    --info-border: #bae6fd;
    --info-text: #0c4a6e;
    /* Utility colors */
    --clr-electric: #f59e0b;
    --clr-steam: #ef4444;
    --clr-chw-energy: #06b6d4;
    --clr-domestic: #3b82f6;
    --clr-irrigation: #22c55e;
    --clr-chw-water: #8b5cf6;
    --mini-row-border: #f3f4f6;
  }
  html.dark {
    --bg: #111827;
    --card-bg: #1f2937;
    --text: #e5e7eb;
    --text-light: #9ca3af;
    --border: #374151;
    --secondary: #9ca3af;
    --green: #34d399;
    --red: #f87171;
    --table-head-bg: #1a2332;
    --table-hover: #253347;
    --total-row-bg: #1e293b;
    --info-bg: #1e293b;
    --info-border: #334155;
    --info-text: #7dd3fc;
    --mini-row-border: #253347;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg); color: var(--text); line-height: 1.5;
  }
  header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: #fff; padding: 1.5rem 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    display: flex; align-items: center; justify-content: space-between; gap: 1rem;
  }
  .header-text { flex: 1; min-width: 0; }
  .header-text h1 { font-size: 1.6rem; font-weight: 700; }
  .header-text p { opacity: 0.85; font-size: 0.9rem; margin-top: 0.25rem; }
  .header-actions { display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0; }
  .header-actions a {
    color: rgba(255,255,255,0.85); text-decoration: none; font-size: 0.82rem;
    padding: 0.4rem 0.8rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px;
    transition: all 0.2s;
  }
  .header-actions a:hover { background: rgba(255,255,255,0.1); color: #fff; }
  .btn-icon {
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.25);
    color: #fff; border-radius: 6px; padding: 0.4rem 0.6rem; cursor: pointer;
    font-size: 1rem; transition: all 0.2s;
  }
  .btn-icon:hover { background: rgba(255,255,255,0.2); }
  .container { max-width: 1440px; margin: 0 auto; padding: 1.5rem; }
  /* Nav Tabs */
  .nav-tabs {
    display: flex; gap: 0.25rem; background: var(--card-bg); border-radius: 8px;
    padding: 0.25rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); overflow-x: auto;
  }
  .nav-tab {
    padding: 0.6rem 1.2rem; border: none; background: transparent; border-radius: 6px;
    cursor: pointer; font-size: 0.85rem; font-weight: 500; color: var(--text-light);
    white-space: nowrap; transition: all 0.2s;
  }
  .nav-tab:hover { background: var(--table-hover); color: var(--text); }
  .nav-tab.active { background: var(--primary); color: #fff; }
  /* KPI */
  .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
  .kpi-card {
    background: var(--card-bg); border-radius: 10px; padding: 1.25rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08); border-left: 4px solid var(--primary);
    cursor: pointer; transition: box-shadow 0.2s ease, transform 0.15s ease; position: relative;
  }
  .kpi-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.12); transform: translateY(-2px); }
  .kpi-label { font-size: 0.78rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em; }
  .kpi-value { font-size: 1.8rem; font-weight: 700; margin: 0.25rem 0; }
  .kpi-sub { font-size: 0.8rem; color: var(--text-light); }
  .kpi-tooltip {
    visibility: hidden; opacity: 0; position: absolute; bottom: calc(100% + 8px); left: 50%;
    transform: translateX(-50%); background: #1f2937; color: #fff; font-size: 0.75rem;
    line-height: 1.4; padding: 0.5rem 0.75rem; border-radius: 6px; white-space: normal;
    width: max-content; max-width: 260px; z-index: 100; pointer-events: none;
    transition: opacity 0.2s ease, visibility 0.2s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .kpi-tooltip::after {
    content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
    border: 6px solid transparent; border-top-color: #1f2937;
  }
  .kpi-card:hover .kpi-tooltip { visibility: visible; opacity: 1; }
  .kpi-expand {
    max-height: 0; overflow: hidden;
    transition: max-height 0.35s ease, margin-top 0.35s ease, opacity 0.25s ease;
    opacity: 0; margin-top: 0;
  }
  .kpi-card.expanded .kpi-expand { max-height: 500px; opacity: 1; margin-top: 0.75rem; }
  .kpi-card.expanded { box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
  .kpi-expand-icon {
    position: absolute; top: 0.75rem; right: 0.75rem; font-size: 0.7rem;
    color: var(--text-light); transition: transform 0.3s ease;
  }
  .kpi-card.expanded .kpi-expand-icon { transform: rotate(180deg); }
  .kpi-mini-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
  .kpi-mini-table th {
    text-align: left; font-weight: 600; color: var(--secondary); padding: 0.3rem 0.5rem;
    border-bottom: 2px solid var(--border); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.03em;
  }
  .kpi-mini-table th:not(:first-child) { text-align: right; }
  .kpi-mini-table td { padding: 0.25rem 0.5rem; border-bottom: 1px solid var(--mini-row-border); }
  .kpi-mini-table td:not(:first-child) { text-align: right; font-variant-numeric: tabular-nums; }
  .kpi-mini-table tr:last-child { font-weight: 700; border-top: 2px solid var(--primary); }
  .kpi-mini-table tr:last-child td { border-bottom: none; padding-top: 0.4rem; }
  .kpi-card.electric { border-left-color: var(--clr-electric); }
  .kpi-card.steam { border-left-color: var(--clr-steam); }
  .kpi-card.chw-energy { border-left-color: var(--clr-chw-energy); }
  .kpi-card.domestic { border-left-color: var(--clr-domestic); }
  .kpi-card.irrigation { border-left-color: var(--clr-irrigation); }
  .kpi-card.chw-water { border-left-color: var(--clr-chw-water); }
  .kpi-card.ok { border-left-color: var(--green); }
  .kpi-card.fault { border-left-color: var(--red); }
  /* Cards */
  .card {
    background: var(--card-bg); border-radius: 10px; padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 1.5rem;
  }
  .card h2 {
    font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary);
    display: flex; align-items: center; gap: 0.5rem;
  }
  html.dark .card h2 { color: var(--clr-electric); }
  .chart-container { position: relative; height: 350px; width: 100%; }
  .chart-container.tall { height: 550px; }
  .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
  @media (max-width: 900px) { .chart-row { grid-template-columns: 1fr; } }
  /* Tables */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
  thead th {
    background: var(--table-head-bg); padding: 0.6rem 0.75rem; text-align: right;
    font-weight: 600; color: var(--secondary); border-bottom: 2px solid var(--border); white-space: nowrap;
  }
  thead th:first-child, thead th:nth-child(2) { text-align: left; }
  tbody td { padding: 0.5rem 0.75rem; text-align: right; border-bottom: 1px solid var(--border); }
  tbody td:first-child, tbody td:nth-child(2) { text-align: left; }
  tbody tr:hover { background: var(--table-hover); }
  tbody tr.total-row { font-weight: 700; background: var(--total-row-bg); border-top: 2px solid var(--primary); }
  /* Sections */
  .section { display: none; }
  .section.active { display: block; }
  /* Search */
  .search-bar {
    width: 100%; padding: 0.65rem 1rem; border: 2px solid var(--border); border-radius: 8px;
    font-size: 0.9rem; outline: none; transition: border-color 0.2s;
    background: var(--card-bg); color: var(--text); margin-bottom: 1rem;
  }
  .search-bar:focus { border-color: var(--primary); }
  .search-bar::placeholder { color: var(--text-light); }
  /* Filter buttons */
  .filter-bar { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
  .filter-btn {
    padding: 0.4rem 0.9rem; border: 1px solid var(--border); background: var(--card-bg);
    border-radius: 6px; font-size: 0.82rem; cursor: pointer; color: var(--text); transition: all 0.2s;
  }
  .filter-btn:hover { border-color: var(--primary); }
  .filter-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
  /* Status dots */
  .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 0.4rem; }
  .dot.ok { background: var(--green); }
  .dot.fault { background: var(--red); }
  .dot.disabled { background: var(--text-light); }
  /* Building cards */
  .bldg-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 1rem; }
  .bldg-card {
    background: var(--card-bg); border-radius: 10px; padding: 1rem 1.25rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08); border-left: 4px solid var(--primary);
    cursor: pointer; transition: box-shadow 0.2s, transform 0.15s;
  }
  .bldg-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.12); transform: translateY(-2px); }
  .bldg-card h3 { font-size: 0.95rem; font-weight: 600; margin-bottom: 0.25rem; }
  .bldg-card .bldg-no { font-size: 0.78rem; color: var(--text-light); }
  .bldg-badges { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-top: 0.5rem; }
  .badge {
    font-size: 0.7rem; padding: 0.15rem 0.5rem; border-radius: 4px; font-weight: 600;
    color: #fff;
  }
  .badge.electric { background: var(--clr-electric); }
  .badge.steam { background: var(--clr-steam); }
  .badge.chw-energy { background: var(--clr-chw-energy); }
  .badge.domestic { background: var(--clr-domestic); }
  .badge.irrigation { background: var(--clr-irrigation); }
  .badge.chw-water { background: var(--clr-chw-water); }
  /* Detail expand */
  .bldg-detail {
    max-height: 0; overflow: hidden; transition: max-height 0.35s ease;
    margin-top: 0; font-size: 0.82rem;
  }
  .bldg-card.expanded .bldg-detail { max-height: 600px; margin-top: 0.75rem; }
  .bldg-detail table { font-size: 0.78rem; }
  /* Info box */
  .info-box {
    background: var(--info-bg); border: 1px solid var(--info-border); border-radius: 8px;
    padding: 1rem 1.25rem; font-size: 0.82rem; color: var(--info-text); margin-bottom: 1rem;
  }
  .info-box code {
    background: rgba(0,0,0,0.06); padding: 0.1rem 0.4rem; border-radius: 3px;
    font-size: 0.78rem; font-family: 'Courier New', monospace;
  }
  html.dark .info-box code { background: rgba(255,255,255,0.08); }
  /* Verification Badge */
  .verified-badge {
    display: inline-flex; align-items: center; gap: 0.3rem;
    padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.72rem; font-weight: 600;
    white-space: nowrap;
  }
  .verified-badge.pass { background: #ecfdf5; color: #059669; }
  .verified-badge.warn { background: #fffbeb; color: #92400e; }
  .verified-badge.fail { background: #fef2f2; color: #991b1b; }
  html.dark .verified-badge.pass { background: #064e3b; color: #34d399; }
  html.dark .verified-badge.warn { background: #78350f; color: #fbbf24; }
  html.dark .verified-badge.fail { background: #7f1d1d; color: #f87171; }
  /* Data Quality Panel */
  .dq-summary { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; }
  .dq-stat { padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.78rem; font-weight: 600; }
  .dq-stat.pass { background: #ecfdf5; color: #059669; }
  .dq-stat.warn { background: #fffbeb; color: #92400e; }
  .dq-stat.fail { background: #fef2f2; color: #991b1b; }
  html.dark .dq-stat.pass { background: #064e3b; color: #34d399; }
  html.dark .dq-stat.warn { background: #78350f; color: #fbbf24; }
  html.dark .dq-stat.fail { background: #7f1d1d; color: #f87171; }
  .dq-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 0.75rem; }
  .dq-table th { text-align: left; padding: 0.4rem 0.6rem; border-bottom: 2px solid var(--border); color: var(--secondary); font-weight: 600; font-size: 0.75rem; }
  .dq-table td { padding: 0.35rem 0.6rem; border-bottom: 1px solid var(--border); }
  .dq-table td:first-child { font-weight: 500; }
  .dq-icon { display: inline-block; width: 16px; text-align: center; }
  .dq-icon.pass { color: #059669; }
  .dq-icon.warn { color: #d97706; }
  .dq-icon.fail { color: #dc2626; }
  .dq-kpi-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 0.75rem; }
  .dq-kpi-table th { text-align: right; padding: 0.4rem 0.6rem; border-bottom: 2px solid var(--border); color: var(--secondary); font-weight: 600; font-size: 0.75rem; }
  .dq-kpi-table th:first-child { text-align: left; }
  .dq-kpi-table td { text-align: right; padding: 0.35rem 0.6rem; border-bottom: 1px solid var(--border); }
  .dq-kpi-table td:first-child { text-align: left; font-weight: 500; }
  .dq-match { color: var(--green); font-weight: 600; }
  .dq-mismatch { color: var(--red); font-weight: 600; }
  /* Loading */
  #loading {
    position: fixed; inset: 0; background: var(--bg);
    display: flex; align-items: center; justify-content: center; z-index: 9999;
    flex-direction: column; gap: 1rem;
  }
  .spinner {
    width: 40px; height: 40px; border: 4px solid var(--border);
    border-top-color: var(--primary); border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  /* Auth Gate */
  #authGate {
    position: fixed; inset: 0; z-index: 99999; background: var(--bg);
    display: flex; align-items: center; justify-content: center; flex-direction: column;
  }
  #authGate .auth-header {
    position: absolute; top: 0; left: 0; right: 0;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: #fff; padding: 1.5rem 2rem; text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  #authGate .auth-header h1 { font-size: 1.4rem; font-weight: 700; }
  #authGate .auth-header p { opacity: 0.85; font-size: 0.85rem; margin-top: 0.25rem; }
  #authGate .auth-card {
    background: var(--card-bg); border-radius: 12px; padding: 2.5rem 2rem;
    box-shadow: 0 4px 24px rgba(0,0,0,0.1); text-align: center;
    width: 100%; max-width: 380px; margin-top: 60px;
  }
  #authGate .auth-card h2 { font-size: 1.1rem; color: var(--text); margin-bottom: 0.5rem; }
  #authGate .auth-card p { font-size: 0.82rem; color: var(--text-light); margin-bottom: 1.5rem; }
  #authGate .auth-input {
    width: 100%; padding: 0.75rem 1rem; border: 2px solid var(--border); border-radius: 8px;
    font-size: 0.95rem; outline: none; transition: border-color 0.2s;
    background: var(--card-bg); color: var(--text);
  }
  #authGate .auth-input:focus { border-color: var(--primary); }
  #authGate .auth-btn {
    width: 100%; padding: 0.75rem; margin-top: 1rem; border: none; border-radius: 8px;
    background: var(--primary); color: #fff; font-size: 0.95rem; font-weight: 600;
    cursor: pointer; transition: background 0.2s;
  }
  #authGate .auth-btn:hover { background: var(--primary-dark); }
  #authGate .auth-error { color: var(--red); font-size: 0.8rem; margin-top: 0.75rem; min-height: 1.2rem; }
  html.dark #authGate .auth-input { background: var(--bg); color: var(--text); border-color: var(--border); }
  /* Footer */
  footer {
    text-align: center; padding: 1.5rem; color: var(--text-light); font-size: 0.78rem;
    border-top: 1px solid var(--border); margin-top: 2rem;
  }
  footer a { color: var(--primary); text-decoration: none; }
  footer a:hover { text-decoration: underline; }
  /* Print */
  @media print {
    @page { size: landscape; margin: 0.5in; }
    * { print-color-adjust: exact !important; -webkit-print-color-adjust: exact !important; }
    body { background: #fff !important; }
    html.dark { --bg:#f5f5f5; --card-bg:#fff; --text:#2d2d2d; --text-light:#6b7280; --border:#e5e7eb; }
    header, #authGate, #loading, .nav-tabs, .search-bar, .filter-bar, .btn-icon, .header-actions { display: none !important; }
    .section { display: block !important; page-break-inside: avoid; }
    .card { box-shadow: none; border: 1px solid #e5e7eb; }
  }
</style>
</head>
<body>

<!-- Auth Gate -->
<div id="authGate">
  <div class="auth-header">
    <h1>WSU Campus Metering</h1>
    <p>Campus Metering Dashboard &bull; WSU Facilities Services</p>
  </div>
  <div class="auth-card">
    <h2>Restricted Access</h2>
    <p>Enter the dashboard password to continue.</p>
    <input type="password" class="auth-input" id="authInput" placeholder="Password" autocomplete="off">
    <button class="auth-btn" id="authBtn">Sign In</button>
    <div class="auth-error" id="authError"></div>
  </div>
</div>

<!-- Loading -->
<div id="loading">
  <div class="spinner"></div>
  <div style="color:var(--text-light); font-size:0.9rem;">Loading metering data...</div>
</div>

<!-- Header -->
<header>
  <div class="header-text">
    <h1>WSU Campus Metering Dashboard</h1>
    <p>Jan 2025 &ndash; Feb 2026 &bull; 721 Sites &bull; Pullman Campus</p>
  </div>
  <div class="header-actions">
    <a href="index.html">Energy Cost Projection</a>
    <button class="btn-icon" id="darkToggle" title="Toggle dark mode">&#9790;</button>
  </div>
</header>

<div class="container">
  <!-- Nav Tabs -->
  <div class="nav-tabs" id="navTabs">
    <button class="nav-tab active" data-tab="overview">Overview</button>
    <button class="nav-tab" data-tab="electric">Electric</button>
    <button class="nav-tab" data-tab="thermal">Thermal</button>
    <button class="nav-tab" data-tab="water">Water</button>
    <button class="nav-tab" data-tab="buildings">Buildings</button>
    <button class="nav-tab" data-tab="connectors">Connectors</button>
    <button class="nav-tab" data-tab="info">Data Info</button>
  </div>

  <!-- ==================== OVERVIEW TAB ==================== -->
  <div class="section active" id="sec-overview">
    <div class="kpi-grid" id="kpiOverview"></div>
    <div class="chart-row">
      <div class="card">
        <h2>Top 20 Buildings by Total Energy (MMBtu)</h2>
        <div class="chart-container tall"><canvas id="chartTopEnergy"></canvas></div>
      </div>
      <div class="card">
        <h2>Top 20 Buildings by Total Water (kGal)</h2>
        <div class="chart-container tall"><canvas id="chartTopWater"></canvas></div>
      </div>
    </div>
    <div class="chart-row">
      <div class="card">
        <h2>Monthly Campus Energy Totals</h2>
        <div class="chart-container"><canvas id="chartMonthlyEnergy"></canvas></div>
      </div>
      <div class="card">
        <h2>Monthly Campus Water Totals</h2>
        <div class="chart-container"><canvas id="chartMonthlyWater"></canvas></div>
      </div>
    </div>
  </div>

  <!-- ==================== ELECTRIC TAB ==================== -->
  <div class="section" id="sec-electric">
    <div class="kpi-grid" id="kpiElectric"></div>
    <div class="card">
      <h2>Monthly Electric Trend (MMBtu)</h2>
      <div class="chart-container"><canvas id="chartElecTrend"></canvas></div>
    </div>
    <div class="card">
      <h2>Top 15 Buildings &mdash; Electric (MMBtu, 14-mo Total)</h2>
      <div class="chart-container tall"><canvas id="chartElecTop"></canvas></div>
    </div>
    <div class="card">
      <h2>Building Electric Consumption</h2>
      <input type="text" class="search-bar" id="searchElec" placeholder="Search buildings...">
      <div class="table-wrap"><table id="tblElec"><thead></thead><tbody></tbody></table></div>
    </div>
  </div>

  <!-- ==================== THERMAL TAB ==================== -->
  <div class="section" id="sec-thermal">
    <div class="kpi-grid" id="kpiThermal"></div>
    <div class="card">
      <h2>Monthly Thermal Trend (MMBtu)</h2>
      <div class="chart-container"><canvas id="chartThermalTrend"></canvas></div>
    </div>
    <div class="chart-row">
      <div class="card">
        <h2>Top 15 Buildings &mdash; Steam (MMBtu)</h2>
        <div class="chart-container tall"><canvas id="chartSteamTop"></canvas></div>
      </div>
      <div class="card">
        <h2>Top 15 Buildings &mdash; CHW Energy (MMBtu)</h2>
        <div class="chart-container tall"><canvas id="chartChwETop"></canvas></div>
      </div>
    </div>
  </div>

  <!-- ==================== WATER TAB ==================== -->
  <div class="section" id="sec-water">
    <div class="kpi-grid" id="kpiWater"></div>
    <div class="card">
      <h2>Monthly Water Trend (kGal)</h2>
      <div class="chart-container"><canvas id="chartWaterTrend"></canvas></div>
    </div>
    <div class="chart-row">
      <div class="card">
        <h2>Top 15 Buildings &mdash; Domestic Water (kGal)</h2>
        <div class="chart-container tall"><canvas id="chartDomTop"></canvas></div>
      </div>
      <div class="card">
        <h2>Top 15 Buildings &mdash; Irrigation (kGal)</h2>
        <div class="chart-container tall"><canvas id="chartIrrigTop"></canvas></div>
      </div>
    </div>
  </div>

  <!-- ==================== BUILDINGS TAB ==================== -->
  <div class="section" id="sec-buildings">
    <input type="text" class="search-bar" id="searchBldg" placeholder="Search by building name or number...">
    <div class="bldg-grid" id="bldgGrid"></div>
  </div>

  <!-- ==================== CONNECTORS TAB ==================== -->
  <div class="section" id="sec-connectors">
    <div class="kpi-grid" id="kpiConn"></div>
    <div class="filter-bar" id="connFilterBar">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="ok">OK</button>
      <button class="filter-btn" data-filter="fault">Fault</button>
      <button class="filter-btn" data-filter="disabled">Disabled</button>
    </div>
    <div class="card">
      <div class="table-wrap"><table id="tblConn"><thead></thead><tbody></tbody></table></div>
    </div>
  </div>

  <!-- ==================== DATA INFO TAB ==================== -->
  <div class="section" id="sec-info">
    <div class="card">
      <h2>Data Sources</h2>
      <div class="info-box">
        <p><strong>Data Period:</strong> January 2025 &ndash; February 2026 (14 months)</p>
        <p><strong>Source:</strong> SkySpark <code>wsumeters</code> project at <code>skyspark.fais.wsu.edu</code></p>
        <p><strong>Export Method:</strong> Existing <code>view_*</code> functions with Export Format, run via Shell</p>
      </div>
      <h2>Export Commands</h2>
      <div class="info-box">
        <p>Run these in the SkySpark Shell to refresh data:</p>
        <p><code>view_elecMeters(2025-01-01..2026-02-28, "Energy (kWh)", "Site", "Export Format")</code></p>
        <p><code>view_condensate(2025-01-01..2026-02-28, "Site", "Export Format")</code></p>
        <p><code>view_water(2025-01-01..2026-02-28, "Site", "Domestic", "Export Format")</code></p>
        <p><code>view_water(2025-01-01..2026-02-28, "Site", "Irrigation", "Export Format")</code></p>
        <p><code>view_chwExport(2025-01-01..2026-02-28, "CHW (tonhr)", "Site", "Export Format")</code></p>
      </div>
      <h2>Unit Conversions</h2>
      <div class="info-box">
        <p>Raw values exported in native units. Conversions applied in this dashboard:</p>
        <ul style="margin:0.5rem 0 0 1.25rem;">
          <li><strong>Electric:</strong> kWh &times; 0.003412 = MMBtu</li>
          <li><strong>Steam:</strong> lb &times; 0.001 = MMBtu (1 lb steam &asymp; 1,000 BTU)</li>
          <li><strong>CHW Energy:</strong> tonrefh &times; 0.012 = MMBtu (1 tonrefh = 12,000 BTU)</li>
          <li><strong>Domestic Water:</strong> gal &div; 1,000 = kGal</li>
          <li><strong>Irrigation:</strong> gal &div; 1,000 = kGal</li>
        </ul>
      </div>
      <h2>File Inventory</h2>
      <div class="table-wrap">
        <table>
          <thead><tr><th style="text-align:left">File</th><th>Rows</th><th style="text-align:left">Description</th></tr></thead>
          <tbody id="tblFiles"></tbody>
        </table>
      </div>
    </div>
    <!-- Data Quality Card -->
    <div class="card" id="dataQualityCard">
      <h2>Data Quality &amp; Verification</h2>
      <div id="dqSummary" class="dq-summary"></div>
      <h3>Integrity Checks</h3>
      <div class="table-wrap"><table class="dq-table"><thead><tr><th style="width:24px"></th><th>Check</th><th>Result</th></tr></thead><tbody id="dqChecks"></tbody></table></div>
      <h3 style="margin-top:1.25rem">KPI Cross-Check</h3>
      <p style="font-size:0.78rem;color:var(--text-light);margin-bottom:0.5rem">Independent recalculation from raw data vs. dashboard KPIs</p>
      <div class="table-wrap"><table class="dq-kpi-table"><thead><tr><th>Utility</th><th>Raw Sum</th><th>Converted</th><th>Dashboard KPI</th><th>Match</th></tr></thead><tbody id="dqKpi"></tbody></table></div>
      <h3 style="margin-top:1.25rem">Per-Utility Breakdown</h3>
      <div class="table-wrap"><table class="dq-table"><thead><tr><th>Utility</th><th>Rows</th><th>Valid</th><th>NA/Invalid</th><th>Negative</th><th>Zero</th><th>Buildings</th><th>Date Range</th></tr></thead><tbody id="dqUtility"></tbody></table></div>
    </div>
  </div>
</div>

<footer>
  WSU Facilities Services &bull; Campus Metering Dashboard &bull;
  <a href="index.html">Energy Cost Projection</a>
</footer>

<script>
// ============================================================
//  AUTH GATE
// ============================================================
(function() {
  const gate = document.getElementById('authGate');
  const input = document.getElementById('authInput');
  const btn = document.getElementById('authBtn');
  const err = document.getElementById('authError');
  if (localStorage.getItem('wsuMeteringAuth') === 'ok') {
    gate.style.display = 'none';
  }
  function tryAuth() {
    if (input.value === 'Energy@WSU') {
      localStorage.setItem('wsuMeteringAuth', 'ok');
      gate.style.display = 'none';
      err.textContent = '';
    } else {
      err.textContent = 'Incorrect password. Please try again.';
      input.value = '';
      input.focus();
    }
  }
  btn.addEventListener('click', tryAuth);
  input.addEventListener('keydown', e => { if (e.key === 'Enter') tryAuth(); });
})();

// ============================================================
//  DARK MODE
// ============================================================
(function() {
  if (localStorage.getItem('wsuDarkMode') === 'on') {
    document.documentElement.classList.add('dark');
  }
  document.getElementById('darkToggle').addEventListener('click', () => {
    document.documentElement.classList.toggle('dark');
    localStorage.setItem('wsuDarkMode', document.documentElement.classList.contains('dark') ? 'on' : 'off');
    applyChartTheme();
    chartInstances.forEach(c => { c.options.color = Chart.defaults.color; c.update(); });
  });
})();

// ============================================================
//  TAB NAVIGATION
// ============================================================
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('sec-' + tab.dataset.tab).classList.add('active');
  });
});

// ============================================================
//  GLOBALS
// ============================================================
const chartInstances = [];
const COLORS = {
  electric: '#f59e0b', steam: '#ef4444', chwEnergy: '#06b6d4',
  domestic: '#3b82f6', irrigation: '#22c55e', chwWater: '#8b5cf6'
};

function applyChartTheme() {
  const dark = document.documentElement.classList.contains('dark');
  Chart.defaults.color = dark ? '#9ca3af' : '#6b7280';
  Chart.defaults.borderColor = dark ? '#374151' : '#e5e7eb';
}
applyChartTheme();

// ============================================================
//  ANOMALY DETECTION
// ============================================================
function detectAnomalies(data, threshold) {
  threshold = threshold || 0.35;
  const anomalies = [];
  for (let i = 1; i < data.length - 1; i++) {
    const val = data[i];
    if (!val || val === 0) continue;
    const neighbors = [data[i-1], data[i+1]].filter(function(v) { return v && v > 0; });
    if (neighbors.length === 0) continue;
    var avg = neighbors.reduce(function(s,v) { return s+v; }, 0) / neighbors.length;
    if (avg === 0) continue;
    var pctDev = (val - avg) / avg;
    if (Math.abs(pctDev) > threshold) {
      anomalies.push({ index: i, value: val, expected: avg, pctDev: pctDev,
        label: (pctDev > 0 ? '+' : '') + Math.round(pctDev * 100) + '% vs avg' });
    }
  }
  return anomalies;
}

// Chart.js custom plugin for anomaly callouts
const anomalyCalloutPlugin = {
  id: 'anomalyCallout',
  afterDatasetsDraw: function(chart) {
    const pluginOpts = chart.options.plugins.anomalyCallout;
    if (!pluginOpts || !pluginOpts.items || pluginOpts.items.length === 0) return;
    const ctx = chart.ctx;
    const xScale = chart.scales.x;
    const yScale = chart.scales.y;
    const dark = document.documentElement.classList.contains('dark');

    pluginOpts.items.forEach(function(group, dsIdx) {
      if (!group || group.length === 0) return;
      var color = pluginOpts.colors && pluginOpts.colors[dsIdx] ? pluginOpts.colors[dsIdx] : '#dc2626';
      group.forEach(function(a) {
        var x = xScale.getPixelForValue(a.index);
        var y = yScale.getPixelForValue(a.value);
        // Draw diamond marker
        ctx.save();
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.moveTo(x, y - 6);
        ctx.lineTo(x + 5, y);
        ctx.lineTo(x, y + 6);
        ctx.lineTo(x - 5, y);
        ctx.closePath();
        ctx.fill();
        // Draw callout label above
        var labelY = y - 18;
        if (labelY < 20) labelY = y + 20; // flip below if near top
        ctx.font = 'bold 10px -apple-system, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillStyle = dark ? 'rgba(255,255,255,0.85)' : 'rgba(0,0,0,0.75)';
        // Background pill
        var textW = ctx.measureText(a.label).width + 8;
        ctx.fillStyle = dark ? 'rgba(31,41,55,0.9)' : 'rgba(255,255,255,0.92)';
        ctx.strokeStyle = color;
        ctx.lineWidth = 1;
        var rx = x - textW/2, ry = labelY - 8, rw = textW, rh = 16, rr = 3;
        ctx.beginPath();
        if (ctx.roundRect) { ctx.roundRect(rx, ry, rw, rh, rr); }
        else { ctx.moveTo(rx+rr,ry); ctx.arcTo(rx+rw,ry,rx+rw,ry+rh,rr); ctx.arcTo(rx+rw,ry+rh,rx,ry+rh,rr); ctx.arcTo(rx,ry+rh,rx,ry,rr); ctx.arcTo(rx,ry,rx+rw,ry,rr); ctx.closePath(); }
        ctx.fill();
        ctx.stroke();
        // Text
        ctx.fillStyle = color;
        ctx.fillText(a.label, x, labelY + 4);
        // Connector line
        ctx.strokeStyle = color;
        ctx.lineWidth = 1;
        ctx.setLineDash([2, 2]);
        ctx.beginPath();
        ctx.moveTo(x, y - 6);
        ctx.lineTo(x, labelY + 8);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.restore();
      });
    });
  }
};
Chart.register(anomalyCalloutPlugin);

function fmt(n, dec) {
  if (n == null || isNaN(n)) return '0';
  dec = dec ?? 0;
  return n.toLocaleString('en-US', { minimumFractionDigits: dec, maximumFractionDigits: dec });
}

function parseMonthKey(startDate) {
  // startDate format: "MM-DD-YYYY" -> "YYYY-MM"
  if (!startDate) return '';
  const parts = startDate.split('-');
  if (parts.length === 3) return parts[2] + '-' + parts[0];
  return startDate;
}

function monthLabel(key) {
  // "2025-01" -> "Jan 25"
  const [y, m] = key.split('-');
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return months[parseInt(m, 10) - 1] + ' ' + y.slice(2);
}

// ============================================================
//  DATA LOADING
// ============================================================
async function loadJSON(url) {
  const resp = await fetch(url);
  if (!resp.ok) throw new Error('Failed to load ' + url);
  const data = await resp.json();
  return data.rows || [];
}

async function loadAllData() {
  const [electric, condensate, domesticWater, irrigation, chw, sites, connectors] = await Promise.all([
    loadJSON('data/electric.json'),
    loadJSON('data/condensate.json'),
    loadJSON('data/domestic_water.json'),
    loadJSON('data/irrigation.json'),
    loadJSON('data/chw.json'),
    loadJSON('data/sites.json'),
    loadJSON('data/connectors.json')
  ]);
  return { electric, condensate, domesticWater, irrigation, chw, sites, connectors };
}

// ============================================================
//  CONVERSION HELPERS
// ============================================================
function kwhToMmbtu(kwh) { return (kwh || 0) * 0.003412; }
function lbToMmbtu(lb) { return (lb || 0) * 0.001; }
function tonrefhToMmbtu(t) { return (t || 0) * 0.012; }
function galToKgal(g) { return (g || 0) / 1000; }
function bldgLabel(b) { return b.bldgNo + (b.bldgName ? ' - ' + b.bldgName : ''); }

// ============================================================
//  AGGREGATION
// ============================================================
function aggregateByBuilding(rows, convertFn) {
  const map = {};
  rows.forEach(r => {
    const key = r.bldgNo || 'Unknown';
    if (!map[key]) map[key] = { bldgNo: key, bldgName: r.bldgName || '', total: 0, months: {} };
    const mk = parseMonthKey(r.startDate);
    const raw = typeof r.usage === 'number' && isFinite(r.usage) ? r.usage : 0;
    const val = convertFn(raw);
    map[key].total += val;
    map[key].months[mk] = (map[key].months[mk] || 0) + val;
  });
  return map;
}

function aggregateByMonth(rows, convertFn) {
  const map = {};
  rows.forEach(r => {
    const mk = parseMonthKey(r.startDate);
    if (!mk) return;
    const raw = typeof r.usage === 'number' && isFinite(r.usage) ? r.usage : 0;
    map[mk] = (map[mk] || 0) + convertFn(raw);
  });
  return map;
}

function getSortedMonths(data) {
  const all = new Set();
  [data.electric, data.condensate, data.domesticWater, data.irrigation, data.chw].forEach(arr => {
    arr.forEach(r => { const mk = parseMonthKey(r.startDate); if (mk) all.add(mk); });
  });
  return [...all].sort();
}

// ============================================================
//  CHART FACTORY
// ============================================================
function createChart(canvasId, config) {
  const ctx = document.getElementById(canvasId);
  if (!ctx) return null;
  const c = new Chart(ctx, config);
  chartInstances.push(c);
  return c;
}

function barChart(canvasId, labels, datasets, opts) {
  return createChart(canvasId, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      indexAxis: opts?.horizontal ? 'y' : 'x',
      plugins: {
        legend: { display: datasets.length > 1, position: 'top', labels: { boxWidth: 12, padding: 10 } },
        tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + fmt(ctx.parsed[opts?.horizontal ? 'x' : 'y'], 1) } }
      },
      scales: {
        x: {
          stacked: opts?.stacked,
          grid: { display: !opts?.horizontal },
          beginAtZero: opts?.horizontal || false,
          ...(opts?.horizontal ? {
            ticks: { callback: v => v >= 1000000 ? (v/1000000).toFixed(1)+'M' : v >= 1000 ? (v/1000).toFixed(0)+'k' : v }
          } : {})
        },
        y: {
          stacked: opts?.stacked,
          beginAtZero: !opts?.horizontal,
          ...(!opts?.horizontal ? {
            ticks: { callback: v => v >= 1000000 ? (v/1000000).toFixed(1)+'M' : v >= 1000 ? (v/1000).toFixed(0)+'k' : v }
          } : {
            ticks: { autoSkip: false, font: { size: 11 } }
          })
        }
      }
    }
  });
}

function lineChart(canvasId, labels, datasets, anomalies) {
  // anomalies: optional array of arrays (one per dataset), each containing anomaly objects
  const anomalyOpts = anomalies ? {
    items: anomalies,
    colors: datasets.map(d => d.borderColor || '#dc2626')
  } : { items: [] };
  return createChart(canvasId, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: datasets.length > 1, position: 'top', labels: { boxWidth: 12, padding: 10 } },
        tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + fmt(ctx.parsed.y, 1) } },
        anomalyCallout: anomalyOpts
      },
      scales: {
        x: { grid: { display: false } },
        y: { beginAtZero: true,
          ticks: { callback: v => v >= 1000000 ? (v/1000000).toFixed(1) + 'M' : v >= 1000 ? (v/1000).toFixed(0) + 'k' : v }
        }
      },
      elements: { point: { radius: 3, hoverRadius: 5 }, line: { tension: 0.3 } }
    }
  });
}

// ============================================================
//  KPI HELPERS
// ============================================================
function buildMiniTable(headers, monthKeys, rowFn, totalLabel, totalFn) {
  let html = '<table class="kpi-mini-table"><thead><tr>';
  headers.forEach(h => { html += '<th>' + h + '</th>'; });
  html += '</tr></thead><tbody>';
  monthKeys.forEach((mk, i) => {
    const cells = rowFn(mk, i);
    html += '<tr>';
    cells.forEach(c => { html += '<td>' + c + '</td>'; });
    html += '</tr>';
  });
  html += '<tr><td>' + totalLabel + '</td>';
  totalFn().forEach(t => { html += '<td>' + t + '</td>'; });
  html += '</tr></tbody></table>';
  return html;
}

function renderKPIs(containerId, cards) {
  const el = document.getElementById(containerId);
  el.innerHTML = cards.map(c =>
    `<div class="kpi-card ${c.cls || ''}">
      ${c.expandHtml ? '<span class="kpi-expand-icon">&#9660;</span>' : ''}
      ${c.tooltip ? '<span class="kpi-tooltip">' + c.tooltip + '</span>' : ''}
      <div class="kpi-label">${c.label}</div>
      <div class="kpi-value">${c.value}</div>
      <div class="kpi-sub">${c.sub || ''}</div>
      ${c.expandHtml ? '<div class="kpi-expand">' + c.expandHtml + '</div>' : ''}
    </div>`
  ).join('');
  el.querySelectorAll('.kpi-card').forEach(card => {
    if (card.querySelector('.kpi-expand')) {
      card.addEventListener('click', function() { this.classList.toggle('expanded'); });
    }
  });
}

// ============================================================
//  DATA VERIFICATION (10 checks)
// ============================================================
function runVerification(data, totals) {
  const checks = [];
  const utilities = {};
  const kpiCheck = {};

  // Helper: analyze one utility dataset
  function analyzeUtility(rows, name) {
    let valid = 0, naCount = 0, negCount = 0, zeroCount = 0, rawSum = 0;
    const bldgs = new Set();
    const dates = new Set();
    const bldgMonths = {};  // bldgNo -> Set of month keys

    rows.forEach(r => {
      const u = r.usage;
      const isNum = typeof u === 'number' && isFinite(u);
      if (!isNum) { naCount++; return; }
      if (u < 0) negCount++;
      if (u === 0) zeroCount++;
      else { valid++; bldgs.add(r.bldgNo); }
      rawSum += u;
      const mk = parseMonthKey(r.startDate);
      if (mk) {
        dates.add(mk);
        if (u > 0) {
          if (!bldgMonths[r.bldgNo]) bldgMonths[r.bldgNo] = new Set();
          bldgMonths[r.bldgNo].add(mk);
        }
      }
    });

    const sortedDates = [...dates].sort();
    const dateRange = sortedDates.length > 0
      ? monthLabel(sortedDates[0]) + ' - ' + monthLabel(sortedDates[sortedDates.length - 1])
      : 'None';
    const totalMonths = sortedDates.length;
    let gapBuildings = 0;
    Object.values(bldgMonths).forEach(ms => { if (ms.size < totalMonths) gapBuildings++; });

    utilities[name] = { rows: rows.length, valid, naCount, negCount, zeroCount, buildings: bldgs.size, dateRange, rawSum, gapBuildings, totalMonths };
    return { rawSum, bldgs };
  }

  const elecA = analyzeUtility(data.electric, 'Electric');
  const steamA = analyzeUtility(data.condensate, 'Steam');
  const chwA = analyzeUtility(data.chw, 'CHW Energy');
  const domA = analyzeUtility(data.domesticWater, 'Domestic Water');
  const irrigA = analyzeUtility(data.irrigation, 'Irrigation');

  // Check 1: Row counts (pass if all > 0)
  const rowDetail = Object.entries(utilities).map(([k, v]) => k + ': ' + fmt(v.rows)).join(' | ');
  const allHaveRows = Object.values(utilities).every(v => v.rows > 0);
  checks.push({ name: 'Row Counts', status: allHaveRows ? 'pass' : 'fail', detail: rowDetail });

  // Check 2: NA/invalid values
  const totalNA = Object.values(utilities).reduce((s, v) => s + v.naCount, 0);
  const totalRows = Object.values(utilities).reduce((s, v) => s + v.rows, 0);
  const naPct = totalRows > 0 ? (totalNA / totalRows * 100).toFixed(2) : 0;
  const naDetail = totalNA === 0
    ? 'No NA/invalid values found across all datasets'
    : totalNA + ' NA/invalid values (' + naPct + '%) ' + Object.entries(utilities).filter(([,v]) => v.naCount > 0).map(([k,v]) => k + ': ' + v.naCount).join(', ');
  checks.push({ name: 'NA/Invalid Values', status: totalNA === 0 ? 'pass' : 'warn', detail: naDetail });

  // Check 3: Negative values
  const totalNeg = Object.values(utilities).reduce((s, v) => s + v.negCount, 0);
  const negDetail = totalNeg === 0
    ? 'No negative values found'
    : totalNeg + ' negative values (likely meter rollover): ' + Object.entries(utilities).filter(([,v]) => v.negCount > 0).map(([k,v]) => k + ': ' + v.negCount).join(', ');
  checks.push({ name: 'Negative Values', status: totalNeg === 0 ? 'pass' : 'warn', detail: negDetail });

  // Check 4: Zero-usage months
  const totalZero = Object.values(utilities).reduce((s, v) => s + v.zeroCount, 0);
  const zeroPct = totalRows > 0 ? (totalZero / totalRows * 100).toFixed(1) : 0;
  checks.push({ name: 'Zero-Usage Months', status: 'pass', detail: fmt(totalZero) + ' zero-usage rows (' + zeroPct + '%) across all utilities' });

  // Check 5: Date range consistency
  const allRanges = Object.values(utilities).map(v => v.dateRange);
  const rangeConsistent = allRanges.every(r => r === allRanges[0]);
  checks.push({ name: 'Date Range', status: rangeConsistent ? 'pass' : 'warn',
    detail: rangeConsistent ? 'All utilities: ' + allRanges[0] : Object.entries(utilities).map(([k,v]) => k + ': ' + v.dateRange).join(' | ') });

  // Check 6: Building coverage
  const totalSites = data.sites.length;
  const coverDetail = Object.entries(utilities).map(([k,v]) => k + ': ' + v.buildings + '/' + totalSites).join(' | ');
  checks.push({ name: 'Building Coverage', status: 'pass', detail: coverDetail });

  // Check 7: Monthly continuity
  const totalGaps = Object.values(utilities).reduce((s, v) => s + v.gapBuildings, 0);
  const gapDetail = totalGaps === 0
    ? 'All active buildings have data for every month'
    : totalGaps + ' building-utility combos missing 1+ months: ' + Object.entries(utilities).filter(([,v]) => v.gapBuildings > 0).map(([k,v]) => k + ': ' + v.gapBuildings).join(', ');
  checks.push({ name: 'Monthly Continuity', status: totalGaps === 0 ? 'pass' : 'warn', detail: gapDetail });

  // Check 8: Cross-utility sanity (top-5 electric vs top-5 steam)
  const elecTop5 = Object.entries(aggregateByBuilding(data.electric, v => v)).sort((a,b) => b[1].total - a[1].total).slice(0,5).map(e => e[0]);
  const steamTop5 = Object.entries(aggregateByBuilding(data.condensate, v => v)).sort((a,b) => b[1].total - a[1].total).slice(0,5).map(e => e[0]);
  const overlap = elecTop5.filter(b => steamTop5.includes(b)).length;
  checks.push({ name: 'Cross-Utility Sanity', status: overlap >= 2 ? 'pass' : 'warn',
    detail: overlap + '/5 of top electric buildings also appear in top 5 steam. Elec: ' + elecTop5.join(', ') + ' | Steam: ' + steamTop5.join(', ') });

  // Check 9: KPI recalculation
  const conversionMap = {
    'Electric':       { rawUnit: 'kWh',     convUnit: 'MMBtu', fn: kwhToMmbtu,     dashVal: totals.elec },
    'Steam':          { rawUnit: 'lb',      convUnit: 'MMBtu', fn: lbToMmbtu,      dashVal: totals.steam },
    'CHW Energy':     { rawUnit: 'tonrefh', convUnit: 'MMBtu', fn: tonrefhToMmbtu, dashVal: totals.chwE },
    'Domestic Water': { rawUnit: 'gal',     convUnit: 'kGal',  fn: galToKgal,      dashVal: totals.dom },
    'Irrigation':     { rawUnit: 'gal',     convUnit: 'kGal',  fn: galToKgal,      dashVal: totals.irrig }
  };

  let allMatch = true;
  Object.entries(conversionMap).forEach(([name, c]) => {
    const rawSum = utilities[name].rawSum;
    const converted = c.fn(rawSum);
    const tolerance = Math.abs(converted) * 0.001; // 0.1% tolerance for floating point
    const match = Math.abs(converted - c.dashVal) <= Math.max(tolerance, 0.01);
    if (!match) allMatch = false;
    kpiCheck[name] = { rawSum, rawUnit: c.rawUnit, converted, convUnit: c.convUnit, dashVal: c.dashVal, match };
  });
  checks.push({ name: 'KPI Recalculation', status: allMatch ? 'pass' : 'fail',
    detail: allMatch ? 'All 5 utility KPIs match independent recalculation (within 0.1%)' : 'One or more KPIs do not match independent recalculation' });

  // Check 10: Conversion check (always pass, informational)
  checks.push({ name: 'Conversion Reference', status: 'pass',
    detail: 'kWh\u00d70.003412=MMBtu | lb\u00d70.001=MMBtu | tonrefh\u00d70.012=MMBtu | gal\u00f71000=kGal' });

  const passCount = checks.filter(c => c.status === 'pass').length;
  const warnCount = checks.filter(c => c.status === 'warn').length;
  const failCount = checks.filter(c => c.status === 'fail').length;
  const overall = failCount > 0 ? 'fail' : warnCount > 0 ? 'warn' : 'pass';

  return { overall, passCount, warnCount, failCount, checks, utilities, kpiCheck };
}

function renderVerification(vr) {
  const icon = vr.overall === 'pass' ? '\u2713' : vr.overall === 'warn' ? '\u26a0' : '\u2717';
  const label = vr.overall === 'pass' ? '\u2713 All Passed' : vr.overall === 'warn' ? '\u26a0 ' + vr.warnCount + ' Warning' + (vr.warnCount > 1 ? 's' : '') : '\u2717 Failed';
  const statusIcon = s => '<span class="dq-icon ' + s + '">' + (s === 'pass' ? '\u2713' : s === 'warn' ? '\u26a0' : '\u2717') + '</span>';

  // Build checks mini-table for KPI expand
  const checksHtml = '<table class="kpi-mini-table"><thead><tr><th style="width:20px"></th><th>Check</th><th>Result</th></tr></thead><tbody>' +
    vr.checks.map(c =>
      '<tr><td>' + statusIcon(c.status) + '</td><td>' + c.name + '</td><td style="font-size:0.7rem">' + c.detail + '</td></tr>'
    ).join('') + '</tbody></table>';

  // Append Data Quality KPI card to overview grid
  const overviewGrid = document.getElementById('kpiOverview');
  const borderCls = vr.overall === 'pass' ? 'ok' : vr.overall === 'warn' ? 'electric' : 'fault';
  const dqCard = document.createElement('div');
  dqCard.className = 'kpi-card ' + borderCls;
  dqCard.innerHTML =
    '<span class="kpi-expand-icon">&#9660;</span>' +
    '<span class="kpi-tooltip">Automated integrity checks run at load time across all datasets</span>' +
    '<div class="kpi-label">Data Quality</div>' +
    '<div class="kpi-value">' + label + '</div>' +
    '<div class="kpi-sub">' + vr.passCount + ' of ' + vr.checks.length + ' checks passed \u00b7 Click for details</div>' +
    '<div class="kpi-expand">' + checksHtml + '</div>';
  dqCard.addEventListener('click', function() { this.classList.toggle('expanded'); });
  overviewGrid.appendChild(dqCard);

  // Data Info tab: Summary
  document.getElementById('dqSummary').innerHTML =
    '<span class="dq-stat pass">' + vr.passCount + ' Passed</span>' +
    (vr.warnCount > 0 ? '<span class="dq-stat warn">' + vr.warnCount + ' Warnings</span>' : '') +
    (vr.failCount > 0 ? '<span class="dq-stat fail">' + vr.failCount + ' Failed</span>' : '') +
    '<span style="font-size:0.75rem;color:var(--text-light)">' + vr.checks.length + ' checks run at load time</span>';

  // Data Info tab: Checks table
  document.getElementById('dqChecks').innerHTML = vr.checks.map(c =>
    '<tr><td>' + statusIcon(c.status) + '</td><td>' + c.name + '</td><td style="font-size:0.75rem">' + c.detail + '</td></tr>'
  ).join('');

  // Data Info tab: KPI cross-check table
  document.getElementById('dqKpi').innerHTML = Object.entries(vr.kpiCheck).map(([name, k]) =>
    '<tr><td>' + name + '</td>' +
    '<td>' + fmt(k.rawSum, 0) + ' ' + k.rawUnit + '</td>' +
    '<td>' + fmt(k.converted, 1) + ' ' + k.convUnit + '</td>' +
    '<td>' + fmt(k.dashVal, 1) + ' ' + k.convUnit + '</td>' +
    '<td class="' + (k.match ? 'dq-match' : 'dq-mismatch') + '">' + (k.match ? '\u2713 Match' : '\u2717 Mismatch') + '</td></tr>'
  ).join('');

  // Data Info tab: Per-utility breakdown
  document.getElementById('dqUtility').innerHTML = Object.entries(vr.utilities).map(([name, u]) =>
    '<tr><td>' + name + '</td>' +
    '<td>' + fmt(u.rows) + '</td>' +
    '<td>' + fmt(u.valid) + '</td>' +
    '<td>' + (u.naCount > 0 ? '<span style="color:var(--red)">' + u.naCount + '</span>' : '0') + '</td>' +
    '<td>' + (u.negCount > 0 ? '<span style="color:var(--red)">' + u.negCount + '</span>' : '0') + '</td>' +
    '<td>' + fmt(u.zeroCount) + '</td>' +
    '<td>' + u.buildings + '</td>' +
    '<td>' + u.dateRange + '</td></tr>'
  ).join('');
}

// ============================================================
//  MAIN INIT
// ============================================================
loadAllData().then(data => {
  document.getElementById('loading').style.display = 'none';

  const months = getSortedMonths(data);
  const monthLabels = months.map(monthLabel);

  // ---- Aggregations ----
  const elecByBldg = aggregateByBuilding(data.electric, kwhToMmbtu);
  const steamByBldg = aggregateByBuilding(data.condensate, lbToMmbtu);
  const chwEByBldg = aggregateByBuilding(data.chw, tonrefhToMmbtu);
  const domByBldg = aggregateByBuilding(data.domesticWater, galToKgal);
  const irrigByBldg = aggregateByBuilding(data.irrigation, galToKgal);

  const elecByMonth = aggregateByMonth(data.electric, kwhToMmbtu);
  const steamByMonth = aggregateByMonth(data.condensate, lbToMmbtu);
  const chwEByMonth = aggregateByMonth(data.chw, tonrefhToMmbtu);
  const domByMonth = aggregateByMonth(data.domesticWater, galToKgal);
  const irrigByMonth = aggregateByMonth(data.irrigation, galToKgal);

  const totalElec = Object.values(elecByBldg).reduce((s, b) => s + b.total, 0);
  const totalSteam = Object.values(steamByBldg).reduce((s, b) => s + b.total, 0);
  const totalChwE = Object.values(chwEByBldg).reduce((s, b) => s + b.total, 0);
  const totalDom = Object.values(domByBldg).reduce((s, b) => s + b.total, 0);
  const totalIrrig = Object.values(irrigByBldg).reduce((s, b) => s + b.total, 0);
  const totalEnergy = totalElec + totalSteam + totalChwE;
  const totalWater = totalDom + totalIrrig;

  // Unique buildings per utility
  const elecBldgs = new Set(data.electric.filter(r => r.usage > 0).map(r => r.bldgNo));
  const steamBldgs = new Set(data.condensate.filter(r => r.usage > 0).map(r => r.bldgNo));
  const chwEBldgs = new Set(data.chw.filter(r => r.usage > 0).map(r => r.bldgNo));
  const domBldgs = new Set(data.domesticWater.filter(r => r.usage > 0).map(r => r.bldgNo));
  const irrigBldgs = new Set(data.irrigation.filter(r => r.usage > 0).map(r => r.bldgNo));

  // Connectors
  const connOk = data.connectors.filter(c => c.connStatus === 'ok').length;
  const connFault = data.connectors.filter(c => c.connStatus === 'fault').length;
  const connDisabled = data.connectors.filter(c => c.connStatus === 'disabled').length;
  const connOther = data.connectors.length - connOk - connFault - connDisabled;

  // ==================== DATA VERIFICATION ====================
  const vr = runVerification(data, { elec: totalElec, steam: totalSteam, chwE: totalChwE, dom: totalDom, irrig: totalIrrig });

  // ==================== OVERVIEW TAB ====================
  // Build expand tables for overview KPIs
  const energyExpand = buildMiniTable(
    ['Month', 'Electric', 'Steam', 'CHW', 'Total'],
    months,
    mk => [monthLabel(mk), fmt(elecByMonth[mk]||0,0), fmt(steamByMonth[mk]||0,0), fmt(chwEByMonth[mk]||0,0), fmt((elecByMonth[mk]||0)+(steamByMonth[mk]||0)+(chwEByMonth[mk]||0),0)],
    'Total', () => [fmt(totalElec,0), fmt(totalSteam,0), fmt(totalChwE,0), fmt(totalEnergy,0)]
  );
  const waterExpand = buildMiniTable(
    ['Month', 'Domestic', 'Irrigation', 'Total'],
    months,
    mk => [monthLabel(mk), fmt(domByMonth[mk]||0,0), fmt(irrigByMonth[mk]||0,0), fmt((domByMonth[mk]||0)+(irrigByMonth[mk]||0),0)],
    'Total', () => [fmt(totalDom,0), fmt(totalIrrig,0), fmt(totalWater,0)]
  );
  const connExpand = '<table class="kpi-mini-table"><thead><tr><th>Status</th><th>Count</th><th>Pct</th></tr></thead><tbody>' +
    '<tr><td>OK</td><td>' + connOk + '</td><td>' + Math.round(connOk/data.connectors.length*100) + '%</td></tr>' +
    '<tr><td>Fault</td><td>' + connFault + '</td><td>' + Math.round(connFault/data.connectors.length*100) + '%</td></tr>' +
    '<tr><td>Disabled</td><td>' + connDisabled + '</td><td>' + Math.round(connDisabled/data.connectors.length*100) + '%</td></tr>' +
    (connOther > 0 ? '<tr><td>Other</td><td>' + connOther + '</td><td>' + Math.round(connOther/data.connectors.length*100) + '%</td></tr>' : '') +
    '<tr><td>Total</td><td>' + data.connectors.length + '</td><td>100%</td></tr></tbody></table>';
  const singleExpand = (byMonth, total, unit) => buildMiniTable(
    ['Month', unit], months,
    mk => [monthLabel(mk), fmt(byMonth[mk]||0,0)],
    'Total', () => [fmt(total,0)]
  );

  // Top 10 for Sites expand
  const allBldgTotal = {};
  [elecByBldg, steamByBldg, chwEByBldg, domByBldg, irrigByBldg].forEach(map => {
    Object.entries(map).forEach(([k,v]) => { allBldgTotal[k] = (allBldgTotal[k]||0) + v.total; });
  });
  const top10Sites = Object.entries(allBldgTotal).sort((a,b) => b[1]-a[1]).slice(0,10);
  const sitesExpand = '<table class="kpi-mini-table"><thead><tr><th>Building</th><th>Total</th></tr></thead><tbody>' +
    top10Sites.map(([no,total]) => {
      const name = (elecByBldg[no]||steamByBldg[no]||domByBldg[no]||{}).bldgName || '';
      return '<tr><td>' + no + (name ? ' - ' + name : '') + '</td><td>' + fmt(total,0) + '</td></tr>';
    }).join('') +
    '<tr><td>All ' + data.sites.length + ' sites</td><td></td></tr></tbody></table>';

  renderKPIs('kpiOverview', [
    { label: 'Total Sites', value: fmt(data.sites.length), sub: 'Campus buildings', cls: '',
      tooltip: data.sites.length + ' campus buildings from SkySpark site records',
      expandHtml: sitesExpand },
    { label: 'Total Energy', value: fmt(totalEnergy, 0) + ' MMBtu', sub: '14-month total', cls: 'electric',
      tooltip: 'Sum of Electric + Steam + CHW Energy, all converted to MMBtu',
      expandHtml: energyExpand },
    { label: 'Total Water', value: fmt(totalWater, 0) + ' kGal', sub: '14-month total', cls: 'domestic',
      tooltip: 'Sum of Domestic Water + Irrigation in thousand gallons (kGal)',
      expandHtml: waterExpand },
    { label: 'Connector Health', value: Math.round(connOk / data.connectors.length * 100) + '%', sub: connOk + ' OK / ' + connFault + ' Fault / ' + connDisabled + ' Disabled', cls: 'ok',
      tooltip: 'SkySpark connector status: OK = actively collecting data',
      expandHtml: connExpand },
    { label: 'Electric', value: fmt(totalElec, 0) + ' MMBtu', sub: elecBldgs.size + ' buildings', cls: 'electric',
      tooltip: 'Electric consumption: kWh \u00d7 0.003412 = MMBtu',
      expandHtml: singleExpand(elecByMonth, totalElec, 'MMBtu') },
    { label: 'Steam', value: fmt(totalSteam, 0) + ' MMBtu', sub: steamBldgs.size + ' buildings', cls: 'steam',
      tooltip: 'Steam condensate: lb \u00d7 0.001 = MMBtu',
      expandHtml: singleExpand(steamByMonth, totalSteam, 'MMBtu') },
    { label: 'Domestic Water', value: fmt(totalDom, 0) + ' kGal', sub: domBldgs.size + ' buildings', cls: 'domestic',
      tooltip: 'Domestic water: gallons \u00f7 1,000 = kGal',
      expandHtml: singleExpand(domByMonth, totalDom, 'kGal') },
    { label: 'Irrigation', value: fmt(totalIrrig, 0) + ' kGal', sub: irrigBldgs.size + ' buildings', cls: 'irrigation',
      tooltip: 'Irrigation water: gallons \u00f7 1,000 = kGal',
      expandHtml: singleExpand(irrigByMonth, totalIrrig, 'kGal') }
  ]);

  // Append Data Quality card to overview grid (must be after renderKPIs)
  renderVerification(vr);

  // Top 20 buildings by total energy
  const allBldgEnergy = {};
  [elecByBldg, steamByBldg, chwEByBldg].forEach(map => {
    Object.entries(map).forEach(([k, v]) => {
      if (!allBldgEnergy[k]) allBldgEnergy[k] = { bldgNo: k, bldgName: v.bldgName, elec: 0, steam: 0, chwE: 0 };
      if (map === elecByBldg) allBldgEnergy[k].elec = v.total;
      if (map === steamByBldg) allBldgEnergy[k].steam = v.total;
      if (map === chwEByBldg) allBldgEnergy[k].chwE = v.total;
    });
  });
  const top20Energy = Object.values(allBldgEnergy)
    .map(b => ({ ...b, total: b.elec + b.steam + b.chwE }))
    .sort((a, b) => b.total - a.total).slice(0, 20);

  barChart('chartTopEnergy',
    top20Energy.map(bldgLabel),
    [
      { label: 'Electric', data: top20Energy.map(b => b.elec), backgroundColor: COLORS.electric },
      { label: 'Steam', data: top20Energy.map(b => b.steam), backgroundColor: COLORS.steam },
      { label: 'CHW Energy', data: top20Energy.map(b => b.chwE), backgroundColor: COLORS.chwEnergy }
    ],
    { stacked: true, horizontal: true }
  );

  // Top 20 buildings by total water
  const allBldgWater = {};
  [domByBldg, irrigByBldg].forEach(map => {
    Object.entries(map).forEach(([k, v]) => {
      if (!allBldgWater[k]) allBldgWater[k] = { bldgNo: k, bldgName: v.bldgName, dom: 0, irrig: 0 };
      if (map === domByBldg) allBldgWater[k].dom = v.total;
      if (map === irrigByBldg) allBldgWater[k].irrig = v.total;
    });
  });
  const top20Water = Object.values(allBldgWater)
    .map(b => ({ ...b, total: b.dom + b.irrig }))
    .sort((a, b) => b.total - a.total).slice(0, 20);

  barChart('chartTopWater',
    top20Water.map(bldgLabel),
    [
      { label: 'Domestic', data: top20Water.map(b => b.dom), backgroundColor: COLORS.domestic },
      { label: 'Irrigation', data: top20Water.map(b => b.irrig), backgroundColor: COLORS.irrigation }
    ],
    { stacked: true, horizontal: true }
  );

  // Monthly campus energy totals (stacked bar)
  barChart('chartMonthlyEnergy', monthLabels, [
    { label: 'Electric', data: months.map(m => elecByMonth[m] || 0), backgroundColor: COLORS.electric },
    { label: 'Steam', data: months.map(m => steamByMonth[m] || 0), backgroundColor: COLORS.steam },
    { label: 'CHW Energy', data: months.map(m => chwEByMonth[m] || 0), backgroundColor: COLORS.chwEnergy }
  ], { stacked: true });

  // Monthly campus water totals (stacked bar)
  barChart('chartMonthlyWater', monthLabels, [
    { label: 'Domestic', data: months.map(m => domByMonth[m] || 0), backgroundColor: COLORS.domestic },
    { label: 'Irrigation', data: months.map(m => irrigByMonth[m] || 0), backgroundColor: COLORS.irrigation }
  ], { stacked: true });

  // ==================== ELECTRIC TAB ====================
  renderKPIs('kpiElectric', [
    { label: 'Total Electric', value: fmt(totalElec, 0) + ' MMBtu', sub: fmt(totalElec / 0.003412, 0) + ' kWh', cls: 'electric',
      tooltip: 'Total electric consumption across all metered buildings, converted from kWh to MMBtu',
      expandHtml: singleExpand(elecByMonth, totalElec, 'MMBtu') },
    { label: 'Buildings', value: fmt(elecBldgs.size), sub: 'With electric data', cls: 'electric',
      tooltip: elecBldgs.size + ' buildings with electric usage > 0 out of ' + data.sites.length + ' total sites' },
    { label: 'Data Points', value: fmt(data.electric.length), sub: 'Row records', cls: 'electric',
      tooltip: 'Total rows in electric.json  one row per building per month' },
    { label: 'Avg per Building', value: fmt(totalElec / Math.max(elecBldgs.size, 1), 0) + ' MMBtu', sub: '14-month average', cls: 'electric',
      tooltip: 'Total Electric MMBtu \u00f7 ' + elecBldgs.size + ' active buildings' }
  ]);

  const elecTrendData = months.map(m => elecByMonth[m] || 0);
  lineChart('chartElecTrend', monthLabels, [
    { label: 'Electric (MMBtu)', data: elecTrendData, borderColor: COLORS.electric, backgroundColor: COLORS.electric + '33', fill: true }
  ], [detectAnomalies(elecTrendData)]);

  const elecTop15 = Object.values(elecByBldg).sort((a, b) => b.total - a.total).slice(0, 15);
  barChart('chartElecTop',
    elecTop15.map(bldgLabel),
    [{ label: 'Electric MMBtu', data: elecTop15.map(b => b.total), backgroundColor: COLORS.electric }],
    { horizontal: true }
  );

  // Electric table
  buildUtilityTable('tblElec', 'searchElec', elecByBldg, months, 'MMBtu');

  // ==================== THERMAL TAB ====================
  const thermalExpand = buildMiniTable(
    ['Month', 'Steam', 'CHW', 'Total'],
    months,
    mk => [monthLabel(mk), fmt(steamByMonth[mk]||0,0), fmt(chwEByMonth[mk]||0,0), fmt((steamByMonth[mk]||0)+(chwEByMonth[mk]||0),0)],
    'Total', () => [fmt(totalSteam,0), fmt(totalChwE,0), fmt(totalSteam+totalChwE,0)]
  );
  renderKPIs('kpiThermal', [
    { label: 'Total Steam', value: fmt(totalSteam, 0) + ' MMBtu', sub: steamBldgs.size + ' buildings', cls: 'steam',
      tooltip: 'Steam condensate converted from lb to MMBtu (\u00d70.001)',
      expandHtml: singleExpand(steamByMonth, totalSteam, 'MMBtu') },
    { label: 'Total CHW Energy', value: fmt(totalChwE, 0) + ' MMBtu', sub: chwEBldgs.size + ' buildings', cls: 'chw-energy',
      tooltip: 'Chilled water energy converted from ton-ref-hr to MMBtu (\u00d70.012)',
      expandHtml: singleExpand(chwEByMonth, totalChwE, 'MMBtu') },
    { label: 'Combined Thermal', value: fmt(totalSteam + totalChwE, 0) + ' MMBtu', sub: '14-month total', cls: 'steam',
      tooltip: 'Steam + CHW Energy combined thermal load',
      expandHtml: thermalExpand },
    { label: 'Steam Records', value: fmt(data.condensate.length), sub: 'Condensate rows', cls: 'steam',
      tooltip: 'Total rows in condensate.json  one row per building per month' }
  ]);

  const steamTrendData = months.map(m => steamByMonth[m] || 0);
  const chwETrendData = months.map(m => chwEByMonth[m] || 0);
  lineChart('chartThermalTrend', monthLabels, [
    { label: 'Steam (MMBtu)', data: steamTrendData, borderColor: COLORS.steam, backgroundColor: COLORS.steam + '33', fill: false },
    { label: 'CHW Energy (MMBtu)', data: chwETrendData, borderColor: COLORS.chwEnergy, backgroundColor: COLORS.chwEnergy + '33', fill: false }
  ], [detectAnomalies(steamTrendData), detectAnomalies(chwETrendData)]);

  const steamTop15 = Object.values(steamByBldg).sort((a, b) => b.total - a.total).slice(0, 15);
  barChart('chartSteamTop',
    steamTop15.map(bldgLabel),
    [{ label: 'Steam MMBtu', data: steamTop15.map(b => b.total), backgroundColor: COLORS.steam }],
    { horizontal: true }
  );

  const chwETop15 = Object.values(chwEByBldg).sort((a, b) => b.total - a.total).slice(0, 15);
  barChart('chartChwETop',
    chwETop15.map(bldgLabel),
    [{ label: 'CHW Energy MMBtu', data: chwETop15.map(b => b.total), backgroundColor: COLORS.chwEnergy }],
    { horizontal: true }
  );

  // ==================== WATER TAB ====================
  renderKPIs('kpiWater', [
    { label: 'Domestic Water', value: fmt(totalDom, 0) + ' kGal', sub: domBldgs.size + ' buildings', cls: 'domestic',
      tooltip: 'Domestic water consumption in thousand gallons (gal \u00f7 1,000)',
      expandHtml: singleExpand(domByMonth, totalDom, 'kGal') },
    { label: 'Irrigation', value: fmt(totalIrrig, 0) + ' kGal', sub: irrigBldgs.size + ' buildings', cls: 'irrigation',
      tooltip: 'Irrigation water consumption in thousand gallons (gal \u00f7 1,000)',
      expandHtml: singleExpand(irrigByMonth, totalIrrig, 'kGal') },
    { label: 'Total Water', value: fmt(totalWater, 0) + ' kGal', sub: '14-month total', cls: 'domestic',
      tooltip: 'Domestic + Irrigation water combined',
      expandHtml: waterExpand },
    { label: 'Data Records', value: fmt(data.domesticWater.length + data.irrigation.length), sub: 'Water rows', cls: 'domestic',
      tooltip: 'Combined row count from domestic_water.json + irrigation.json' }
  ]);

  const domTrendData = months.map(m => domByMonth[m] || 0);
  const irrigTrendData = months.map(m => irrigByMonth[m] || 0);
  lineChart('chartWaterTrend', monthLabels, [
    { label: 'Domestic (kGal)', data: domTrendData, borderColor: COLORS.domestic, backgroundColor: COLORS.domestic + '33', fill: false },
    { label: 'Irrigation (kGal)', data: irrigTrendData, borderColor: COLORS.irrigation, backgroundColor: COLORS.irrigation + '33', fill: false }
  ], [detectAnomalies(domTrendData), detectAnomalies(irrigTrendData)]);

  const domTop15 = Object.values(domByBldg).sort((a, b) => b.total - a.total).slice(0, 15);
  barChart('chartDomTop',
    domTop15.map(bldgLabel),
    [{ label: 'Domestic kGal', data: domTop15.map(b => b.total), backgroundColor: COLORS.domestic }],
    { horizontal: true }
  );

  const irrigTop15 = Object.values(irrigByBldg).sort((a, b) => b.total - a.total).slice(0, 15);
  barChart('chartIrrigTop',
    irrigTop15.map(bldgLabel),
    [{ label: 'Irrigation kGal', data: irrigTop15.map(b => b.total), backgroundColor: COLORS.irrigation }],
    { horizontal: true }
  );

  // ==================== BUILDINGS TAB ====================
  buildBuildingCards(data, elecByBldg, steamByBldg, chwEByBldg, domByBldg, irrigByBldg, months);

  // ==================== CONNECTORS TAB ====================
  renderKPIs('kpiConn', [
    { label: 'Total Connectors', value: fmt(data.connectors.length), sub: 'All connectors', cls: '',
      tooltip: 'All SkySpark connectors configured for the Pullman campus',
      expandHtml: connExpand },
    { label: 'OK', value: fmt(connOk), sub: Math.round(connOk / data.connectors.length * 100) + '% healthy', cls: 'ok',
      tooltip: 'Connectors actively collecting data without errors' },
    { label: 'Fault', value: fmt(connFault), sub: 'Needs investigation', cls: 'fault',
      tooltip: 'Connectors with errors  check connector table below for details' },
    { label: 'Disabled', value: fmt(connDisabled + connOther), sub: 'Intentionally off + other', cls: '',
      tooltip: 'Connectors intentionally disabled or in an unknown state' }
  ]);
  buildConnectorTable(data.connectors);

  // ==================== DATA INFO TAB ====================
  const fileMeta = [
    { file: 'electric.json', rows: data.electric.length, desc: 'Electric consumption (kWh), Export Format' },
    { file: 'condensate.json', rows: data.condensate.length, desc: 'Steam condensate (lb), Export Format' },
    { file: 'domestic_water.json', rows: data.domesticWater.length, desc: 'Domestic water (gal), Export Format' },
    { file: 'irrigation.json', rows: data.irrigation.length, desc: 'Irrigation water (gal), Export Format' },
    { file: 'chw.json', rows: data.chw.length, desc: 'CHW energy (tonrefh), Export Format' },
    { file: 'sites.json', rows: data.sites.length, desc: 'Site/building metadata' },
    { file: 'connectors.json', rows: data.connectors.length, desc: 'Connector status records' }
  ];
  document.getElementById('tblFiles').innerHTML = fileMeta.map(f =>
    `<tr><td style="text-align:left"><code>${f.file}</code></td><td>${fmt(f.rows)}</td><td style="text-align:left">${f.desc}</td></tr>`
  ).join('');

}).catch(err => {
  document.getElementById('loading').innerHTML =
    '<div style="color:var(--red);text-align:center;"><h2>Error Loading Data</h2><p>' + err.message + '</p></div>';
});

// ============================================================
//  UTILITY TABLE BUILDER
// ============================================================
function buildUtilityTable(tableId, searchId, byBldg, months, unit) {
  const tbl = document.getElementById(tableId);
  const thead = tbl.querySelector('thead');
  const tbody = tbl.querySelector('tbody');

  // Header
  let hdr = '<tr><th style="text-align:left">Bldg #</th><th style="text-align:left">Building Name</th><th>14-mo Total</th>';
  months.forEach(m => { hdr += '<th>' + monthLabel(m) + '</th>'; });
  hdr += '</tr>';
  thead.innerHTML = hdr;

  // Sort by total descending
  const sorted = Object.values(byBldg).sort((a, b) => b.total - a.total);

  function renderRows(filter) {
    const q = (filter || '').toLowerCase();
    const rows = sorted.filter(b =>
      !q || b.bldgNo.toLowerCase().includes(q) || (b.bldgName || '').toLowerCase().includes(q)
    );
    tbody.innerHTML = rows.map(b => {
      let row = `<tr><td style="text-align:left">${b.bldgNo}</td><td style="text-align:left">${b.bldgName}</td><td><strong>${fmt(b.total, 1)}</strong></td>`;
      months.forEach(m => { row += `<td>${fmt(b.months[m] || 0, 1)}</td>`; });
      row += '</tr>';
      return row;
    }).join('');
  }

  renderRows('');
  if (searchId) {
    document.getElementById(searchId).addEventListener('input', function() { renderRows(this.value); });
  }
}

// ============================================================
//  BUILDING CARDS
// ============================================================
function buildBuildingCards(data, elecByBldg, steamByBldg, chwEByBldg, domByBldg, irrigByBldg, months) {
  const grid = document.getElementById('bldgGrid');
  const siteMap = {};
  data.sites.forEach(s => {
    const no = s.dis || '';
    siteMap[no] = {
      bldgNo: no,
      bldgName: s.building || '',
      area: s.area ? (s.area.val || s.area) : null
    };
  });

  // Merge all buildings that appear in any utility
  const allBldgNos = new Set();
  [elecByBldg, steamByBldg, chwEByBldg, domByBldg, irrigByBldg].forEach(map => {
    Object.keys(map).forEach(k => allBldgNos.add(k));
  });
  data.sites.forEach(s => { if (s.dis) allBldgNos.add(s.dis); });

  const buildings = [...allBldgNos].map(no => {
    const site = siteMap[no] || { bldgNo: no, bldgName: '' };
    return {
      bldgNo: no,
      bldgName: site.bldgName,
      area: site.area,
      elec: elecByBldg[no]?.total || 0,
      steam: steamByBldg[no]?.total || 0,
      chwE: chwEByBldg[no]?.total || 0,
      dom: domByBldg[no]?.total || 0,
      irrig: irrigByBldg[no]?.total || 0,
      elecMonths: elecByBldg[no]?.months || {},
      steamMonths: steamByBldg[no]?.months || {},
      chwEMonths: chwEByBldg[no]?.months || {},
      domMonths: domByBldg[no]?.months || {},
      irrigMonths: irrigByBldg[no]?.months || {}
    };
  }).sort((a, b) => {
    const totalA = a.elec + a.steam + a.chwE + a.dom + a.irrig;
    const totalB = b.elec + b.steam + b.chwE + b.dom + b.irrig;
    return totalB - totalA;
  });

  function renderCards(filter) {
    const q = (filter || '').toLowerCase();
    const filtered = buildings.filter(b =>
      !q || b.bldgNo.toLowerCase().includes(q) || b.bldgName.toLowerCase().includes(q)
    );

    grid.innerHTML = filtered.slice(0, 200).map(b => {
      let badges = '';
      if (b.elec > 0) badges += `<span class="badge electric">${fmt(b.elec, 0)} MMBtu</span>`;
      if (b.steam > 0) badges += `<span class="badge steam">${fmt(b.steam, 0)} MMBtu</span>`;
      if (b.chwE > 0) badges += `<span class="badge chw-energy">${fmt(b.chwE, 0)} MMBtu</span>`;
      if (b.dom > 0) badges += `<span class="badge domestic">${fmt(b.dom, 0)} kGal</span>`;
      if (b.irrig > 0) badges += `<span class="badge irrigation">${fmt(b.irrig, 0)} kGal</span>`;

      // Detail table
      let detailRows = '';
      months.forEach(m => {
        const ml = monthLabel(m);
        const eV = b.elecMonths[m] || 0;
        const sV = b.steamMonths[m] || 0;
        const cV = b.chwEMonths[m] || 0;
        const dV = b.domMonths[m] || 0;
        const iV = b.irrigMonths[m] || 0;
        if (eV || sV || cV || dV || iV) {
          detailRows += `<tr><td style="text-align:left">${ml}</td><td>${eV ? fmt(eV, 1) : '-'}</td><td>${sV ? fmt(sV, 1) : '-'}</td><td>${cV ? fmt(cV, 1) : '-'}</td><td>${dV ? fmt(dV, 1) : '-'}</td><td>${iV ? fmt(iV, 1) : '-'}</td></tr>`;
        }
      });

      return `<div class="bldg-card" onclick="this.classList.toggle('expanded')">
        <h3>${b.bldgName || b.bldgNo}</h3>
        <div class="bldg-no">${b.bldgNo}${b.area ? ' &bull; ' + fmt(b.area, 0) + ' ft&sup2;' : ''}</div>
        <div class="bldg-badges">${badges || '<span style="color:var(--text-light);font-size:0.78rem;">No metered data</span>'}</div>
        <div class="bldg-detail">
          <table>
            <thead><tr><th style="text-align:left">Month</th><th>Elec</th><th>Steam</th><th>CHW E</th><th>Dom W</th><th>Irrig</th></tr></thead>
            <tbody>${detailRows || '<tr><td colspan="6" style="text-align:center;color:var(--text-light);">No data</td></tr>'}</tbody>
          </table>
        </div>
      </div>`;
    }).join('');
  }

  renderCards('');
  document.getElementById('searchBldg').addEventListener('input', function() { renderCards(this.value); });
}

// ============================================================
//  CONNECTOR TABLE
// ============================================================
function buildConnectorTable(connectors) {
  const tbl = document.getElementById('tblConn');
  const thead = tbl.querySelector('thead');
  const tbody = tbl.querySelector('tbody');

  thead.innerHTML = '<tr><th style="text-align:left">Connector</th><th style="text-align:left">Status</th><th style="text-align:left">Error</th></tr>';

  const sorted = [...connectors].sort((a, b) => {
    const order = { fault: 0, disabled: 1, ok: 2 };
    return (order[a.connStatus] ?? 3) - (order[b.connStatus] ?? 3);
  });

  function renderRows(filter) {
    const rows = filter === 'all' ? sorted : sorted.filter(c => c.connStatus === filter);
    tbody.innerHTML = rows.map(c => {
      const status = c.connStatus || 'unknown';
      const dotCls = status === 'ok' ? 'ok' : status === 'fault' ? 'fault' : 'disabled';
      return `<tr><td style="text-align:left">${c.dis || ''}</td><td style="text-align:left"><span class="dot ${dotCls}"></span>${status}</td><td style="text-align:left;font-size:0.75rem;color:var(--text-light);">${c.connErr || ''}</td></tr>`;
    }).join('');
  }

  renderRows('all');

  document.querySelectorAll('#connFilterBar .filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#connFilterBar .filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderRows(btn.dataset.filter);
    });
  });
}
</script>
</body>
</html>

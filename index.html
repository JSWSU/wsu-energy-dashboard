<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WSU Energy Cost Projection - FY2026</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  :root {
    --primary: #981e32;
    --primary-dark: #7a1828;
    --secondary: #5f6b6d;
    --accent: #c69214;
    --bg: #f5f5f5;
    --card-bg: #fff;
    --text: #2d2d2d;
    --text-light: #6b7280;
    --border: #e5e7eb;
    --green: #059669;
    --red: #dc2626;
    --blue: #2563eb;
    --forecast-blue: #3b82f6;
    --table-head-bg: #f9fafb;
    --table-hover: #f9fafb;
    --total-row-bg: #f0f4ff;
    --notes-bg: #fffbeb;
    --notes-border: #fde68a;
    --notes-text: #92400e;
    --info-bg: #f0f9ff;
    --info-border: #bae6fd;
    --info-text: #0c4a6e;
    --mini-row-border: #f3f4f6;
  }
  html.dark {
    --bg: #111827;
    --card-bg: #1f2937;
    --text: #e5e7eb;
    --text-light: #9ca3af;
    --border: #374151;
    --secondary: #9ca3af;
    --green: #34d399;
    --red: #f87171;
    --forecast-blue: #60a5fa;
    --table-head-bg: #1a2332;
    --table-hover: #253347;
    --total-row-bg: #1e293b;
    --notes-bg: #292524;
    --notes-border: #78716c;
    --notes-text: #fbbf24;
    --info-bg: #1e293b;
    --info-border: #334155;
    --info-text: #7dd3fc;
    --mini-row-border: #374151;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
  }
  header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: #fff;
    padding: 1.5rem 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  header h1 { font-size: 1.6rem; font-weight: 700; }
  header p { opacity: 0.85; font-size: 0.9rem; margin-top: 0.25rem; }
  .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
  .nav-tabs {
    display: flex; gap: 0.25rem; background: var(--card-bg); border-radius: 8px;
    padding: 0.25rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); overflow-x: auto;
  }
  .nav-tab {
    padding: 0.6rem 1.2rem; border: none; background: transparent; border-radius: 6px;
    cursor: pointer; font-size: 0.85rem; font-weight: 500; color: var(--text-light);
    white-space: nowrap; transition: all 0.2s;
  }
  .nav-tab:hover { background: var(--table-hover); color: var(--text); }
  .nav-tab.active { background: var(--primary); color: #fff; }
  .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
  .kpi-card { background: var(--card-bg); border-radius: 10px; padding: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border-left: 4px solid var(--primary); }
  .kpi-card.forecast { border-left-color: var(--forecast-blue); }
  .kpi-card.delta { border-left-color: var(--accent); }
  .kpi-card.energy { border-left-color: var(--green); }
  .kpi-label { font-size: 0.78rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em; }
  .kpi-value { font-size: 1.8rem; font-weight: 700; margin: 0.25rem 0; }
  .kpi-sub { font-size: 0.8rem; color: var(--text-light); }
  .kpi-value.blue { color: var(--forecast-blue); }
  .kpi-value.green { color: var(--green); }
  .kpi-value.red { color: var(--red); }
  .card { background: var(--card-bg); border-radius: 10px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 1.5rem; }
  .card h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
  .card h3 { font-size: 0.95rem; font-weight: 600; margin: 1rem 0 0.75rem; color: var(--secondary); }
  .chart-container { position: relative; height: 350px; width: 100%; }
  .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
  @media (max-width: 900px) { .chart-row { grid-template-columns: 1fr; } }
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
  thead th { background: var(--table-head-bg); padding: 0.6rem 0.75rem; text-align: right; font-weight: 600; color: var(--secondary); border-bottom: 2px solid var(--border); white-space: nowrap; }
  thead th:first-child { text-align: left; }
  tbody td { padding: 0.5rem 0.75rem; text-align: right; border-bottom: 1px solid var(--border); }
  tbody td:first-child { text-align: left; font-weight: 500; }
  tbody tr:hover { background: var(--table-hover); }
  tbody tr.total-row { font-weight: 700; background: var(--total-row-bg); border-top: 2px solid var(--primary); }
  tbody tr.delta-row { color: var(--text-light); font-style: italic; }
  td.forecast { color: var(--forecast-blue); font-style: italic; }
  td.positive { color: var(--green); }
  td.negative { color: var(--red); }
  .section { display: none; }
  .section.active { display: block; }
  .notes { background: var(--notes-bg); border: 1px solid var(--notes-border); border-radius: 8px; padding: 1rem 1.25rem; font-size: 0.82rem; color: var(--notes-text); margin-top: 1rem; }
  .notes ul { margin: 0.5rem 0 0 1.25rem; }
  .notes li { margin-bottom: 0.25rem; }
  .legend { display: flex; gap: 1.5rem; margin-bottom: 0.75rem; font-size: 0.8rem; flex-wrap: wrap; }
  .legend-item { display: flex; align-items: center; gap: 0.35rem; }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
  footer { text-align: center; padding: 1.5rem; color: var(--text-light); font-size: 0.78rem; border-top: 1px solid var(--border); margin-top: 2rem; }
  @media print { header { print-color-adjust: exact; -webkit-print-color-adjust: exact; } .nav-tabs { display: none; } .section { display: block !important; page-break-inside: avoid; } #authGate { display: none !important; } .kpi-tooltip { display: none !important; } .kpi-expand { max-height: none !important; opacity: 1 !important; } .kpi-expand-icon { display: none !important; } }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loading { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column; gap: 1rem; }
  #error { position: fixed; inset: 0; background: var(--bg); align-items: center; justify-content: center; z-index: 9999; flex-direction: column; gap: 1rem; padding: 2rem; text-align: center; }
  .verified { display: inline-flex; align-items: center; gap: 0.3rem; background: #ecfdf5; color: #059669; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.72rem; font-weight: 600; }
  /* --- Auth Gate --- */
  #authGate {
    position: fixed; inset: 0; z-index: 99999; background: var(--bg);
    display: flex; align-items: center; justify-content: center; flex-direction: column;
  }
  #authGate .auth-header {
    position: absolute; top: 0; left: 0; right: 0;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: #fff; padding: 1.5rem 2rem; text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  #authGate .auth-header h1 { font-size: 1.4rem; font-weight: 700; }
  #authGate .auth-header p { opacity: 0.85; font-size: 0.85rem; margin-top: 0.25rem; }
  #authGate .auth-card {
    background: var(--card-bg); border-radius: 12px; padding: 2.5rem 2rem;
    box-shadow: 0 4px 24px rgba(0,0,0,0.1); text-align: center;
    width: 100%; max-width: 380px; margin-top: 60px;
  }
  #authGate .auth-card h2 { font-size: 1.1rem; color: var(--text); margin-bottom: 0.5rem; }
  #authGate .auth-card p { font-size: 0.82rem; color: var(--text-light); margin-bottom: 1.5rem; }
  #authGate .auth-input {
    width: 100%; padding: 0.75rem 1rem; border: 2px solid var(--border); border-radius: 8px;
    font-size: 0.95rem; outline: none; transition: border-color 0.2s;
  }
  #authGate .auth-input:focus { border-color: var(--primary); }
  #authGate .auth-btn {
    width: 100%; padding: 0.75rem; margin-top: 1rem; border: none; border-radius: 8px;
    background: var(--primary); color: #fff; font-size: 0.95rem; font-weight: 600;
    cursor: pointer; transition: background 0.2s;
  }
  #authGate .auth-btn:hover { background: var(--primary-dark); }
  #authGate .auth-error {
    color: var(--red); font-size: 0.8rem; margin-top: 0.75rem; min-height: 1.2rem;
  }
  /* --- Interactive KPI Cards --- */
  .kpi-card {
    cursor: pointer; transition: box-shadow 0.2s ease, transform 0.15s ease; position: relative;
  }
  .kpi-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.12); transform: translateY(-2px);
  }
  .kpi-tooltip {
    visibility: hidden; opacity: 0; position: absolute; bottom: calc(100% + 8px); left: 50%;
    transform: translateX(-50%); background: #1f2937; color: #fff; font-size: 0.75rem;
    line-height: 1.4; padding: 0.5rem 0.75rem; border-radius: 6px; white-space: normal;
    width: max-content; max-width: 260px; z-index: 100; pointer-events: none;
    transition: opacity 0.2s ease, visibility 0.2s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .kpi-tooltip::after {
    content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
    border: 6px solid transparent; border-top-color: #1f2937;
  }
  .kpi-card:hover .kpi-tooltip { visibility: visible; opacity: 1; }
  .kpi-expand {
    max-height: 0; overflow: hidden;
    transition: max-height 0.35s ease, margin-top 0.35s ease, opacity 0.25s ease;
    opacity: 0; margin-top: 0;
  }
  .kpi-card.expanded .kpi-expand { max-height: 500px; opacity: 1; margin-top: 0.75rem; }
  .kpi-card.expanded { box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
  .kpi-expand-icon {
    position: absolute; top: 0.75rem; right: 0.75rem; font-size: 0.7rem;
    color: var(--text-light); transition: transform 0.3s ease;
  }
  .kpi-card.expanded .kpi-expand-icon { transform: rotate(180deg); }
  .kpi-mini-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
  .kpi-mini-table th {
    text-align: left; font-weight: 600; color: var(--secondary); padding: 0.3rem 0.5rem;
    border-bottom: 2px solid var(--border); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.03em;
  }
  .kpi-mini-table th:not(:first-child) { text-align: right; }
  .kpi-mini-table td { padding: 0.25rem 0.5rem; border-bottom: 1px solid var(--mini-row-border); }
  .kpi-mini-table td:not(:first-child) { text-align: right; font-variant-numeric: tabular-nums; }
  .kpi-mini-table tr:last-child { font-weight: 700; border-top: 2px solid var(--primary); }
  .kpi-mini-table tr:last-child td { border-bottom: none; padding-top: 0.4rem; }
  /* --- Dark Mode Toggle --- */
  .dark-toggle {
    display: flex; align-items: center; gap: 0.5rem; position: absolute; right: 2rem; top: 50%; transform: translateY(-50%);
  }
  .dark-toggle-label { font-size: 0.75rem; opacity: 0.85; color: #fff; }
  .dark-toggle-switch {
    position: relative; width: 40px; height: 22px; background: rgba(255,255,255,0.25);
    border-radius: 11px; cursor: pointer; transition: background 0.3s; border: none; padding: 0;
  }
  .dark-toggle-switch::after {
    content: ''; position: absolute; top: 3px; left: 3px; width: 16px; height: 16px;
    background: #fff; border-radius: 50%; transition: transform 0.3s;
  }
  html.dark .dark-toggle-switch { background: var(--accent); }
  html.dark .dark-toggle-switch::after { transform: translateX(18px); }
  header { position: relative; }
  html.dark .auth-card { background: var(--card-bg); }
  html.dark #authGate { background: var(--bg); }
  html.dark #authGate .auth-input { background: var(--bg); color: var(--text); border-color: var(--border); }
  html.dark #authGate .auth-card h2 { color: var(--text); }
  html.dark #authGate .auth-card p { color: var(--text-light); }
  html.dark #loading { background: var(--bg); }
  html.dark #loading p { color: var(--text-light); }
  @media (max-width: 600px) {
    .kpi-tooltip { max-width: 200px; font-size: 0.7rem; }
    .dark-toggle { position: static; transform: none; margin-top: 0.5rem; }
  }
</style>
</head>
<body>

<div id="authGate">
  <div class="auth-header">
    <h1>WSU Energy Cost Projection</h1>
    <p>FY2026 Dashboard &bull; WSU Facilities Services</p>
  </div>
  <div class="auth-card">
    <h2>Authorized Access Only</h2>
    <p>Enter the password to view the energy dashboard.</p>
    <input type="password" class="auth-input" id="authInput" placeholder="Password" autocomplete="off">
    <button class="auth-btn" id="authBtn">Sign In</button>
    <div class="auth-error" id="authError"></div>
  </div>
</div>

<div id="loading">
  <div style="width:40px;height:40px;border:4px solid #e5e7eb;border-top-color:#981e32;border-radius:50%;animation:spin 0.8s linear infinite;"></div>
  <p style="color:#6b7280;">Loading energy data...</p>
</div>
<div id="error" style="display:none;">
  <div style="font-size:2rem;">&#9888;&#65039;</div>
  <h2 style="color:#981e32;">Could not load data</h2>
  <p style="color:#6b7280;max-width:500px;" id="errorMsg"></p>
</div>

<header>
  <h1>WSU Energy Cost Projection Workbook &amp; Report</h1>
  <p>FY2026 (July 2025 &ndash; June 2026) &bull; Last Updated: <span id="lastUpdated">...</span> <span id="verifiedBadge"></span></p>
  <div class="dark-toggle">
    <span class="dark-toggle-label">Dark Mode</span>
    <button class="dark-toggle-switch" id="darkToggle" aria-label="Toggle dark mode"></button>
  </div>
</header>
<div class="container">
  <div class="nav-tabs">
    <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
    <button class="nav-tab" data-tab="monthly">Monthly Detail</button>
    <button class="nav-tab" data-tab="gas">Gas Analysis</button>
    <button class="nav-tab" data-tab="energy-use">Energy Use</button>
    <button class="nav-tab" data-tab="yoy">Year-over-Year</button>
    <button class="nav-tab" data-tab="cumulative">Cumulative Summary</button>
    <button class="nav-tab" data-tab="variance">Price vs Volume</button>
    <button class="nav-tab" data-tab="hdd">HDD / Weather</button>
    <button class="nav-tab" data-tab="sources">Data Sources</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="section active">
    <div class="kpi-grid">
      <div class="kpi-card" data-kpi="actualYTD">
        <span class="kpi-expand-icon">&#9660;</span>
        <span class="kpi-tooltip">Sum of actual energy costs paid to date plus forecasted costs for remaining months, across all WSU Pullman Facility Services utility accounts (see Data Sources tab for full list).</span>
        <div class="kpi-label">FY2026 Actual + Forecast</div>
        <div class="kpi-value"><span id="kpiActualYTD">--</span></div>
        <div class="kpi-sub">Actuals to date plus forecast for remaining months</div>
        <div class="kpi-expand"></div>
      </div>
      <div class="kpi-card forecast" data-kpi="forecast">
        <span class="kpi-expand-icon">&#9660;</span>
        <span class="kpi-tooltip">Projected total energy cost for the full fiscal year, using CY2024&ndash;2025 growth trends with a price hedge adjustment.</span>
        <div class="kpi-label">FY2026 Forecast</div>
        <div class="kpi-value blue"><span id="kpiForecast">--</span></div>
        <div class="kpi-sub">Projected full-year cost</div>
        <div class="kpi-expand"></div>
      </div>
      <div class="kpi-card delta" data-kpi="delta">
        <span class="kpi-expand-icon">&#9660;</span>
        <span class="kpi-tooltip">Cumulative difference between forecast and actual costs. Positive = under budget; negative = over budget.</span>
        <div class="kpi-label">Forecast vs Actual</div>
        <div class="kpi-value red"><span id="kpiDelta">--</span></div>
        <div class="kpi-sub"><span id="kpiDeltaPct">--</span></div>
        <div class="kpi-expand"></div>
      </div>
      <div class="kpi-card energy" data-kpi="mmbtu">
        <span class="kpi-expand-icon">&#9660;</span>
        <span class="kpi-tooltip">Total energy consumed in MMBTU (Million BTU), combining electricity and natural gas across all campus facilities.</span>
        <div class="kpi-label">Total Energy Use (YTD)</div>
        <div class="kpi-value"><span id="kpiMMBTU">--</span></div>
        <div class="kpi-sub"><span id="kpiMMBTUSub">--</span></div>
        <div class="kpi-expand"></div>
      </div>
    </div>
    <div class="kpi-grid">
      <div class="kpi-card" data-kpi="elecCost">
        <span class="kpi-expand-icon">&#9660;</span>
        <span class="kpi-tooltip">Electricity cost year-to-date for WSU Pullman Facility Services accounts including Avista and Inland Power. See Data Sources tab for the full account list.</span>
        <div class="kpi-label">Electric Cost (YTD)</div>
        <div class="kpi-value"><span id="kpiElecCost">--</span></div>
        <div class="kpi-sub"><span id="kpiElecPct">--</span></div>
        <div class="kpi-expand"></div>
      </div>
      <div class="kpi-card" data-kpi="gasCost">
        <span class="kpi-expand-icon">&#9660;</span>
        <span class="kpi-tooltip">Natural gas cost year-to-date for WSU Pullman Facility Services accounts, combining Kintec commodity delivery and Avista distribution charges. See Data Sources tab for the full account list.</span>
        <div class="kpi-label">Gas Cost (YTD)</div>
        <div class="kpi-value"><span id="kpiGasCost">--</span></div>
        <div class="kpi-sub"><span id="kpiGasPct">--</span></div>
        <div class="kpi-expand"></div>
      </div>
      <div class="kpi-card forecast" data-kpi="elecRate">
        <span class="kpi-expand-icon">&#9660;</span>
        <span class="kpi-tooltip">Average $/MMBTU for electricity. Expand to see per-kWh rates each month.</span>
        <div class="kpi-label">Avg Elec Rate</div>
        <div class="kpi-value blue"><span id="kpiElecRate">--</span></div>
        <div class="kpi-sub"><span id="kpiElecRateSub">--</span></div>
        <div class="kpi-expand"></div>
      </div>
      <div class="kpi-card forecast" data-kpi="gasRate">
        <span class="kpi-expand-icon">&#9660;</span>
        <span class="kpi-tooltip">Average $/MMBTU for natural gas. Reflects blended Kintec commodity and Avista distribution pricing.</span>
        <div class="kpi-label">Avg Gas Rate</div>
        <div class="kpi-value blue"><span id="kpiGasRate">--</span></div>
        <div class="kpi-sub"><span id="kpiGasRateSub">--</span></div>
        <div class="kpi-expand"></div>
      </div>
    </div>
    <div class="chart-row">
      <div class="card">
        <h2>Monthly Total Energy Cost</h2>
        <div class="legend">
          <span class="legend-item"><span class="legend-dot" style="background:#981e32"></span> Actual</span>
          <span class="legend-item"><span class="legend-dot" style="background:#3b82f6"></span> Forecast</span>
        </div>
        <div class="chart-container"><canvas id="chartMonthly"></canvas></div>
      </div>
      <div class="card">
        <h2>Cost Breakdown: Electric vs Gas</h2>
        <div class="chart-container"><canvas id="chartBreakdown"></canvas></div>
      </div>
    </div>
    <div class="chart-row">
      <div class="card">
        <h2>Energy Use by Fuel Type (MMBTU)</h2>
        <div class="chart-container"><canvas id="chartMMBTU"></canvas></div>
      </div>
      <div class="card">
        <h2>FY2026 Cost Distribution</h2>
        <div class="chart-container"><canvas id="chartPie"></canvas></div>
      </div>
    </div>
  </div>

  <!-- MONTHLY DETAIL -->
  <div id="monthly" class="section">
    <div class="card">
      <h2>FY2026 Actuals vs Forecasts</h2>
      <div class="legend">
        <span class="legend-item"><span class="legend-dot" style="background:#981e32"></span> Actual (bold)</span>
        <span class="legend-item"><span class="legend-dot" style="background:#3b82f6"></span> Forecast (blue italic)</span>
      </div>
      <div class="table-wrap">
        <table id="tableMonthly"><thead><tr>
          <th>Month</th><th>Total Cost (Actual)</th><th>Electric (Actual)</th><th>Gas (Actual)</th>
          <th>Total Cost (Forecast)</th><th>Electric (Forecast)</th><th>Gas (Forecast)</th>
          <th>Kintec Gas</th><th>Avista Gas</th><th>Hedge %</th>
        </tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <!-- GAS ANALYSIS -->
  <div id="gas" class="section">
    <div class="card"><h2>FY2025 Gas MMBTU / Cost</h2><div class="chart-container"><canvas id="chartGas25"></canvas></div></div>
    <div class="card"><div class="table-wrap">
      <table id="tableGas25"><thead><tr>
        <th>Month</th><th>Gas Cost (Actual)</th><th>Gas MMBTU</th><th>Gas $/MMBTU</th><th>Kintec $</th><th>Avista $</th>
      </tr></thead><tbody></tbody></table>
    </div></div>
    <div class="card"><h2>Kintec Gas Delivery (All Months)</h2><div class="chart-container"><canvas id="chartKintec"></canvas></div></div>
  </div>

  <!-- ENERGY USE -->
  <div id="energy-use" class="section">
    <div class="card"><h2>FY2026 Energy Use: Actual vs Forecast</h2><div class="chart-container"><canvas id="chartEnergyUse"></canvas></div></div>
    <div class="card"><div class="table-wrap">
      <table id="tableEnergyUse"><thead><tr>
        <th>Month</th><th>Total MMBTU (Actual)</th><th>Elec MMBTU (Actual)</th><th>Gas MMBTU (Actual)</th>
        <th>Total MMBTU (Forecast)</th><th>Total kWh</th><th>kWh $/Unit</th>
      </tr></thead><tbody></tbody></table>
    </div></div>
  </div>

  <!-- YEAR OVER YEAR -->
  <div id="yoy" class="section">
    <div class="card"><h2>Fiscal Year MMBTU Comparison (FY2025 vs FY2026)</h2><div class="chart-container"><canvas id="chartYoY"></canvas></div></div>
    <div class="card"><div class="table-wrap">
      <table id="tableYoY"><thead><tr>
        <th>Month</th>
        <th>FY25 Total</th><th>FY25 Elec</th><th>FY25 Gas</th>
        <th>FY26 Total</th><th>FY26 Elec</th><th>FY26 Gas</th>
      </tr></thead><tbody></tbody></table>
    </div>
    <div class="notes"><strong>Year-over-Year Change:</strong><ul id="yoyNotes"></ul></div>
    </div>
  </div>

  <!-- CUMULATIVE SUMMARY -->
  <div id="cumulative" class="section">
    <div class="card"><h2>FY2026 Cumulative Cost: Actual vs Forecast</h2><div class="chart-container"><canvas id="chartCumulative"></canvas></div></div>
    <div class="card"><div class="table-wrap">
      <table id="tableCumulative"><thead><tr>
        <th>Month</th><th>Cumul. Actual ($)</th><th>Cumul. Forecast ($)</th><th>Delta ($)</th><th>Delta %</th>
        <th>Cumul. MMBTU (Actual)</th><th>Cumul. MMBTU (Fcast)</th><th>MMBTU Delta</th><th>MMBTU Delta %</th>
      </tr></thead><tbody></tbody></table>
    </div></div>
  </div>

  <!-- PRICE vs VOLUME VARIANCE -->
  <div id="variance" class="section">
    <div class="chart-row">
      <div class="card"><h2>FY25 vs FY26 Cost Comparison</h2><div class="chart-container"><canvas id="chartVarianceCost"></canvas></div></div>
      <div class="card"><h2>FY25 vs FY26 MMBTU Comparison</h2><div class="chart-container"><canvas id="chartVarianceMmbtu"></canvas></div></div>
    </div>
    <div class="card"><h2>Price vs Volume Variance Analysis</h2><div class="table-wrap">
      <table id="tableVariance"><thead><tr>
        <th>Month</th><th>FY25 Cost</th><th>FY26 Cost</th><th>$ Variance</th>
        <th>FY25 MMBTU</th><th>FY26 MMBTU</th><th>MMBTU Var.</th><th>MMBTU %</th>
        <th>FY25 HDD</th><th>FY26 HDD</th><th>HDD %</th><th>30-Yr Normal</th>
      </tr></thead><tbody></tbody></table>
    </div></div>
  </div>

  <!-- HDD / WEATHER -->
  <div id="hdd" class="section">
    <div class="card"><h2>Heating Degree Days - Pullman-Moscow Airport (KPUW)</h2><div class="chart-container"><canvas id="chartHDD"></canvas></div></div>
    <div class="card"><div class="table-wrap">
      <table id="tableHDD"><thead><tr>
        <th>Month</th><th>FY2025 HDD</th><th>FY2026 HDD</th><th>30-Yr Normal</th>
      </tr></thead><tbody></tbody></table>
    </div>
    <div class="notes"><strong>Notes:</strong><ul>
      <li>Source: NWS Spokane (KOTX) CLM/CLI Reports for KPUW via NOAA ACIS API</li>
      <li>HDD measures cold relative to 65&deg;F. Higher HDD = more heating energy consumed</li>
      <li>Forecast months use 30-year normals (1991&ndash;2020) until actual data is published</li>
      <li><span id="hddTotals">--</span></li>
    </ul></div></div>
  </div>

  <!-- DATA SOURCES -->
  <div id="sources" class="section">
    <div class="card">
      <h2>Data Sources &amp; Accounts</h2>
      <h3>Avista Utilities</h3>
      <div class="table-wrap"><table><thead><tr><th>Account Name</th><th>Account #</th><th>Description</th></tr></thead><tbody>
        <tr><td>WSU FACILITIES SERVICES</td><td>***620000</td><td>Small account - Gas &amp; Electric</td></tr>
        <tr><td>WSU FACILITIES SERVICES</td><td>***670000</td><td>Small account - Gas &amp; Electric</td></tr>
        <tr><td>WSU FACILITIES SERVICES</td><td>***650000</td><td>Small / Large account</td></tr>
        <tr><td>WSU FACILITIES SERVICES</td><td>***100000</td><td>Large account</td></tr>
        <tr><td>WSU FACILITIES SERVICES</td><td>***100000</td><td>Large account</td></tr>
        <tr><td>WSU FACILITIES SERVICES</td><td>***220000</td><td>Large account</td></tr>
        <tr><td>WSU FACILITIES SERVICES</td><td>***350762</td><td>Large account</td></tr>
        <tr><td>WSU FACILITIES SERVICES</td><td>***550000</td><td>Small account - Gas &amp; Electric</td></tr>
        <tr><td>WSU FACILITIES SERVICES</td><td>***100000</td><td>Small account - Gas only</td></tr>
        <tr><td>WSU FACILITIES SERVICES</td><td>***840000</td><td>Small account - Gas only</td></tr>
        <tr><td>WSU FACILITIES SERVICES</td><td>***033237</td><td>Small account - Electric only</td></tr>
        <tr><td>WSU FACILITIES SERVICES</td><td>***710000</td><td>Large account</td></tr>
      </tbody></table></div>
      <h3>Inland Power</h3>
      <p style="font-size:0.85rem;color:var(--text-light);margin-bottom:0.5rem;">Electric service for outlying WSU facilities. Data sourced from Inland Power bills.</p>
      <h3>Kintec (Gas Supplier)</h3>
      <p style="font-size:0.85rem;color:var(--text-light);">Natural gas commodity delivery (Dekatherms). Primary gas cost source via monthly invoices.</p>
    </div>
    <div class="card">
      <h2>Methodology Notes</h2>
      <div class="notes" style="background:var(--info-bg);border-color:var(--info-border);color:var(--info-text);"><ul>
        <li>Actuals shown in bold black; Forecasts in blue italic</li>
        <li>Forecasts calculated using CY2024&ndash;CY2025 annual growth trend applied to CY2025 same-month values</li>
        <li>All data dynamically sourced from Consolidated Data table (Avista, Inland Power, Kintec Gas)</li>
        <li>Data read from &ldquo;Executive Summary (Print)&rdquo; sheet, cross-checked against Consolidated Data</li>
        <li>FY2026 = July 2025 through June 2026; FY2025 = July 2024 through June 2025</li>
        <li>Price hedge / contingency applied to all forecast months</li>
      </ul></div>
    </div>
  </div>
</div>

<footer>
  WSU Facilities Services &bull; Energy Cost Projection Workbook &amp; Report FY2026 &bull; Data as of <span id="footerDate">--</span>
</footer>

<script>
const MONTHS = ['Jul','Aug','Sep','Oct','Nov','Dec','Jan','Feb','Mar','Apr','May','Jun'];
const MONTH_FULL = ['July 2025','August 2025','September 2025','October 2025','November 2025','December 2025',
  'January 2026','February 2026','March 2026','April 2026','May 2026','June 2026'];

const fmtDollar = v => '$' + v.toLocaleString('en-US');
const fmtDollarM = v => '$' + (v/1e6).toFixed(2) + 'M';
const fmtNum = v => v.toLocaleString('en-US');
const fmtPct = v => v.toFixed(1) + '%';
const fmtRate = v => '$' + v.toFixed(2);
const fmtRateKwh = v => '$' + v.toFixed(4);
const sum = arr => arr.reduce((a, b) => a + b, 0);

Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
Chart.defaults.font.size = 12;
Chart.defaults.plugins.legend.labels.usePointStyle = true;
Chart.defaults.plugins.legend.labels.padding = 16;
if (document.documentElement.classList.contains('dark')) {
  Chart.defaults.color = '#9ca3af';
  Chart.defaults.borderColor = 'rgba(75,85,99,0.3)';
  Chart.defaults.plugins.legend.labels.color = '#9ca3af';
}

const C = {
  primary:'#981e32', primaryLight:'rgba(152,30,50,0.15)',
  blue:'#3b82f6', blueLight:'rgba(59,130,246,0.15)',
  green:'#059669', greenLight:'rgba(5,150,105,0.15)',
  accent:'#c69214', accentLight:'rgba(198,146,20,0.15)',
  gray:'#6b7280', grayLight:'rgba(107,114,128,0.15)',
  purple:'#7c3aed', orange:'#ea580c'
};

// ==================== AUTH GATE ====================
(function() {
  const gate = document.getElementById('authGate');
  const input = document.getElementById('authInput');
  const btn = document.getElementById('authBtn');
  const err = document.getElementById('authError');
  if (sessionStorage.getItem('wsuEnergyAuth') === 'ok') {
    gate.style.display = 'none';
  }
  function tryAuth() {
    if (input.value === 'Energy@WSU') {
      sessionStorage.setItem('wsuEnergyAuth', 'ok');
      gate.style.display = 'none';
      err.textContent = '';
    } else {
      err.textContent = 'Incorrect password. Please try again.';
      input.value = '';
      input.focus();
    }
  }
  btn.addEventListener('click', tryAuth);
  input.addEventListener('keydown', function(e) { if (e.key === 'Enter') tryAuth(); });
})();

// ==================== DARK MODE ====================
(function() {
  const toggle = document.getElementById('darkToggle');
  if (localStorage.getItem('wsuDarkMode') === 'on') {
    document.documentElement.classList.add('dark');
  }
  toggle.addEventListener('click', function() {
    document.documentElement.classList.toggle('dark');
    localStorage.setItem('wsuDarkMode', document.documentElement.classList.contains('dark') ? 'on' : 'off');
  });
})();

// Tab navigation
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  });
});

// ==================== LOAD DATA & BUILD ====================
function initDashboard(D) {
  const fy26 = D.fy26, fy25gas = D.fy25gas, energyUse = D.energyUse,
        yoy = D.yoy, cumul = D.cumul, hdd = D.hdd, kintec = D.kintec,
        variance = D.variance;

  // --- KPI Cards ---
  const totalAct = sum(fy26.totalActual), totalFcast = sum(fy26.totalFcast);
  const totalElec = sum(fy26.elecActual), totalGas = sum(fy26.gasActual);
  const totalMMBTU = sum(energyUse.totalActual);
  const totalElecMMBTU = sum(energyUse.elecActual), totalGasMMBTU = sum(energyUse.gasActual);
  // Use the authoritative delta from the cumulative summary (last month = full-year projection)
  // This correctly accounts for actual months replacing forecasts
  const last = cumul.delta.length - 1;
  const delta = cumul.delta[last];
  const deltaPct = cumul.deltaPct[last];

  // Compute rates from cost/MMBTU (since cumul no longer has elecRate/gasRate)
  const elecRateAct = totalElecMMBTU > 0 ? totalElec / totalElecMMBTU : 0;
  const gasRateAct = totalGasMMBTU > 0 ? totalGas / totalGasMMBTU : 0;
  const elecRateFcast = sum(energyUse.elecActual) > 0 ? sum(fy26.elecFcast) / sum(energyUse.elecActual) : 0;
  const gasRateFcast = sum(energyUse.gasActual) > 0 ? sum(fy26.gasFcast) / sum(energyUse.gasActual) : 0;

  document.getElementById('kpiActualYTD').textContent = fmtDollarM(totalAct);
  document.getElementById('kpiForecast').textContent = fmtDollarM(totalFcast);
  const deltaSign = delta >= 0 ? '+' : '-';
  document.getElementById('kpiDelta').textContent = deltaSign + fmtDollarM(Math.abs(delta));
  document.getElementById('kpiDeltaPct').textContent = fmtPct(deltaPct) + (delta >= 0 ? ' over actuals' : ' under actuals');
  document.getElementById('kpiMMBTU').textContent = fmtNum(totalMMBTU);
  document.getElementById('kpiMMBTUSub').textContent = 'MMBTU (Elec: ' + fmtNum(totalElecMMBTU) + ' | Gas: ' + fmtNum(totalGasMMBTU) + ')';
  document.getElementById('kpiElecCost').textContent = fmtDollarM(totalElec);
  document.getElementById('kpiElecPct').textContent = (totalElec / totalAct * 100).toFixed(1) + '% of total';
  document.getElementById('kpiGasCost').textContent = fmtDollarM(totalGas);
  document.getElementById('kpiGasPct').textContent = (totalGas / totalAct * 100).toFixed(1) + '% of total (Kintec + Avista)';
  document.getElementById('kpiElecRate').textContent = fmtRate(elecRateAct);
  document.getElementById('kpiElecRateSub').textContent = '$/MMBTU actual | ' + fmtRate(elecRateFcast) + ' forecast';
  document.getElementById('kpiGasRate').textContent = fmtRate(gasRateAct);
  document.getElementById('kpiGasRateSub').textContent = '$/MMBTU actual | ' + fmtRate(gasRateFcast) + ' forecast';
  document.getElementById('lastUpdated').textContent = D.lastUpdated;
  document.getElementById('footerDate').textContent = D.lastUpdated;

  // Verification badge
  if (D.verification) {
    document.getElementById('verifiedBadge').innerHTML = '<span class="verified">Verified vs Consolidated Data</span>';
  }

  // --- KPI Expand Content Config ---
  const kpiExpandConfig = {
    actualYTD: {
      headers: ['Month', 'Total Cost'],
      rows: (i) => [MONTHS[i], fmtDollar(fy26.totalActual[i])],
      totalLabel: 'FY Total',
      totals: () => [fmtDollar(totalAct)]
    },
    forecast: {
      headers: ['Month', 'Total Forecast'],
      rows: (i) => [MONTHS[i], fmtDollar(fy26.totalFcast[i])],
      totalLabel: 'FY Total',
      totals: () => [fmtDollar(totalFcast)]
    },
    delta: {
      headers: ['Month', 'Cumul. Actual', 'Cumul. Forecast', 'Delta'],
      rows: (i) => [MONTHS[i], fmtDollar(cumul.actual[i]), fmtDollar(cumul.forecast[i]), fmtDollar(cumul.delta[i])],
      totalLabel: 'Final',
      totals: () => [fmtDollar(cumul.actual[last]), fmtDollar(cumul.forecast[last]), fmtDollar(cumul.delta[last])]
    },
    mmbtu: {
      headers: ['Month', 'Total MMBTU'],
      rows: (i) => [MONTHS[i], fmtNum(energyUse.totalActual[i])],
      totalLabel: 'YTD Total',
      totals: () => [fmtNum(totalMMBTU)]
    },
    elecCost: {
      headers: ['Month', 'Electric Cost', 'Elec MMBTU'],
      rows: (i) => [MONTHS[i], fmtDollar(fy26.elecActual[i]), fmtNum(energyUse.elecActual[i])],
      totalLabel: 'YTD Total',
      totals: () => [fmtDollar(totalElec), fmtNum(totalElecMMBTU)]
    },
    gasCost: {
      headers: ['Month', 'Gas Cost', 'Gas MMBTU', 'Kintec', 'Avista'],
      rows: (i) => [MONTHS[i], fmtDollar(fy26.gasActual[i]), fmtNum(energyUse.gasActual[i]), fmtDollar(fy26.kintecFcast[i]), fmtDollar(fy26.avistaFcast[i])],
      totalLabel: 'YTD Total',
      totals: () => [fmtDollar(totalGas), fmtNum(totalGasMMBTU), fmtDollar(sum(fy26.kintecFcast)), fmtDollar(sum(fy26.avistaFcast))]
    },
    elecRate: {
      headers: ['Month', 'Elec $', 'kWh', '$/kWh'],
      rows: (i) => {
        return [MONTHS[i], fmtDollar(fy26.elecActual[i]), fmtNum(energyUse.kwhActual[i]), fmtRateKwh(energyUse.kwhRate[i])];
      },
      totalLabel: 'Avg / Total',
      totals: () => {
        const tkwh = sum(energyUse.kwhActual);
        return [fmtDollar(totalElec), fmtNum(tkwh), fmtRateKwh(tkwh > 0 ? totalElec/tkwh : 0)];
      }
    },
    gasRate: {
      headers: ['Month', 'Gas $', 'MMBTU', '$/MMBTU'],
      rows: (i) => {
        const m = energyUse.gasActual[i], c = fy26.gasActual[i];
        return [MONTHS[i], fmtDollar(c), fmtNum(m), fmtRate(m > 0 ? c/m : 0)];
      },
      totalLabel: 'Avg / Total',
      totals: () => [fmtDollar(totalGas), fmtNum(totalGasMMBTU), fmtRate(gasRateAct)]
    }
  };

  function buildKpiMiniTable(config) {
    let html = '<table class="kpi-mini-table"><thead><tr>';
    config.headers.forEach(h => { html += '<th>' + h + '</th>'; });
    html += '</tr></thead><tbody>';
    for (let i = 0; i < 12; i++) {
      const cells = config.rows(i);
      html += '<tr>';
      cells.forEach(c => { html += '<td>' + c + '</td>'; });
      html += '</tr>';
    }
    html += '<tr><td>' + config.totalLabel + '</td>';
    config.totals().forEach(t => { html += '<td>' + t + '</td>'; });
    html += '</tr></tbody></table>';
    return html;
  }

  document.querySelectorAll('.kpi-card[data-kpi]').forEach(card => {
    const key = card.dataset.kpi;
    const config = kpiExpandConfig[key];
    if (!config) return;
    const expandDiv = card.querySelector('.kpi-expand');
    expandDiv.innerHTML = buildKpiMiniTable(config);
    card.addEventListener('click', function(e) {
      e.preventDefault();
      this.classList.toggle('expanded');
    });
  });

  // --- Dashboard Charts ---
  new Chart(document.getElementById('chartMonthly'), {
    type:'bar', data:{ labels:MONTHS, datasets:[
      {label:'Actual',data:fy26.totalActual,backgroundColor:C.primary,borderRadius:3},
      {label:'Forecast',data:fy26.totalFcast,backgroundColor:C.blueLight,borderColor:C.blue,borderWidth:1.5,borderRadius:3}
    ]}, options:{responsive:true,maintainAspectRatio:false,
      plugins:{tooltip:{callbacks:{label:ctx=>ctx.dataset.label+': '+fmtDollar(ctx.raw)}}},
      scales:{y:{ticks:{callback:v=>'$'+(v/1e6).toFixed(1)+'M'}}}}
  });

  new Chart(document.getElementById('chartBreakdown'), {
    type:'bar', data:{ labels:MONTHS, datasets:[
      {label:'Electric (Actual)',data:fy26.elecActual,backgroundColor:C.primary,stack:'actual',borderRadius:2},
      {label:'Gas (Actual)',data:fy26.gasActual,backgroundColor:C.accent,stack:'actual',borderRadius:2},
      {label:'Electric (Forecast)',data:fy26.elecFcast,backgroundColor:C.blueLight,borderColor:C.blue,borderWidth:1,stack:'forecast',borderRadius:2},
      {label:'Gas (Forecast)',data:fy26.gasFcast,backgroundColor:'rgba(198,146,20,0.2)',borderColor:C.accent,borderWidth:1,stack:'forecast',borderRadius:2}
    ]}, options:{responsive:true,maintainAspectRatio:false,
      plugins:{tooltip:{callbacks:{label:ctx=>ctx.dataset.label+': '+fmtDollar(ctx.raw)}}},
      scales:{x:{stacked:true},y:{stacked:true,ticks:{callback:v=>'$'+(v/1e6).toFixed(1)+'M'}}}}
  });

  new Chart(document.getElementById('chartMMBTU'), {
    type:'bar', data:{ labels:MONTHS, datasets:[
      {label:'Electric MMBTU',data:energyUse.elecActual,backgroundColor:C.primary,stack:'s1',borderRadius:2},
      {label:'Gas MMBTU',data:energyUse.gasActual,backgroundColor:C.accent,stack:'s1',borderRadius:2}
    ]}, options:{responsive:true,maintainAspectRatio:false,
      plugins:{tooltip:{callbacks:{label:ctx=>ctx.dataset.label+': '+fmtNum(ctx.raw)}}},
      scales:{x:{stacked:true},y:{stacked:true,ticks:{callback:v=>fmtNum(v)}}}}
  });

  const pieElec = sum(fy26.elecActual), pieKintec = sum(fy26.kintecFcast), pieAvista = sum(fy26.avistaFcast);
  const pieTotal = pieElec + pieKintec + pieAvista;
  new Chart(document.getElementById('chartPie'), {
    type:'doughnut', data:{
      labels:['Electric (Actual)','Gas - Kintec','Gas - Avista'],
      datasets:[{data:[pieElec,pieKintec,pieAvista],backgroundColor:[C.primary,C.accent,C.orange],borderWidth:2}]
    }, options:{responsive:true,maintainAspectRatio:false,
      plugins:{tooltip:{callbacks:{label:ctx=>ctx.label+': '+fmtDollarM(ctx.raw)+' ('+(ctx.raw/pieTotal*100).toFixed(1)+'%)'}},legend:{position:'bottom'}}}
  });

  // --- Monthly Detail Table ---
  const tb1 = document.querySelector('#tableMonthly tbody');
  for(let i=0;i<12;i++){const tr=document.createElement('tr');
    tr.innerHTML=`<td>${MONTH_FULL[i]}</td><td>${fmtDollar(fy26.totalActual[i])}</td><td>${fmtDollar(fy26.elecActual[i])}</td><td>${fmtDollar(fy26.gasActual[i])}</td><td class="forecast">${fmtDollar(fy26.totalFcast[i])}</td><td class="forecast">${fmtDollar(fy26.elecFcast[i])}</td><td class="forecast">${fmtDollar(fy26.gasFcast[i])}</td><td class="forecast">${fmtDollar(fy26.kintecFcast[i])}</td><td class="forecast">${fmtDollar(fy26.avistaFcast[i])}</td><td>${fy26.hedge}%</td>`;
    tb1.appendChild(tr);}
  const tr1=document.createElement('tr');tr1.className='total-row';
  tr1.innerHTML=`<td>YTD TOTAL</td><td>${fmtDollar(totalAct)}</td><td>${fmtDollar(totalElec)}</td><td>${fmtDollar(totalGas)}</td><td class="forecast">${fmtDollar(totalFcast)}</td><td class="forecast">${fmtDollar(sum(fy26.elecFcast))}</td><td class="forecast">${fmtDollar(sum(fy26.gasFcast))}</td><td class="forecast">${fmtDollar(sum(fy26.kintecFcast))}</td><td class="forecast">${fmtDollar(sum(fy26.avistaFcast))}</td><td>${fy26.hedge}%</td>`;
  tb1.appendChild(tr1);

  // --- Gas FY25 Table ---
  const mfy25=['July 2024','August 2024','September 2024','October 2024','November 2024','December 2024','January 2025','February 2025','March 2025','April 2025','May 2025','June 2025'];
  const tb2=document.querySelector('#tableGas25 tbody');
  for(let i=0;i<12;i++){const tr=document.createElement('tr');
    tr.innerHTML=`<td>${mfy25[i]}</td><td>${fmtDollar(fy25gas.cost[i])}</td><td>${fmtNum(fy25gas.mmbtu[i])}</td><td>${fmtRate(fy25gas.perUnit[i])}</td><td>${fmtDollar(fy25gas.kintec[i])}</td><td>${fmtDollar(fy25gas.avista[i])}</td>`;
    tb2.appendChild(tr);}
  const tr2=document.createElement('tr');tr2.className='total-row';
  tr2.innerHTML=`<td>YTD TOTAL</td><td>${fmtDollar(sum(fy25gas.cost))}</td><td>${fmtNum(sum(fy25gas.mmbtu))}</td><td>${fmtRate(sum(fy25gas.cost)/sum(fy25gas.mmbtu))}</td><td>${fmtDollar(sum(fy25gas.kintec))}</td><td>${fmtDollar(sum(fy25gas.avista))}</td>`;
  tb2.appendChild(tr2);

  // --- Gas FY25 Chart ---
  new Chart(document.getElementById('chartGas25'),{type:'bar',data:{labels:MONTHS,datasets:[
    {label:'Gas Cost ($)',data:fy25gas.cost,backgroundColor:C.accent,borderRadius:3,yAxisID:'y'},
    {label:'Gas MMBTU',data:fy25gas.mmbtu,type:'line',borderColor:C.primary,backgroundColor:C.primaryLight,pointRadius:4,tension:0.3,yAxisID:'y1'}
  ]},options:{responsive:true,maintainAspectRatio:false,scales:{
    y:{position:'left',ticks:{callback:v=>'$'+(v/1e3).toFixed(0)+'K'}},
    y1:{position:'right',grid:{drawOnChartArea:false},ticks:{callback:v=>fmtNum(v)}}}}});

  // --- Kintec Chart ---
  new Chart(document.getElementById('chartKintec'),{type:'bar',data:{labels:kintec.months,datasets:[
    {label:'Dekatherms',data:kintec.dths,backgroundColor:C.accent,borderRadius:2,yAxisID:'y'},
    {label:'Cost ($)',data:kintec.cost,type:'line',borderColor:C.primary,pointRadius:2,tension:0.3,yAxisID:'y1'}
  ]},options:{responsive:true,maintainAspectRatio:false,scales:{
    x:{ticks:{maxRotation:45,font:{size:10}}},
    y:{position:'left',ticks:{callback:v=>fmtNum(v)}},
    y1:{position:'right',grid:{drawOnChartArea:false},ticks:{callback:v=>'$'+(v/1e3).toFixed(0)+'K'}}}}});

  // --- Energy Use Table ---
  const tb3=document.querySelector('#tableEnergyUse tbody');
  for(let i=0;i<12;i++){const tr=document.createElement('tr');
    tr.innerHTML=`<td>${MONTH_FULL[i]}</td><td>${fmtNum(energyUse.totalActual[i])}</td><td>${fmtNum(energyUse.elecActual[i])}</td><td>${fmtNum(energyUse.gasActual[i])}</td><td class="forecast">${fmtNum(energyUse.totalFcast[i])}</td><td>${fmtNum(energyUse.kwhActual[i])}</td><td>${fmtRateKwh(energyUse.kwhRate[i])}</td>`;
    tb3.appendChild(tr);}
  const tr3=document.createElement('tr');tr3.className='total-row';
  const avgKwh=sum(energyUse.kwhActual)>0?sum(fy26.elecActual)/sum(energyUse.kwhActual):0;
  tr3.innerHTML=`<td>YTD TOTAL</td><td>${fmtNum(sum(energyUse.totalActual))}</td><td>${fmtNum(sum(energyUse.elecActual))}</td><td>${fmtNum(sum(energyUse.gasActual))}</td><td class="forecast">${fmtNum(sum(energyUse.totalFcast))}</td><td>${fmtNum(sum(energyUse.kwhActual))}</td><td>${fmtRateKwh(avgKwh)}</td>`;
  tb3.appendChild(tr3);

  // --- Energy Use Chart ---
  new Chart(document.getElementById('chartEnergyUse'),{type:'bar',data:{labels:MONTHS,datasets:[
    {label:'Electric MMBTU',data:energyUse.elecActual,backgroundColor:C.primary,stack:'s1',borderRadius:2},
    {label:'Gas MMBTU',data:energyUse.gasActual,backgroundColor:C.accent,stack:'s1',borderRadius:2},
    {label:'Total Forecast',data:energyUse.totalFcast,type:'line',borderColor:C.blue,borderDash:[5,5],pointRadius:4,tension:0.3,fill:false}
  ]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true},y:{stacked:true,ticks:{callback:v=>fmtNum(v)}}}}});

  // --- YoY Table (2 years: FY25 vs FY26) ---
  const tb4=document.querySelector('#tableYoY tbody');
  for(let i=0;i<12;i++){const tr=document.createElement('tr');
    tr.innerHTML=`<td>${MONTHS[i]}</td><td>${fmtNum(yoy.fy25total[i])}</td><td>${fmtNum(yoy.fy25elec[i])}</td><td>${fmtNum(yoy.fy25gas[i])}</td><td>${fmtNum(yoy.fy26total[i])}</td><td>${fmtNum(yoy.fy26elec[i])}</td><td>${fmtNum(yoy.fy26gas[i])}</td>`;
    tb4.appendChild(tr);}
  const tr4=document.createElement('tr');tr4.className='total-row';
  tr4.innerHTML=`<td>FY TOTAL</td><td>${fmtNum(sum(yoy.fy25total))}</td><td>${fmtNum(sum(yoy.fy25elec))}</td><td>${fmtNum(sum(yoy.fy25gas))}</td><td>${fmtNum(sum(yoy.fy26total))}</td><td>${fmtNum(sum(yoy.fy26elec))}</td><td>${fmtNum(sum(yoy.fy26gas))}</td>`;
  tb4.appendChild(tr4);

  // YoY notes
  const yoyPctTotal=((sum(yoy.fy26total)-sum(yoy.fy25total))/sum(yoy.fy25total)*100).toFixed(1);
  const yoyPctElec=sum(yoy.fy25elec)>0?((sum(yoy.fy26elec)-sum(yoy.fy25elec))/sum(yoy.fy25elec)*100).toFixed(1):'N/A';
  const yoyPctGas=((sum(yoy.fy26gas)-sum(yoy.fy25gas))/sum(yoy.fy25gas)*100).toFixed(1);
  document.getElementById('yoyNotes').innerHTML=`<li>FY26 vs FY25: ${yoyPctTotal}% total, ${yoyPctElec}% electric, ${yoyPctGas}% gas</li>`;

  // --- YoY Chart (2 years) ---
  new Chart(document.getElementById('chartYoY'),{type:'line',data:{labels:MONTHS,datasets:[
    {label:'FY2025',data:yoy.fy25total,borderColor:C.blue,backgroundColor:C.blueLight,pointRadius:3,tension:0.3},
    {label:'FY2026',data:yoy.fy26total,borderColor:C.primary,backgroundColor:C.primaryLight,pointRadius:4,borderWidth:2.5,tension:0.3}
  ]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{callback:v=>fmtNum(v)}}},
    plugins:{tooltip:{callbacks:{label:ctx=>ctx.dataset.label+': '+fmtNum(ctx.raw)+' MMBTU'}}}}});

  // --- Cumulative Table ---
  const mShort=['Jul 2025','Aug 2025','Sep 2025','Oct 2025','Nov 2025','Dec 2025','Jan 2026','Feb 2026','Mar 2026','Apr 2026','May 2026','Jun 2026'];
  // 'last' already declared above for delta KPI
  const tb5=document.querySelector('#tableCumulative tbody');
  for(let i=0;i<12;i++){const tr=document.createElement('tr');
    const dCls = cumul.delta[i]>0?'negative':'positive';
    tr.innerHTML=`<td>${mShort[i]}</td><td>${fmtDollar(cumul.actual[i])}</td><td class="forecast">${fmtDollar(cumul.forecast[i])}</td><td class="${dCls}">${fmtDollar(cumul.delta[i])}</td><td class="${dCls}">${fmtPct(cumul.deltaPct[i])}</td><td>${fmtNum(cumul.mmbtuAct[i])}</td><td class="forecast">${fmtNum(cumul.mmbtuFcast[i])}</td><td>${fmtNum(cumul.mmbtuDelta[i])}</td><td>${fmtPct(cumul.mmbtuDeltaPct[i])}</td>`;
    tb5.appendChild(tr);}
  const tr5=document.createElement('tr');tr5.className='total-row';
  tr5.innerHTML=`<td>FY TOTAL</td><td>${fmtDollar(cumul.actual[last])}</td><td class="forecast">${fmtDollar(cumul.forecast[last])}</td><td class="negative">${fmtDollar(cumul.delta[last])}</td><td class="negative">${fmtPct(cumul.deltaPct[last])}</td><td>${fmtNum(cumul.mmbtuAct[last])}</td><td class="forecast">${fmtNum(cumul.mmbtuFcast[last])}</td><td>${fmtNum(cumul.mmbtuDelta[last])}</td><td>${fmtPct(cumul.mmbtuDeltaPct[last])}</td>`;
  tb5.appendChild(tr5);

  // --- Cumulative Chart ---
  new Chart(document.getElementById('chartCumulative'),{type:'line',data:{labels:MONTHS,datasets:[
    {label:'Actual (Cumulative)',data:cumul.actual,borderColor:C.primary,backgroundColor:C.primaryLight,fill:true,pointRadius:4,tension:0.3,borderWidth:2.5},
    {label:'Forecast (Cumulative)',data:cumul.forecast,borderColor:C.blue,backgroundColor:C.blueLight,fill:true,pointRadius:4,borderDash:[6,3],tension:0.3}
  ]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{callback:v=>'$'+(v/1e6).toFixed(0)+'M'}}},
    plugins:{tooltip:{callbacks:{label:ctx=>ctx.dataset.label+': '+fmtDollarM(ctx.raw)}}}}});

  // --- Variance Table ---
  if(variance){
    const tb7=document.querySelector('#tableVariance tbody');
    for(let i=0;i<12;i++){const tr=document.createElement('tr');
      const costCls=variance.costDelta[i]>0?'negative':'positive';
      tr.innerHTML=`<td>${MONTHS[i]}</td><td>${fmtDollar(variance.fy25cost[i])}</td><td>${fmtDollar(variance.fy26cost[i])}</td><td class="${costCls}">${fmtDollar(variance.costDelta[i])}</td><td>${fmtNum(variance.fy25mmbtu[i])}</td><td>${fmtNum(variance.fy26mmbtu[i])}</td><td>${fmtNum(variance.mmbtuDelta[i])}</td><td>${fmtPct(variance.mmbtuDeltaPct[i])}</td><td>${fmtNum(variance.fy25hdd[i])}</td><td>${fmtNum(variance.fy26hdd[i])}</td><td>${variance.hddDeltaPct[i]}%</td><td>${fmtNum(variance.normalHdd[i])}</td>`;
      tb7.appendChild(tr);}
    const tr7=document.createElement('tr');tr7.className='total-row';
    tr7.innerHTML=`<td>FY Total</td><td>${fmtDollar(sum(variance.fy25cost))}</td><td>${fmtDollar(sum(variance.fy26cost))}</td><td class="${sum(variance.costDelta)>0?'negative':'positive'}">${fmtDollar(sum(variance.costDelta))}</td><td>${fmtNum(sum(variance.fy25mmbtu))}</td><td>${fmtNum(sum(variance.fy26mmbtu))}</td><td>${fmtNum(sum(variance.mmbtuDelta))}</td><td>${fmtPct(sum(variance.mmbtuDelta)/sum(variance.fy25mmbtu)*100)}</td><td>${fmtNum(sum(variance.fy25hdd))}</td><td>${fmtNum(sum(variance.fy26hdd))}</td><td>--</td><td>${fmtNum(sum(variance.normalHdd))}</td>`;
    tb7.appendChild(tr7);

    // Variance charts
    new Chart(document.getElementById('chartVarianceCost'),{type:'bar',data:{labels:MONTHS,datasets:[
      {label:'FY2025',data:variance.fy25cost,backgroundColor:C.blueLight,borderColor:C.blue,borderWidth:1,borderRadius:3},
      {label:'FY2026',data:variance.fy26cost,backgroundColor:C.primary,borderRadius:3}
    ]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{callback:v=>'$'+(v/1e6).toFixed(1)+'M'}}}}});

    new Chart(document.getElementById('chartVarianceMmbtu'),{type:'bar',data:{labels:MONTHS,datasets:[
      {label:'FY2025 MMBTU',data:variance.fy25mmbtu,backgroundColor:C.blueLight,borderColor:C.blue,borderWidth:1,borderRadius:3},
      {label:'FY2026 MMBTU',data:variance.fy26mmbtu,backgroundColor:C.primary,borderRadius:3},
      {label:'30-Yr Normal HDD',data:variance.normalHdd,type:'line',borderColor:C.gray,borderDash:[5,5],pointRadius:3,tension:0.3,fill:false}
    ]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{callback:v=>fmtNum(v)}}}}});
  }

  // --- HDD Table ---
  const tb6=document.querySelector('#tableHDD tbody');
  for(let i=0;i<12;i++){const tr=document.createElement('tr');
    tr.innerHTML=`<td>${MONTHS[i]}</td><td>${fmtNum(hdd.fy25[i])}</td><td>${fmtNum(hdd.fy26[i])}</td><td>${fmtNum(hdd.normal[i])}</td>`;
    tb6.appendChild(tr);}
  const tr6=document.createElement('tr');tr6.className='total-row';
  tr6.innerHTML=`<td>FY Total</td><td>${fmtNum(sum(hdd.fy25))}</td><td>${fmtNum(sum(hdd.fy26))}</td><td>${fmtNum(sum(hdd.normal))}</td>`;
  tb6.appendChild(tr6);
  document.getElementById('hddTotals').textContent='FY2025 Total: '+fmtNum(sum(hdd.fy25))+' HDD | FY2026 Total: '+fmtNum(sum(hdd.fy26))+' HDD | 30-Yr Normal: '+fmtNum(sum(hdd.normal))+' HDD';

  // --- HDD Chart ---
  new Chart(document.getElementById('chartHDD'),{type:'bar',data:{labels:MONTHS,datasets:[
    {label:'FY2025 HDD',data:hdd.fy25,backgroundColor:C.blueLight,borderColor:C.blue,borderWidth:1,borderRadius:3},
    {label:'FY2026 HDD',data:hdd.fy26,backgroundColor:C.primary,borderRadius:3},
    {label:'30-Yr Normal',data:hdd.normal,type:'line',borderColor:C.gray,borderDash:[5,5],pointRadius:3,tension:0.3,fill:false}
  ]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{callback:v=>fmtNum(v)}}}}});
}

// ==================== FETCH & GO ====================
fetch('data.json')
  .then(r => {
    if(!r.ok) throw new Error('data.json not found. Click the "Export Data" button in your Excel workbook first, then upload data.json to this folder.');
    return r.json();
  })
  .then(data => {
    document.getElementById('loading').style.display = 'none';
    initDashboard(data);
  })
  .catch(err => {
    document.getElementById('loading').style.display = 'none';
    const el = document.getElementById('error');
    el.style.display = 'flex';
    document.getElementById('errorMsg').textContent = err.message;
  });
</script>
</body>
</html>
